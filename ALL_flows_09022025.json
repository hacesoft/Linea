[{"id":"6cf0017697520c44","type":"tab","label":"chlazeni FVE","disabled":false,"info":"\r\n","env":[]},{"id":"7996ac9a8ad2ee7a","type":"tab","label":"Battery Control","disabled":false,"info":"//*****************************************************************************\r\n//\r\n// File Name        : Battery Control Node\r\n// Title            : Battery Control Nodes\r\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\r\n// Created          : 21-06-2024, 08:00\r\n// Revised          : 29-06-2024, 21:39\r\n// Version          : 1.00\r\n// Target Platform  : Node-RED\r\n//\r\n// This code is distributed under the GNU Public License\r\n// Vsechny informace jsou zahrnuty pod GPL licenci, pokud není explicitne uveden jiný typ licence.\r\n// Pouzivání techto stránek a produktů ke komerčním �celum lze jen se souhlasem autora.\r\n// Vsechna práva vyhrazena (c) 1997 - 2024 hacesoft.\r\n//\r\n//*****************************************************************************","env":[]},{"id":"b986d298710d9da5","type":"tab","label":"SPOT Excess Control","disabled":false,"info":"### Auto control according to SPOT prices\r\n\r\n - Tick each 15 minutes (+ 5 sec. delay to be sure to catch the current hour frame at SPOT prices provider).\r\n - Load spot prices from DeltaGreen.\r\n - Evaluate current price according to the treshold. The treshold is stored in flow.spotTresholdPrice (1.05 CZK/kWh by default).\r\n - Turn On/Off the Venus Feeding excess DC PV into grid according the treshold.\r\n\r\n### Manual control \r\n- Just turn On/Off the Venus Feeding excess DC PV into grid according the manual settings.\r\n\r\n### Prerequisites\r\nNode-RED custom libraries:\r\n\r\n. Node-red dashboard\r\n\tnode-red-dashboard\r\n\thttps://flows.nodered.org/node/node-red-dashboard\r\n\t\r\n. cronplus\r\n\tnode-red-contrib-cron-plus\r\n\thttps://flows.nodered.org/node/node-red-contrib-cron-plus\r\n\t\r\n. config\r\n\tnode-red-contrib-config\r\n\thttps://flows.nodered.org/node/node-red-contrib-config\r\n\r\n#### Other used nodes:\r\n. Modern Dark Theme for node-red-dashboard\r\n\thttps://flows.nodered.org/flow/eb9a4d44f72b0755aa3e14055fb3eacb\r\n\r\n-- by Petr Krivanek","env":[]},{"id":"dc14bd796219d9ad","type":"tab","label":"GUI + GLOBAL FUNCTION","disabled":false,"info":"//*****************************************************************************\r\n//\r\n// File Name        : 'GUI_Global_UTIL'\r\n// Title            : GUI a definovani globalní funkce\r\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\r\n// Created          : 14-07-2024, 11:00\r\n// Revised          : 17-07-2024, 20:33\r\n// Version          : 1.11\r\n// Target Platform  : Node-RED\r\n//\r\n// This code is distributed under the GNU Public License\r\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\r\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\r\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\r\n//\r\n//*****************************************************************************\r\n//","env":[]},{"id":"bb58b085db8ab888","type":"tab","label":"Config","disabled":false,"info":"","env":[]},{"id":"7fbf9eb64b6d1607","type":"tab","label":"NodeMCU","disabled":false,"info":"","env":[]},{"id":"f5e086d890235524","type":"group","z":"b986d298710d9da5","name":"GUI","style":{"stroke":"#0070c0","label":true},"nodes":["31e526f3dcbd2b2a","7a2eeb482b9cbe62","c9ce59a6ae17f721","60292bcfa0867a50","5039e3fad1c8aabc","f2fb9e0e6990da1e","50f051b4bbe07cc5","01e3c862dbe56043"],"x":104,"y":239,"w":1062,"h":82},{"id":"5ece208427d51524","type":"group","z":"b986d298710d9da5","name":"Victron Venus settings status monitor","style":{"label":true},"nodes":["e30fb63eea32171a","d4ef1b7263f1f0c7","e206cc31a3e05c0f","d0c4a942cea93b17","bf176b832b69029b","16d87f0ccdd6c314"],"x":114,"y":39,"w":772,"h":162},{"id":"b42fb09a89761abc","type":"group","z":"b986d298710d9da5","name":"Load SPOT price, evaluate the treshold price & set feed DC excess on/off","style":{"label":true},"nodes":["2d331a50b0d61710","d153678c838836aa","16f96aa183feec96","b5253809c21b8037","76540fe7bea2088e","b70c9a8e3f33594d","af6a1b22fa66ca61","64105c5a3b20bb19","ad3b7d4443f6b79e","13ea6ca0b9ca3e03","94da292e68864339","e418a527df65e767","75ac1831bb5e13e0","a7a9fcb365020e85","76a8d8c71ef25fc8","5ce3d905b124c09d","f96e7d2a877f8124","a434319c79a45492","117c2520b271ab18","9679043aa5a0ea06","f7b462f22622136e","5ea652330077301c","fb235672515d3eae","05f5f0a1cc1ee777","5fa9a82ebed3552f","96deeb8958d5a03f","f4e1cf3a0ee52e37","38b7ec7ee777b4a9","e20437d8bba5aa5e","b759b4c02def5194","cf6ec63e9e803b5c","b4b6f64ea3924b4e","473c56a48351ed18","e2c55a383129cb1d","e3cb434152e4befa"],"x":104,"y":371.5,"w":1662,"h":849.5},{"id":"5026d073f890b271","type":"group","z":"bb58b085db8ab888","name":"VRM API","style":{"label":true},"nodes":["feb036c14b9b830a","955591a2c9c913fc","86e48532687d8393","85807d5d954a34a7","657908f3ee36f1b8","c33d8542af6c698d","96a81419238cb2c8","b514060941dc6ba3","905af2b5c03463e9","036ec001ad764181","4bb1d44c23f30318","a9335b5b74384bdf","149c533d1f4ff12f","b98d895b6e39e81d","abca044619136220","790fdb01929ace0d","eecc6e8206f07107","12043b620f5cff01","f723569d152ce502","2e019699821899dc","6287a617c8ea9f14","411b4b59850d6625","850ea0a974cb2597"],"x":224,"y":1539,"w":1322,"h":342},{"id":"e1e5f4d74c9959c1","type":"group","z":"bb58b085db8ab888","name":"Kontrolni funkce","style":{"stroke":"#0070c0","label":true},"nodes":["2ccb43e9550a841c","155e6145814328c9","5c44997566df0d35","343bae18b4127654","34c4333353119237","af86bc1b94e005d6","bf546b61f5a07c75","b8ced369e30c31c1"],"x":1074,"y":1079,"w":701,"h":282},{"id":"c8820631d746febb","type":"group","z":"dc14bd796219d9ad","name":"VRM","style":{"label":true},"nodes":["af54f00448a605d5","fed095ddcd77b1a2","06d228dd9e29523d","99819cff5b984fd1","b2bd7ff600556974","5e6360379d323364","5db0fcb2d3432a58","a8518f89fb213aa4","9158e8cb04621410","2cf2059778055ad7","1fb6f6cc27313f0e","6c03e0e8b1e92ff7","21f1e3012ce7e0ca","a2ae83b1d097b508","function_node_id","30fb0930ec720c71","f2475111cdae5c1a","4cd97b94f00e3dab"],"x":1064,"y":59,"w":582,"h":362},{"id":"e5111d27ef0bf43d","type":"group","z":"dc14bd796219d9ad","name":"GLOBAL SETING AND CLOCKs","style":{"label":true},"nodes":["909f0fa3f4147ede","5dbba70ddd44d673","8f10bed02dbe3b9b","eb2aebb66e80d341","9243e651dea96d4c","06864177b7791422","02a502c924056fb6","784b0c28936b3da9","26e69bb073bbcc02","b65295cb8678d439","10d11499af100019","a4c1923cc431fc76","cb7a87ea7ca8d6c1","823d13d79f9bfc83","ea8e613bd96afead","edf36748480e70ff","1a317d0976a1ddb3","50e7df9e8b3bc878"],"x":274,"y":59,"w":732,"h":362},{"id":"1a9d21242a01ebdd","type":"group","z":"dc14bd796219d9ad","name":"LIVE DATA","style":{"label":true},"nodes":["7f7c294712a3580b","03042c98ed1f8bd2","47bee02fd17241cc","3012d4563c8a76e7","f901c314b54b444a","ecd21f6cd73a0f64","80350a39c69e782f","87d5cf8d58679897","881b340c53404d98","ba02ecffa7282388","b7f5bd5a3eb90166","33af33642fa0d5a2","e74ec256923af82c","fe1d5acc45c21435","be54171f553bba4a","e7abeb99abbcadac","440fdfb71d3c952e","f85e8528950ff714","9bdbf5d33911e135","3c5fa477299720b4","7b225228052bc2f0","c52e4f69764e8ab7","bb4bdfb7933e157a","ad8e6c051ba1f7d6","c30267afbab42020","9a1f199e2e88d24c","8f8da0208c0b2888"],"x":274,"y":439,"w":1294,"h":682},{"id":"092c429e967f8893","type":"group","z":"dc14bd796219d9ad","name":"SET LOGIK BATTERY","style":{"stroke":"#0070c0","label":true},"nodes":["79aa433d75f5c77d","a5313ad38ca271ce","4fd0e3b86bad2c09","871a86486ee9f688","fc94735e37de1038","50be985d5cdf539d","9fc9c0af9d89595f","befe99cc74adfbc1","b3b1aee73fc70ea9","382fa935783c989a","9aa2e20d1b0d31a8","1bc725c7c8c31f6f","4a750209e1c034d4","9f24640183c226de","6d8f74ee9bbd502e","d3a06abf63a62a6a","949730c7a68bec19","61f4fd4c31877d07","278437d717d71b33","27daf111ebee34ee","4a871194f875172f","6358518a8acac836","e82772f3cfe17836","e4a510eeb5c4f70f","145474f6548c4ba6","010f32f4b84afaf6","7d82878c9a3e9cbf","1d81eac81eb2a6c6","0973f4e5a1eb8967","4ebbc6fd923e2f36","50637404bfdd22fe","5af06f5974ff0a1f","32f717d7a39e56b8","b8d434eb9ca5e1f2","4da4a259c9bf266f"],"x":264,"y":1459,"w":1742,"h":322},{"id":"48de5eb1ca74eafc","type":"group","z":"dc14bd796219d9ad","name":"GET VRM API","style":{"label":true},"nodes":["abaebf4fb42da20d","79fee107e7a6a7ff","165e92efd553fe94","b1d7374a4e4bdfa6","17b9f487a18352cd","8a38865c67bf35d9","555d1b0cb34f6b9e","42ee3f3b8ea0ef0c","ddf420fd18dce565","e9fd3c9095c3807f","97f2b4c61f843634","56bd165152f32606","ba5c1d360d2b53c9","b667f0259436c1e3","3e1fc476c6a43e8a","ba5991c8956711e3","ebf55f4e991cb354","065fe908fea8bd39","3a87775a04df95f8","0230cbe8d5c6e7b5"],"x":274,"y":1139,"w":1392,"h":282},{"id":"1b84d1ab8eb2c216","type":"group","z":"dc14bd796219d9ad","name":"GRAFs","style":{"label":true},"nodes":["2823d9b0dfcce47f","9ddbec260baed1ae","95b1ec484d912acd","e125373b24fcca21","2b6b0572bca8c587","ceead5239e9d9903","aa384c4538409199","a05dd8ea01366a2b"],"x":1614,"y":459,"w":712,"h":222},{"id":"abb49bc25d54f862","type":"group","z":"bb58b085db8ab888","name":"CONFIG :: TCP","style":{"label":true},"nodes":["c021cd075c0b774f","49450380783c21eb","39297b4370e42165","29f7bebe6a8111cd","d28a120550fc6aa3","cb3dfeebaf14ef8b","4106733b7e446a9d","50e7bd5cb040a95c","f0fd7d62fe70c454","aa78d033ee089055"],"x":224,"y":1359,"w":802,"h":162},{"id":"ad8071fbcd6cb151","type":"group","z":"bb58b085db8ab888","name":"CONFIG :: CONFIG","style":{"label":true},"nodes":["input_fanIPAddress","8cb9a604d688ffb0","302399a6ed4ffcb6","f5835241bb34233a","14bd47d7f9189b90","c4ce6c9549470d54","a0b115480ce7f9ae","b2bb17aa01892c8f","8c6bcdb6cd2bd669","4c5403c83d2bb214","eab20b4ea8a392de","bb6b6a460d918428","7f3beb8cf053976c","c23b2f02aae4e8ae","1cbc56901615282a","c2e166a921e51762","b0896b5d1ee51e9e","3c9ae15a0c417fb7","61266490e37a829f","d68ec5ae7de942a5"],"x":224,"y":1059,"w":842,"h":282},{"id":"6167eebedbeaff5b","type":"group","z":"bb58b085db8ab888","name":"FILE :: SAVE and DELETE","style":{"label":true},"nodes":["file_out","22452155843f3233","4d89bf95b09676fe","66a7a43e7b5c3227","0f872f0d08025491","e5f6d86f19cde035","b6c3be5632678b31","256e26fc9a8d6490","3bdc81473f9625ee","8c03e12124f30d0a","8abb33b00bbcb30a","2c501c50c5542579","e8dbeffc5ca58026","f2fc65315922fa55","49890a31476e6591","89dcc8376af722f1","d6596fea5b0154cc","c78ec1d681859256","e1b53bada083922d","c5a5627bf4f1e06b","0f1187363309607e"],"x":254,"y":779,"w":1252,"h":282},{"id":"8384064784376389","type":"group","z":"bb58b085db8ab888","name":"TCP :: CONECT","style":{"label":true},"nodes":["426ee71326b9eef2","5a9fcb2da005548e","44aba335bc247794","ef861a6c6e9df48e","69024fcbdecb7e15","6b4ae0211109ae1b","7d6daf3a9f2c1f8b","28578c73ab6a72a6","a9886bf483698733","bdbd0d07dcc46476","8267d7862417bb66","bb702d415d4ba2c8","e1380bfc13acf8b5","8597f6fcce2b0db1","053dc2f13494cc80","292fdb2fff2915d6"],"x":274,"y":59,"w":972,"h":362},{"id":"9d90eeb1c87e776f","type":"group","z":"bb58b085db8ab888","name":"FILE :: LOAD","style":{"label":true},"nodes":["9226ebd8324689b1","dfbe419d88e4f232","794d418cbe9f49b8","4eaeb432c1f16117","e5706dfefece2626","2584e24c1a963979","8594c45aa103bf48","ca542ad4ccd6c23d","65d3135f908c531a","97613c9b3c258e1c","ac7aeb8536edfbd8","949a6897c12465b1","dc4e460bf0a4f8c6","245b64662dda2b2e","f73b91521a6385db","224c7eb93b69749a"],"x":264,"y":439,"w":1442,"h":242},{"id":"c9cab4329b815890","type":"group","z":"bb58b085db8ab888","name":"GET VALID PATCH","style":{"label":true},"nodes":["d4d48c6a2b8c4e2b","ac3eae5f9c2d4c13","d5f4a2e7c2e84c7d","175fc04163da34f2","9d99dd7fb3e2e326","0ff5daca17cd0dc9","156f341261082473","8f742dfc35d9560a","47b286c8e072a418","5a2e12533b60dd9e","88f73868b70e9bca","473abe190b6aed3d","549ea0b46f611279","5e261cfba4264a35","556db86f165ec539","8686a94a64543f66","3e3dcda2ac7f6796"],"x":354,"y":2339,"w":1482,"h":322},{"id":"df21cfea6cf3d683","type":"group","z":"bb58b085db8ab888","name":"LS to debug console","style":{"label":true},"nodes":["d99a1f3b3cc8a1f0","fd3f5d89d2c4d567","d1c7e82e4ad8d9b8","826f2d0d3a5e5c36","ea7d9e08f03d0c4a","1d82ec5f63efcf70"],"x":274,"y":1939,"w":1032,"h":202},{"id":"f3a8a67ff0904e39","type":"ui_tab","name":"🔎 FVE","icon":"","order":1,"disabled":false,"hidden":false},{"id":"6bdf3420903b72e3","type":"ui_group","name":"🧱 Řízení přetoků","tab":"f3a8a67ff0904e39","order":2,"disp":true,"width":"6","collapse":true,"className":""},{"id":"7d718c13f8419912","type":"ui_group","name":"🚴 SPOT","tab":"f3a8a67ff0904e39","order":3,"disp":true,"width":"6","collapse":true,"className":""},{"id":"b1eb05edab318eb0","type":"ui_group","name":"✨ ESS","tab":"f3a8a67ff0904e39","order":4,"disp":true,"width":"6","collapse":true,"className":""},{"id":"eff8c2fb7917b0ab","type":"ui_group","name":"👁️‍🗨️ Real Data","tab":"f3a8a67ff0904e39","order":1,"disp":true,"width":"6","collapse":true,"className":""},{"id":"567d8fae.98148","type":"ui_tab","name":"📊 Realtime Power","icon":"","order":2,"disabled":false,"hidden":false},{"id":"18637dcfe1e79007","type":"ui_group","name":"Předpověd","tab":"567d8fae.98148","order":1,"disp":true,"width":"20","collapse":false,"className":""},{"id":"421891c215fdf211","type":"ui_tab","name":"🎫 Config","icon":"","order":3,"disabled":false,"hidden":false},{"id":"b27def8d204439ed","type":"ui_group","name":"⚙ Config","tab":"421891c215fdf211","order":3,"disp":true,"width":"6","collapse":true,"className":""},{"id":"6c801ec0cc108747","type":"modbus-client","name":"linea","clienttype":"tcp","bufferCommands":true,"stateLogEnabled":false,"queueLogEnabled":false,"failureLogEnabled":false,"tcpHost":"127.0.0.1","tcpPort":"502","tcpType":"DEFAULT","serialPort":"/dev/ttyUSB","serialType":"RTU-BUFFERD","serialBaudrate":"9600","serialDatabits":"8","serialStopbits":"1","serialParity":"none","serialConnectionDelay":"100","serialAsciiResponseStartDelimiter":"0x3A","unit_id":100,"commandDelay":1,"clientTimeout":1000,"reconnectOnTimeout":true,"reconnectTimeout":2000,"parallelUnitIdsAllowed":false,"showErrors":false,"showWarnings":true,"showLogs":true},{"id":"ba1c560b4a2f6b32","type":"ui_group","name":"🕯 TCP","tab":"421891c215fdf211","order":2,"disp":true,"width":"6","collapse":true,"className":""},{"id":"03f0e4ccd6790757","type":"ui_group","name":"📁 File","tab":"421891c215fdf211","order":1,"disp":true,"width":"6","collapse":true,"className":""},{"id":"b5c590ba96324296","type":"ui_group","name":"📌 VRM","tab":"421891c215fdf211","order":4,"disp":true,"width":"6","collapse":false,"className":""},{"id":"ae5a5f33ce6405c9","type":"ui_group","name":"Podmínky","tab":"421891c215fdf211","order":5,"disp":true,"width":"6","collapse":false,"className":""},{"id":"e1c82025acb9edb6","type":"ui_base","theme":{"name":"theme-dark","lightTheme":{"default":"#0094CE","baseColor":"#0094CE","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"darkTheme":{"default":"#097479","baseColor":"#097479","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"customTheme":{"name":"Untitled Theme 1","default":"#4B7930","baseColor":"#4B7930","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"},"themeState":{"base-color":{"default":"#097479","value":"#097479","edited":false},"page-titlebar-backgroundColor":{"value":"#097479","edited":false},"page-backgroundColor":{"value":"#111111","edited":false},"page-sidebar-backgroundColor":{"value":"#333333","edited":false},"group-textColor":{"value":"#0eb8c0","edited":false},"group-borderColor":{"value":"#555555","edited":false},"group-backgroundColor":{"value":"#333333","edited":false},"widget-textColor":{"value":"#eeeeee","edited":false},"widget-backgroundColor":{"value":"#097479","edited":false},"widget-borderColor":{"value":"#333333","edited":false},"base-font":{"value":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"}},"angularTheme":{"primary":"indigo","accents":"blue","warn":"red","background":"grey","palette":"light"}},"site":{"name":"Node-RED Dashboard","hideToolbar":"false","allowSwipe":"false","lockMenu":"false","allowTempTheme":"true","dateFormat":"DD/MM/YYYY","sizes":{"sx":49,"sy":30,"gx":3,"gy":0,"cx":0,"cy":0,"px":0,"py":0}}},{"id":"d23a9eefcf4ad1b1","type":"ui_spacer","z":"dc14bd796219d9ad","name":"spacer","group":"eff8c2fb7917b0ab","order":5,"width":6,"height":1},{"id":"c48452fbc778b7c0","type":"ui_spacer","z":"dc14bd796219d9ad","name":"spacer","group":"eff8c2fb7917b0ab","order":10,"width":6,"height":1},{"id":"9474da53e801b6db","type":"ui_spacer","z":"dc14bd796219d9ad","name":"spacer","group":"eff8c2fb7917b0ab","order":19,"width":6,"height":1},{"id":"ac5fa435d8fa6935","type":"ui_spacer","z":"dc14bd796219d9ad","name":"spacer","group":"7d718c13f8419912","order":3,"width":6,"height":1},{"id":"044172c3214d17af","type":"ui_spacer","z":"dc14bd796219d9ad","name":"spacer","group":"b1eb05edab318eb0","order":4,"width":6,"height":1},{"id":"e65f99cea68732f2","type":"ui_spacer","z":"dc14bd796219d9ad","name":"spacer","group":"b1eb05edab318eb0","order":8,"width":6,"height":1},{"id":"5d832db149d2e5d6","type":"ui_spacer","z":"dc14bd796219d9ad","name":"spacer","group":"b1eb05edab318eb0","order":11,"width":6,"height":1},{"id":"0d7a2a1c67d4bf05","type":"ui_spacer","z":"dc14bd796219d9ad","name":"spacer","group":"b1eb05edab318eb0","order":14,"width":6,"height":1},{"id":"7416fc75df840f30","type":"modbus-client","name":"NodeMCU","clienttype":"tcp","bufferCommands":true,"stateLogEnabled":false,"queueLogEnabled":false,"failureLogEnabled":true,"tcpHost":"192.168.11.4","tcpPort":"503","tcpType":"DEFAULT","serialPort":"/dev/ttyUSB","serialType":"RTU-BUFFERD","serialBaudrate":"9600","serialDatabits":"8","serialStopbits":"1","serialParity":"none","serialConnectionDelay":"100","serialAsciiResponseStartDelimiter":"0x3A","unit_id":1,"commandDelay":1,"clientTimeout":1000,"reconnectOnTimeout":true,"reconnectTimeout":2000,"parallelUnitIdsAllowed":true,"showErrors":false,"showWarnings":true,"showLogs":true},{"id":"963735aa2c2813dd","type":"function","z":"6cf0017697520c44","name":"MPTT","func":"//*****************************************************************************\n//\n// File Name        : 'Chlazeni MPTT trakeru'\n// Title            : Cooling of Trackers in the Rack\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 21-10-2023, 11:00\n// Revised          : 06-07-2024, 10:27\n// Version          : 1.3\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fSendUrl = global.get('fSendUrl');\n\nif (fSendUrl) {\n    const nRelayNumber = 0;\n    const sIpAddress = \"192.168.11.7\";\n    let sTurn = \"off\";  // Výchozí hodnota\n    let nTurn = 0;  // Výchozí hodnota\n    let n_trigger_MPTT = 500; // defaultní hodnota triggeru\n    let _url = \"\";\n\n    //Načtení vstupních dat\n    const _general_stop = msg.payload._general_stop;// general stop\n\n    // Načteni globálních dat\n    const pvPower = global.get(\"pvPower\") || 0; // Hodnota z registru 819 \n\n    if (_general_stop == true){\n        sTurn = \"off\";\n        nTurn = 0;\n    }else{// Zkontroluj, zda pvPower je větší nebo rovno 1200 a nastav sTurn podle toho\n        if (pvPower >= n_trigger_MPTT) {\n            sTurn = \"on\";\n            nTurn = 1;\n        } else {\n            sTurn = \"off\";\n            nTurn = 0;\n        }\n    }\n\n    // Vytvořit URL na základě hodnoty sTurn\n    _url = fSendUrl(sIpAddress, nRelayNumber, sTurn);\n\n    // Nastavit payload zprávy\n    msg.payload = {\n        _url_m: _url,\n        pvPower: pvPower,\n        nTurn: nTurn,\n        sTurn: sTurn + \" MPTT\"\n    };\n\n    // Debug výpisy\n    if (debug) {\n        node.warn(\"pvPower: \" + pvPower);\n        node.warn(\"sTurn: \" + sTurn);\n        node.warn(\"URL: \" + _url);\n    }\n    } else {\n    node.error(\"Globální funkce nebyly nalezeny. <- FORM CHLAZENI FVE -- MPTT\");\n}\nreturn msg;\n\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":320,"wires":[["232971085f517d96","336752599f366b33","c71d738693128266","d705678e916ee6db"]]},{"id":"232971085f517d96","type":"debug","z":"6cf0017697520c44","name":"_url_m","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload._url_m","targetType":"msg","statusVal":"payload","statusType":"auto","x":830,"y":360,"wires":[]},{"id":"adc258f90f469e5a","type":"function","z":"6cf0017697520c44","name":"OFF_MPTT","func":"//*****************************************************************************\n//\n// File Name        : 'Chlazeni MPTT trakeru'\n// Title            : Cooling of Trackers in the Rack\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 19-12-2023, 09:51\n// Revised          : 19-12-2023, 09:52\n// Version          : 1.11\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\nmsg.payload = \"http://192.168.11.7/relay/0?turn=off\";\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1230,"y":420,"wires":[["84042b69f9b84c81"]]},{"id":"4b426567f09395d4","type":"function","z":"6cf0017697520c44","name":"ON_MPTT","func":"//*****************************************************************************\n//\n// File Name        : 'Chlazeni MPTT trakeru'\n// Title            : Cooling of Trackers in the Rack\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 19-12-2023, 09:51\n// Revised          : 19-12-2023, 09:52\n// Version          : 1.11\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\nmsg.payload = \"http://192.168.11.7/relay/0?turn=on\";\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1230,"y":460,"wires":[["84042b69f9b84c81"]]},{"id":"5fccbb56b9c0a1e6","type":"inject","z":"6cf0017697520c44","name":"START 1 minuta","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"*/1 4-21 * * *","once":false,"onceDelay":"5","topic":"","payload":"","payloadType":"date","x":210,"y":280,"wires":[["963735aa2c2813dd","af0ca4755bf9af8e"]]},{"id":"84042b69f9b84c81","type":"http request","z":"6cf0017697520c44","name":"","method":"GET","ret":"txt","paytoqs":"ignore","url":"{{{payload}}}","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":1210,"y":300,"wires":[["3416fd3bc02de1c1","08ae0e51d9c5db3d"]]},{"id":"9b2cf902516106b9","type":"function","z":"6cf0017697520c44","name":"CHANGER","func":"//*****************************************************************************\n//\n// File Name        : 'Chlazeni_CHANGERs'\n// Title            : Cooling of Changers in the Rack\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 21-10-2023, 11:00\n// Revised          : 06-07-2024, 10:27\n// Version          : 1.4\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fSendUrl = global.get('fSendUrl');\nconst nConvertSignetUnsignet = global.get('nConvertSignetUnsignet');\n\nif (fSendUrl && nConvertSignetUnsignet) {\n\n    const nRelayNumber = 0;\n    const sIpAddress = \"192.168.11.9\";\n    let sTurn = \"off\";  // Výchozí hodnota\n    let nTurn = 0;  // Výchozí hodnota\n    let n_trigger_Changer = 700; // defaultní hodnota triggeru\n    let _url = \"\";\n\n    //Načtení vstupních dat\n    const _general_stop = msg.payload._general_stop;// general stop\n\n    // Definice fazi AC LOAD\n    const phase1 = global.get(\"phase1\") || 0; // Hodnota z registru 817\n    const phase2 = global.get(\"phase2\") || 0;  // Hodnota z registru 818\n    const phase3 = global.get(\"phase3\") || 0;;  // Hodnota z registru 819\n\n    // Definice Gridu\n    const grid1 = global.get(\"grid1\") || 0; // Hodnota z registru 811\n    const grid2 = global.get(\"grid2\") || 0;  // Hodnota z registru 812\n    const grid3 = global.get(\"grid3\") || 0;;  // Hodnota z registru 813\n\n    // Spočítat celkový odběr AC zátěže\n    let totalACLoad = phase1 + phase2 + phase3;\n\n    //Spočítat celkový odber nebo dodávku do GRIDu\n    let _ABS_totalGrid = Math.abs(grid1 + grid2 + grid3); //vzdy kladna hodnota\n\n    if (_general_stop == true){\n        sTurn = \"off\";\n        nTurn = 0;\n    }else{// Zkontroluj, zda totalACLoad nebo  _ABS_totalGrid je větší jako n_trigger_Changer a podle toho nastav sTurn.\n        if (totalACLoad > n_trigger_Changer || _ABS_totalGrid > n_trigger_Changer) {\n            sTurn = \"on\";\n            nTurn = 1;\n        } else {\n            sTurn = \"off\";\n            nTurn = 0;\n        }\n    }\n\n    // Vytvořit URL na základě hodnoty sTurn\n    _url = fSendUrl(sIpAddress, nRelayNumber, sTurn);\n\n    // Nastavit payload zprávy\n    msg.payload = {\n        _url_ch: _url,\n        _ABS_totalGrid: _ABS_totalGrid,\n        totalACLoad: totalACLoad,\n        sTurn: sTurn + \" CHANGER\",\n        nTurn: nTurn\n    };\n\n    // Debug výpisy\n    if (debug) {\n        node.warn(\"totalACLoad: \" + totalACLoad);\n        node.warn(\"sTurn: \" + sTurn);\n        node.warn(\"URL: \" + _url);\n        node.warn(\"_ABS_totalGrid: \" + _ABS_totalGrid);\n    }\n    } else {\n    node.error(\"Globální funkce nebyly nalezeny. <- FORM CHLAZENI FVE -- CHANGER\");\n}\nreturn msg;\n\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":630,"y":280,"wires":[["290dcec4e2dbed6d","70a281e12c852b87","ee6410f23d9f9867","2cd8f1d0601931db","0113661ddfe281dc"]]},{"id":"3416fd3bc02de1c1","type":"debug","z":"6cf0017697520c44","name":"debug 17","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload","statusType":"auto","x":1400,"y":240,"wires":[]},{"id":"e88d7e3953ab230d","type":"inject","z":"6cf0017697520c44","name":"FAN ALL STOP","props":[{"p":"payload._general_stop","v":"true","vt":"bool"}],"repeat":"","crontab":"","once":true,"onceDelay":"2","topic":"","x":220,"y":320,"wires":[["963735aa2c2813dd","af0ca4755bf9af8e"]]},{"id":"dcf18630a930ca56","type":"function","z":"6cf0017697520c44","name":"OFF_CHANGERs","func":"//*****************************************************************************\n//\n// File Name        : 'Chlazeni MPTT trakeru'\n// Title            : Cooling of Trackers in the Rack\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2023\n// Created          : 19-12-2023, 09:51\n// Revised          : 19-12-2023, 09:52\n// Version          : 1.11\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\nmsg.payload  = \"http://192.168.11.9/relay/0?turn=off\";\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1230,"y":160,"wires":[["84042b69f9b84c81"]]},{"id":"8276fff68367b447","type":"function","z":"6cf0017697520c44","name":"ON_CHANGERs","func":"//*****************************************************************************\n//\n// File Name        : 'Chlazeni MPTT trakeru'\n// Title            : Cooling of Trackers in the Rack\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2023\n// Created          : 19-12-2023, 09:51\n// Revised          : 19-12-2023, 09:52\n// Version          : 1.11\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\nmsg.payload  = \"http://192.168.11.9/relay/0?turn=on\";\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1230,"y":200,"wires":[["84042b69f9b84c81"]]},{"id":"336752599f366b33","type":"debug","z":"6cf0017697520c44","name":"sTurn","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload.sTurn","targetType":"msg","statusVal":"payload.sTurn ","statusType":"auto","x":830,"y":420,"wires":[]},{"id":"c71d738693128266","type":"debug","z":"6cf0017697520c44","name":"pvPower","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload.pvPower","targetType":"msg","statusVal":"payload.pvPower","statusType":"auto","x":840,"y":480,"wires":[]},{"id":"290dcec4e2dbed6d","type":"debug","z":"6cf0017697520c44","name":"_url_ch","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload._url_ch","targetType":"msg","statusVal":"payload","statusType":"auto","x":840,"y":220,"wires":[]},{"id":"70a281e12c852b87","type":"debug","z":"6cf0017697520c44","name":"sTurn","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload.sTurn","targetType":"msg","statusVal":"payload.sTurn ","statusType":"auto","x":830,"y":160,"wires":[]},{"id":"ee6410f23d9f9867","type":"debug","z":"6cf0017697520c44","name":"totalACLoad","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload.totalACLoad","targetType":"msg","statusVal":"payload.pvPower","statusType":"auto","x":850,"y":100,"wires":[]},{"id":"2cd8f1d0601931db","type":"function","z":"6cf0017697520c44","name":"CopyOnChange_URL_ch","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 16-07-2024, 04:40\n// Revised          : 19-07-2024, 16:51\n// Version          : 1.01\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\nconst nWaitLoop = 20; //kolik cyklu cekat\n\n// Inicializace kontextových proměnných\nlet nCopyOnChange_url_ch = context.get('nCopyOnChange_url_ch') || \"\";\nlet nWaitLoop_ch = context.get('nWaitLoop_ch') || 0;\nlet nStopLoop_ch = context.get('nStopLoop_ch') || false;\n\n// Načtení vstupních dat\nconst _url_ch = msg.payload && msg.payload._url_ch ? msg.payload._url_ch : \"\";\nconst nTurn = msg.payload && msg.payload.nTurn !== undefined ? msg.payload.nTurn : false;\n\n// Zvýšení nWaitLoop_ch\nnWaitLoop_ch += 1;\ncontext.set('nWaitLoop_ch', nWaitLoop_ch);\n\n// Debug výpisy\nif (debug) {\n    node.warn(\"_url_ch: \" + _url_ch);\n    node.warn(\"nCopyOnChange_url_ch: \" + nCopyOnChange_url_ch);\n    node.warn(\"nWaitLoop_ch: \" + nWaitLoop_ch);\n    node.warn(\"nWaitLoop: \" + nWaitLoop);\n    node.warn(\"nTurn: \" + nTurn);\n    node.warn(\"nStopLoop_ch: \" + nStopLoop_ch);\n}\n\n// Porovnat aktuální hodnotu s poslední odeslanou hodnotou a nebo pri nWaitLoop a nTurn == false (20x po sobe prislo potvrzenivypnuti ventilatoru), provest vypnuti ventilatoru\nif (_url_ch != nCopyOnChange_url_ch || (nWaitLoop_ch > nWaitLoop && nTurn == false)) {//vypinani ventilatoru\n    if (nWaitLoop_ch > nWaitLoop && nTurn == false) {//20x posobe prislo stop, tak vypnout ventilator\n        // pri nWaitLoop a nTurn == false (20x po sobe prislo potvrzenivypnuti ventilatoru), provest vypnuti ventilatoru\n        if (nStopLoop_ch == false) {;\n            context.set('nCopyOnChange_url_ch', _url_ch);\n            context.set('nStopLoop_ch', true);\n            msg.payload = _url_ch; // Odeslat zprávu\n            return msg;\n        } else {//toto by nikdy nemelo nastat\n            return null; // Vrátit null, aby zpráva nebyla odeslána\n        }\n    } else {\n\n        if (nTurn == true) {\n            context.set('nCopyOnChange_url_ch', _url_ch);\n            context.set('nWaitLoop_ch', 0);\n            context.set('nStopLoop_ch', false);\n            msg.payload = _url_ch; // Odeslat zprávu\n            return msg;\n        }\n        else{//neprislo po sobe 20x stop fan\n            return null; // Vrátit null, aby zpráva nebyla odeslána\n        }\n    }\n\n} else {//zapnuty ventilator\n    if (nTurn == true) {\n        context.set('nCopyOnChange_url_ch', _url_ch);\n        context.set('nWaitLoop_ch', 0);\n        context.set('nStopLoop_ch', false);\n        msg.payload = _url_ch; // Odeslat zprávu\n        return msg;\n    } else {//toto by nikdy nemelo nastat\n        return null; // Vrátit null, aby zpráva nebyla odeslána\n        }\n}\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":950,"y":280,"wires":[["84042b69f9b84c81"]]},{"id":"d705678e916ee6db","type":"function","z":"6cf0017697520c44","name":"CopyOnChange_URL_m","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 16-07-2024, 04:40\n// Revised          : 16-07-2024, 16:01\n// Version          : 1.00\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\nconst nWaitLoop = 20; //kolik cyklu cekat\n\n// Inicializace kontextových proměnných\nlet nCopyOnChange_url_m = context.get('nCopyOnChange_url_m') || \"\";\nlet nWaitLoop_m = context.get('nWaitLoop_m') || 0;\nlet nStopLoop_m = context.get('nStopLoop_m') || false;\n\n// Načtení vstupních dat\nconst _url_m = msg.payload && msg.payload._url_m ? msg.payload._url_m : \"\";\nconst nTurn = msg.payload && msg.payload.nTurn !== undefined ? msg.payload.nTurn : false;\n\n// Zvýšení nWaitLoop_ch\nnWaitLoop_m += 1;\ncontext.set('nWaitLoop_m', nWaitLoop_m);\n\n// Debug výpisy\nif (debug) {\n    node.warn(\"_url_m: \" + _url_m);\n    node.warn(\"nCopyOnChange_url_m: \" + nCopyOnChange_url_m);\n    node.warn(\"nWaitLoop_m: \" + nWaitLoop_m);\n    node.warn(\"nWaitLoop: \" + nWaitLoop);\n    node.warn(\"nTurn: \" + nTurn);\n    node.warn(\"nStopLoop_mh: \" + nStopLoop_m);\n}\n\n// Porovnat aktuální hodnotu s poslední odeslanou hodnotou a nebo pri nWaitLoop a nTurn == false (20x po sobe prislo potvrzenivypnuti ventilatoru), provest vypnuti ventilatoru\nif (_url_m != nCopyOnChange_url_m || (nWaitLoop_m > nWaitLoop && nTurn == false)) {//vypinani ventilatoru\n    if (nWaitLoop_m > nWaitLoop && nTurn == false) {//20x posobe prislo stop, tak vypnout ventilator\n        // pri nWaitLoop a nTurn == false (20x po sobe prislo potvrzenivypnuti ventilatoru), provest vypnuti ventilatoru\n        if (nStopLoop_m == false) {;\n            context.set('nCopyOnChange_url_m', _url_m);\n            context.set('nStopLoop_m', true);\n            msg.payload = _url_m; // Odeslat zprávu\n            return msg;\n        } else {//toto by nikdy nemelo nastat\n            return null; // Vrátit null, aby zpráva nebyla odeslána\n        }\n    } else {\n\n        if (nTurn == true) {\n            context.set('nCopyOnChange_url_m', _url_m);\n            context.set('nWaitLoop_m', 0);\n            context.set('nStopLoop_m', false);\n            msg.payload = _url_m; // Odeslat zprávu\n            return msg;\n        }\n        else{//neprislo po sobe 20x stop fan\n            return null; // Vrátit null, aby zpráva nebyla odeslána\n        }\n    }\n\n} else {//zapnuty ventilator\n    if (nTurn == true) {\n        context.set('nCopyOnChange_url_m', _url_m);\n        context.set('nWaitLoop_m', 0);\n        context.set('nStopLoop_m', false);\n        msg.payload = _url_m; // Odeslat zprávu\n        return msg;\n    } else {//toto by nikdy nemelo nastat\n        return null; // Vrátit null, aby zpráva nebyla odeslána\n        }\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":950,"y":320,"wires":[["84042b69f9b84c81"]]},{"id":"0113661ddfe281dc","type":"debug","z":"6cf0017697520c44","name":"_ABS_totalGrid","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload._ABS_totalGrid","targetType":"msg","statusVal":"payload","statusType":"auto","x":860,"y":40,"wires":[]},{"id":"8579b5149bcc953d","type":"inject","z":"6cf0017697520c44","name":"Nouzovy START","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1040,"y":200,"wires":[["8276fff68367b447"]]},{"id":"b30112a2ed023059","type":"inject","z":"6cf0017697520c44","name":"Nouzovy STOP","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1040,"y":160,"wires":[["dcf18630a930ca56"]]},{"id":"b14b4c17683c173a","type":"inject","z":"6cf0017697520c44","name":"Nouzovy STOP","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1040,"y":420,"wires":[["adc258f90f469e5a"]]},{"id":"c9bf73f8978fc162","type":"inject","z":"6cf0017697520c44","name":"Nouzovy START","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1040,"y":460,"wires":[["4b426567f09395d4"]]},{"id":"b4477a4b529c8abd","type":"inject","z":"6cf0017697520c44","d":true,"name":"Fan ON","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"true","payloadType":"bool","x":420,"y":715,"wires":[["a3145ac30d14d0bd"]]},{"id":"6bd85fd4a1885fff","type":"inject","z":"6cf0017697520c44","d":true,"name":"Fan OFF","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"false","payloadType":"bool","x":400,"y":765,"wires":[["a3145ac30d14d0bd"]]},{"id":"a3145ac30d14d0bd","type":"function","z":"6cf0017697520c44","d":true,"name":"Set Fan Status","func":"let fanStatus = msg.payload;\nmsg.payload = fanStatus;\nreturn msg;","outputs":1,"noerr":0,"x":590,"y":735,"wires":[["27199357375366e4"]]},{"id":"27199357375366e4","type":"ui_template","z":"6cf0017697520c44","d":true,"group":"eff8c2fb7917b0ab","name":"Fan Status Indicator","order":27,"width":6,"height":1,"format":"<div id=\"indicator-container\"\n    style=\"width: 100%; height: 100%; background-color: var(--background-color); display: flex; align-items: center; justify-content: center;\">\n    <div id=\"indicator\" style=\"width: 20px; height: 20px; border-radius: 50%; background-color: grey;\"></div>\n</div>\n\n<script>\n    (function(scope) {\n        function getCSSVariableValue(variable) {\n            return getComputedStyle(document.documentElement).getPropertyValue(variable).trim();\n        }\n\n        scope.$watch('msg.payload', function(newValue, oldValue) {\n            var indicator = document.getElementById('indicator');\n            if (newValue === true) {\n                indicator.style.backgroundColor = getCSSVariableValue('--color_ind_on');\n            } else {\n                indicator.style.backgroundColor = getCSSVariableValue('--color_ind_off');\n            }\n        });\n    })(scope);\n</script>","storeOutMessages":true,"fwdInMessages":true,"resendOnRefresh":false,"templateScope":"local","className":"","x":800,"y":740,"wires":[[]]},{"id":"08ae0e51d9c5db3d","type":"function","z":"6cf0017697520c44","name":"Process Response","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 16-07-2024, 04:40\n// Revised          : 16-07-2024, 16:01\n// Version          : 1.00\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n// Kontrola statusCode\nif (msg.statusCode !== 200) {\n    return null; // Pokud není statusCode 200, vrátíme null a ukončíme zpracování\n}\n\nconst response = JSON.parse(msg.payload);\nlet sURL = msg.responseUrl;\n\n// Ruční zpracování URL pro získání IP adresy a hodnoty 'turn'\nlet ipAddress = sURL.split('/')[2];\nlet turnValue = sURL.includes('turn=on') ? 'on' : 'off';\n\nlet indicatorMsg = {};\n\n// Debugging vstupních dat\nif (debug) {\n    node.warn(\"sURL: \" + sURL);\n    node.warn(\"ipAddress: \" + ipAddress);\n    node.warn(\"turnValue: \" + turnValue);\n}\n\nif (ipAddress === '192.168.11.7') {\n    indicatorMsg = { indicator: 'mptt-fan', status: turnValue, topic: 'update-indicator' };\n} else if (ipAddress === '192.168.11.9') {\n    indicatorMsg = { indicator: 'changer-fan', status: turnValue, topic: 'update-indicator' };\n}\n\nreturn { payload: indicatorMsg };\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1430,"y":300,"wires":[["8d54f61ab89ebbd6"]]},{"id":"8d54f61ab89ebbd6","type":"ui_template","z":"6cf0017697520c44","group":"eff8c2fb7917b0ab","name":"Indicators","order":25,"width":6,"height":2,"format":"<style>\n    .fan-icon {\n        display: inline-block;\n        width: 20px;\n        height: 20px;\n        background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABmJLR0QAAAAAAAD5Q7t/AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH6QIHDwc0fyGufAAAABl0RVh0Q29tbWVudABDcmVhdGVkIHdpdGggR0lNUFeBDhcAAACASURBVDjLpVPbDQAhCCvE35vm9h/BaRxAv7gQjqKJ/FmglIeCxEbHzPDnhURMqkRLYPivagw8wTRWYPJZnGayMhKP+VhlDntnmCdtbNJHgwPQzFkpYW2Mjqm4tGbMrGrV/0eQyYyEDNdqfeyQvCLd7Xl3Jxqd1SyyuOvPJLffeQEfJ2TeTXvcjAAAAABJRU5ErkJggg==');\n        background-size: contain;\n        background-repeat: no-repeat;\n        vertical-align: middle;\n        margin-right: 5px; /* Přidání mezery mezi obrázkem a textem */\n    }\n    .fan-container {\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        margin-left: 13px;\n    }\n    .fan-text {\n        display: inline-flex;\n        align-items: center;\n    }\n    .indicator {\n        width: 20px;\n        height: 20px;\n        border-radius: 50%;\n        background-color: grey;\n        margin-right: 13px;\n    }\n</style>\n\n<div style=\"display: flex; flex-direction: column; gap: 8px; border: 0px solid black; padding-top: 5px; padding-bottom: 5px; background-color: #3c3c3c;\">\n    <div class=\"fan-container\">\n        <div class=\"fan-text\">\n            <div class=\"fan-icon\"></div>\n            <span>MPTT FAN</span>\n        </div>\n        <div id=\"mptt-fan-indicator\" class=\"indicator\"></div>\n    </div>\n    <div class=\"fan-container\">\n        <div class=\"fan-text\">\n            <div class=\"fan-icon\"></div>\n            <span>CHANGER FAN</span>\n        </div>\n        <div id=\"changer-fan-indicator\" class=\"indicator\"></div>\n    </div>\n</div>\n\n<script>\n    (function(scope) {\n        function updateIndicator(indicatorId, turnValue) {\n            var indicator = document.getElementById(indicatorId);\n            if (turnValue === 'on') {\n                indicator.style.backgroundColor = '#32cd32'; // Zelená barva\n            } else {\n                indicator.style.backgroundColor = 'grey'; // Šedá barva\n            }\n        }\n\n        scope.$watch('msg.payload', function(msg) {\n            if (msg && msg.indicator && msg.status) {\n                updateIndicator(msg.indicator + '-indicator', msg.status);\n            }\n        });\n    })(scope);\n</script>","storeOutMessages":true,"fwdInMessages":true,"resendOnRefresh":true,"templateScope":"local","className":"","x":1620,"y":300,"wires":[[]]},{"id":"af0ca4755bf9af8e","type":"delay","z":"6cf0017697520c44","name":"","pauseType":"delay","timeout":"3","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":460,"y":280,"wires":[["9b2cf902516106b9"]]},{"id":"4ef9e70b2ecc71c2","type":"modbus-read","z":"7996ac9a8ad2ee7a","name":"AC Consumption L1","topic":"phase1","showStatusActivities":false,"logIOActivities":false,"showErrors":false,"showWarnings":true,"unitid":"100","dataType":"InputRegister","adr":"817","quantity":"1","rate":"1","rateUnit":"s","delayOnStart":false,"startDelayTime":"10","server":"6c801ec0cc108747","useIOFile":false,"ioFile":"","useIOForPayload":false,"emptyMsgOnFail":false,"x":230,"y":340,"wires":[["cec600dec1d94bfd"],["1f5e9abebc20c462"]]},{"id":"ef6e0f1613b3a5d3","type":"modbus-read","z":"7996ac9a8ad2ee7a","name":"AC Consumption L2","topic":"phase2","showStatusActivities":false,"logIOActivities":false,"showErrors":false,"showWarnings":true,"unitid":"100","dataType":"InputRegister","adr":"818","quantity":"1","rate":"1","rateUnit":"s","delayOnStart":false,"startDelayTime":"10","server":"6c801ec0cc108747","useIOFile":false,"ioFile":"","useIOForPayload":false,"emptyMsgOnFail":false,"x":230,"y":400,"wires":[["cec600dec1d94bfd"],["1f5e9abebc20c462"]]},{"id":"45f60e36c74c2ecd","type":"modbus-read","z":"7996ac9a8ad2ee7a","name":"AC Consumption L3","topic":"phase3","showStatusActivities":false,"logIOActivities":false,"showErrors":false,"showWarnings":true,"unitid":"100","dataType":"InputRegister","adr":"819","quantity":"1","rate":"1","rateUnit":"s","delayOnStart":false,"startDelayTime":"10","server":"6c801ec0cc108747","useIOFile":false,"ioFile":"","useIOForPayload":false,"emptyMsgOnFail":false,"x":230,"y":460,"wires":[["cec600dec1d94bfd"],["1f5e9abebc20c462"]]},{"id":"1f5e9abebc20c462","type":"modbus-response","z":"7996ac9a8ad2ee7a","name":"","registerShowMax":"50","x":570,"y":400,"wires":[]},{"id":"3115d0ce2030ec6f","type":"function","z":"7996ac9a8ad2ee7a","name":"AC LOAD","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : AC LOAD\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 20-06-2024, 11:00\n// Revised          : 04-02-2025, 18:38\n// Version          : 1.26\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2025 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fGetConfigProperty = global.get('getConfigProperty');\nconst fSetConfigProperty = global.get('setConfigProperty');\nconst removeSpacesAroundDots = global.get('removeSpacesAroundDots');\nconst nConvertSignetUnsignet = global.get('nConvertSignetUnsignet');\nconst mExtractTime = global.get('mExtractTime');\nconst sExtractTime = global.get('sExtractTime');\nconst sCounty_Code = global.get('sCounty_Code');\nconst sTZidentifier = global.get('sTZidentifier');\nconst spotTresholdPrice = fGetConfigProperty(\"spotTresholdPrice\") || 0; //dotaz na data z globalni strukturu\n\n\ntry {\n    if (removeSpacesAroundDots && sExtractTime && sCounty_Code && sTZidentifier && nConvertSignetUnsignet && mExtractTime && fGetConfigProperty && fSetConfigProperty) {\n        let nSet_Grid_Point = 0;\n\n        // Definice fazi AC LOAD\n        //Nejprve nacte data z MODBUSu, pokud je neplatna hodnota, tak nečte poslední známou hodnotu a pokud i ta neexistuje, tak vysledek je hodnota 0.\n        const phase1 = (parseFloat(msg.payload.phase1) || global.get('phase1')) ?? 0; // Hodnota z registru 817\n        const phase2 = (parseFloat(msg.payload.phase2) || global.get('phase2')) ?? 0;  // Hodnota z registru 818\n        const phase3 = (parseFloat(msg.payload.phase3) || global.get('phase3')) ?? 0;  // Hodnota z registru 819\n    \n        // Definice Gridu\n        //Nejprve nacte data z MODBUSu, pokud je neplatna hodnota, tak nečte poslední známou hodnotu a pokud i ta neexistuje, tak vysledek je hodnota 0.\n        //const grid1 = (nConvertSignetUnsignet(parseFloat(msg.payload.grid1))  || global.get('grid1')) ?? 0; // Hodnota z registru 811\n        //const grid2 = (nConvertSignetUnsignet(parseFloat(msg.payload.grid2))  || global.get('grid2')) ?? 0; // Hodnota z registru 812\n        //const grid3 = (nConvertSignetUnsignet(parseFloat(msg.payload.grid3))  || global.get('grid3')) ?? 0;  // Hodnota z registru 813\n        const grid1 = fCheckValue(nConvertSignetUnsignet(parseFloat(msg.payload.grid1)), 10, \"grid1\"); // Hodnota z registru 811\n        const grid2 = fCheckValue(nConvertSignetUnsignet(parseFloat(msg.payload.grid2)), 10, \"grid2\"); // Hodnota z registru 812\n        const grid3 = fCheckValue(nConvertSignetUnsignet(parseFloat(msg.payload.grid3)), 10, \"grid3\"); // Hodnota z registru 813\n\n        // Definice vyroby FV panelu\n        //Nejprve nacte data z MODBUSu, pokud je neplatna hodnota, tak nečte poslední známou hodnotu a pokud i ta neexistuje, tak vysledek je hodnota 0.\n        //const pvPower = fCheckPVPower(parseFloat(msg.payload.totalPVPower), 10); // Hodnota z registru 819\n        const pvPower = fCheckValue(parseFloat(msg.payload.totalPVPower), 10, \"pvPower\"); // Hodnota z registru 819\n\n        // Definice stavu nabiti baterie\n        //Nejprve nacte data z MODBUSu, pokud je neplatna hodnota, tak nečte poslední známou hodnotu a pokud i ta neexistuje, tak vysledek je hodnota 0.\n        const nBattery_State_Charge = (parseFloat(msg.payload.nBattery_State_Charge) || global.get('nBattery_State_Charge')) ?? 0;  // Hodnota z registru 843 v %//SOC\n        const nBattery_Power = (parseFloat(msg.payload.nBattery_Power) || global.get('nBattery_Power')) ?? 0; // Battery Power (System) 842 ve W\n        const nBattery_Current = (parseFloat(msg.payload.nBattery_Current) || global.get('nBattery_Current')) ?? 0; // Battery Power (System) 841 v A DC\n        const nBattery_Voltage = (parseFloat(msg.payload.nBattery_Voltage) || global.get('nBattery_Voltage')) ?? 0; // Battery Power (System) 840 v V DC\n\n        // Pole dnesniho spotu\n        const todayHourlyPrices = global.get(\"todayHourlyPrices\");\n\n        // Ulozeni dat do globalnich promennych, ktere jsou dostupne mezi flow\n        global.set(\"phase1\", phase1);\n        global.set(\"phase2\", phase2);\n        global.set(\"phase3\", phase3);\n        global.set(\"pvPower\", pvPower);\n        global.set(\"nBattery_State_Charge\", nBattery_State_Charge);\n        global.set(\"grid1\", grid1);\n        global.set(\"grid2\", grid2);\n        global.set(\"grid3\", grid3);\n        global.set(\"nBattery_Power\", nBattery_Power);\n        global.set(\"nBattery_Current\", nBattery_Current);\n        global.set(\"nBattery_Voltage\", nBattery_Voltage);\n\n\n        // Načteni globalnich dat\n        const nBalancingReserve = fGetConfigProperty(\"nBalancingReserve\") || 0; // Hodnota ve W. Slouží k vyrovnávání výkonu, aby se zamezilo kolísání.\n        const nGridConsumptionEnable = !!fGetConfigProperty(\"nGridConsumptionEnable\"); // true znamena zapnut přepinač NUCENY ODBER Z GRIDu\n        const nSetGridValue = fGetConfigProperty(\"nSetGridValue\") || 0;//dotaz na data z globalni strukturu\n        const isSpotAutoCtrlEnabled = !!fGetConfigProperty(\"isSpotAutoCtrlEnabled\"); // true znamená Automaticky podle SPOTu\n        const spotTresholdPrice = fGetConfigProperty(\"spotTresholdPrice\") || 0; // Limitni cena\n        const switchDelayCharging = !!fGetConfigProperty(\"switchDelayCharging\") || 0; // true znamena ze je aktivovana funkce posunuti nabijeni baterie\n        const tDefaultTimeStart = fGetConfigProperty(\"tDefaultTimeStart\") || 0; // Defaultni cas zacatku posunuti nabijeni beterie\n        const tStartBattery = fGetConfigProperty(\"tStartBattery\") || 0; // Zadany cas start posunu nabijeni beterie\n        const tStopBattery = fGetConfigProperty(\"tStopBattery\") || 0; // Zadany cas stop posunu nabijeni beterie\n        const nMorningPeakBatterySales = !!fGetConfigProperty(\"nMorningPeakBatterySales\") || 0; // Switch Prodej baterie v ranní špičce\n        const nEveningPeakBatterySales = !!fGetConfigProperty(\"nEveningPeakBatterySales\") || 0; // Switch Prodej baterie ve večerní špičce\n        const nMorningSOC_sales = fGetConfigProperty(\"nMorningSOC_sales\") || 0; // Procenta - Prodej Rano do SOC\n        const nEveningSOC_sales = fGetConfigProperty(\"nEveningSOC_sales\") || 0; // Procenta - Prodej Večer do SOC\n        const nMAX_Grid_Point = fGetConfigProperty(\"nMAX_Grid_Point\") || 0; // Maximalní vybijecí proud ve W\n        const sGridChargingSwitch = !!fGetConfigProperty(\"sGridChargingSwitch\") || 0; // Switch Nabijeni beterie z Gridu\n        const nGridChargingSOC = fGetConfigProperty(\"nGridChargingSOC\") || 0; // Procenta - Nabiti baterie z GRIDU do SOC\n\n        const currentPrice = global.get(\"currentPrice\") || 0; // Aktualni SPOT cena\n        const nPretoky = !!global.get(\"nPretoky\") || 0; // Pretoky povoleny- true, zakazany - false\n\n\n        const currentTime = new Date(); // aktualni cas\n        const sDate = currentTime.toLocaleString(sCounty_Code, { timeZone: sTZidentifier }); // prida CZ lokaci\n\n        const oDate_CZ = sExtractTime(removeSpacesAroundDots(sDate)); // upravi stavajici obekt cas na prijatelnou podobu pro porovnavani\n\n        const tStartBatteryTime = mExtractTime(tStartBattery); // vstupni promenna je jen milisekundy a nejde porovnavat s aktualnim casem, tak opet uprava na prijatelnou podobu pro porovnavani.\n        const tStopBatteryTime = mExtractTime(tStopBattery);\n\n        // Spočítat celkový odběr AC zátěže\n        let totalACLoad = phase1 + phase2 + phase3;\n\n        // Hleda ranni a odpoleni peaky\n        // prvni promenna je pole aktualniho spot a druha promenna rika jak dlouhy peak muse bejt\n        const morningPeak1 = findMorningPeakHours(todayHourlyPrices, 2);\n        const afternoonPeak1 = findAfternoonPeakHours(todayHourlyPrices, 2);\n\n        // Debugging\n        if (debug) {\n            //node.warn(\"global.get(todayHourlyPrices): \" + todayHourlyPrices);\n            //node.warn(\"global.get(morningPeak1): \" + morningPeak1);\n            //node.warn(\"global.get(afternoonPeak1): \" + afternoonPeak1);\n            node.warn(\"nSetGridValue: \" + nSetGridValue);\n            node.warn(\"nGridConsumptionEnable: \" + nGridConsumptionEnable);\n            //node.warn(\"oDate_CZ: \" + oDate_CZ);\n            //node.warn(\"nSet_Grid_Point: \" + nSet_Grid_Point);\n        }\n\n        nSet_Grid_Point = fSet_Grid(nGridConsumptionEnable, nSetGridValue, isSpotAutoCtrlEnabled, spotTresholdPrice, currentPrice, nPretoky);    \n\n        let nZbytekFV = pvPower - (totalACLoad + nBalancingReserve);\n\n        if (!sGridChargingSwitch){// neni zapnuta funkce na nabijeni baterie z GRIDu\n            // funkce na posun nabijeni baterii\n            if (tStartBatteryTime && tStopBatteryTime) {\n                if (switchDelayCharging == true) { // true znamena ze je aktivovana funkce posunuti nabijeni baterie\n                    if (nPretoky == true) { // povolene pretoky\n                        if (oDate_CZ >= tStartBatteryTime && oDate_CZ <= tStopBatteryTime) { // Aktuální čas je v rozsahu\n                            if (nZbytekFV > 0) { // Prebytek FV je kladna hodnota\n                                nSet_Grid_Point = -nZbytekFV; // prevest na zapornou hodnotu\n                            } else { // mala vyroba z FV panelu\n                                if (currentPrice > 0) {// Dokud neni zaporný spot\n                                    //nedelej nic s registrem nSet_Grid_Point - regist je nastaven pomoci funkce fSet_Grid, dokud ji jine nastaveni nezmeni\n                                } else {nSet_Grid_Point = 0;}// vynuluj registr\n                            }\n                        } else { // Aktuální čas je mimo rozsah\n                            // nSet_Grid_Point = fSet_Grid(nGridConsumptionEnable, nSetGridValue, isSpotAutoCtrlEnabled, spotTresholdPrice, currentPrice, nPretoky);   \n                        }\n                    } else { // Čas začátku nebo konce není nastaven\n                        nSet_Grid_Point = 0;\n                    }\n                }\n            }\n\n            // funkce vybití baterie při ranní špičce\n            if (nMorningPeakBatterySales) {\n                if (morningPeak1.length > 0) {\n                    const peakTimeStart = new Date(oDate_CZ.getFullYear(), oDate_CZ.getMonth(), oDate_CZ.getDate(), morningPeak1[0], 0, 0, 0);\n                    const peakTimeEnd = new Date(oDate_CZ.getFullYear(), oDate_CZ.getMonth(), oDate_CZ.getDate(), morningPeak1[morningPeak1.length - 1], 59, 0, 0);\n\n                    if (debug) {\n                        //node.warn(\"-----------------------------------------\");\n                        //node.warn(\"global.get(morningPeak1): \" + morningPeak1);\n                        //node.warn(\"peakTimeStart: \" + peakTimeStart);\n                        //node.warn(\"peakTimeEnd: \" + peakTimeEnd);\n                        //node.warn(\"oDate_CZ: \" + oDate_CZ);\n                        //node.warn(\"global.get(nBattery_State_Charge): \" + nBattery_State_Charge);\n                        //node.warn(\"nSet_Grid_Point: \" + nSet_Grid_Point);\n                    }\n\n                    if (oDate_CZ >= peakTimeStart && oDate_CZ < peakTimeEnd) {\n                        if (nBattery_State_Charge >= nMorningSOC_sales) {\n                            if (nPretoky == true) { // povolene pretoky\n                                if (currentPrice >= spotTresholdPrice) {// Prodávat do nastavené hodnoty v spotTresholdPrice\n                                    nSet_Grid_Point = EnsureNegativeValue(nMAX_Grid_Point);\n                                }\n                            }\n                        }\n                    }\n                }\n            }\n\n            // funkce vybití baterie při večerní  špičce\n            if (nEveningPeakBatterySales) {\n                if (afternoonPeak1.length > 0) {\n                    const peakTimeStart = new Date(oDate_CZ.getFullYear(), oDate_CZ.getMonth(), oDate_CZ.getDate(), afternoonPeak1[0], 0, 0, 0);\n                    const peakTimeEnd = new Date(oDate_CZ.getFullYear(), oDate_CZ.getMonth(), oDate_CZ.getDate(), afternoonPeak1[afternoonPeak1.length - 1], 59, 0, 0);\n\n                    if (debug) {\n                        //node.warn(\"-----------------------------------------\");\n                        //node.warn(\"global.get(afternoonPeak1): \" + afternoonPeak1);\n                        //node.warn(\"peakTimeStart: \" + peakTimeStart);\n                        //node.warn(\"peakTimeEnd: \" + peakTimeEnd);\n                        //node.warn(\"oDate_CZ: \" + oDate_CZ);\n                        //node.warn(\"global.get(nBattery_State_Charge): \" + nBattery_State_Charge);\n                        //node.warn(\"nSet_Grid_Point: \" + nSet_Grid_Point);\n                    }\n\n                    if (oDate_CZ >= peakTimeStart && oDate_CZ < peakTimeEnd) {\n                        if (nBattery_State_Charge >= nEveningSOC_sales) {\n                            if (nPretoky == true) { // povolene pretoky\n                                if (currentPrice >= spotTresholdPrice) {// Prodávat do nastavené hodnoty v spotTresholdPrice\n                                    nSet_Grid_Point = EnsureNegativeValue(nMAX_Grid_Point);\n                                }\n                            }\n                        }\n                    }\n                }\n            }\n        } else {// Zapnuta funkce nabijeni baterie z gridu, nabiji do nastaveneho SOC, pak vypne nabijení :).\n            //nGridChargingSOC\n            if (nBattery_State_Charge < nGridChargingSOC) {\n                nSet_Grid_Point = EnsurePositiveValue(nMAX_Grid_Point);\n            }else {//vypnout nabijeni\n            fSetConfigProperty(\"sGridChargingSwitch\", false); //vypne nabijeni aby bebylo kminání (urdřování baterie na SOC tato funkce neřeší)\n            }\n            if (debug) {\n                        //node.warn(\"-----------------------------------------\");\n                        node.warn(\"nBattery_State_Charge: \" + nBattery_State_Charge);\n                        node.warn(\"nGridChargingSOC: \" + nGridChargingSOC);\n                    }\n        }\n\n        // Nastavit celkový odběr jako novou hodnotu pro nastavení sítě\n        msg.payload = { \"nSet_Grid_Point\": nSet_Grid_Point,\n                        \"pvPower\": pvPower,\n                        \"totalACLoad\": totalACLoad,\n                        \"nZbytekFV\": nZbytekFV\n                        };\n\n        } else {// nenalezeny globalni funkce\n        node.error(\"Globální funkce nebyly nalezeny. <-- FORM BATTERY CONTROL-- AC LOAD\");\n    }\n    return msg;\n} catch (error) {\n    node.error(\"Error in script: \" + error.message);\n}\n\n// Oprava validnich dat z FV panelu, pokud bude X krat po sobe nula, tak vysledek bude nula, pokud bude nula 1x a min nez trigger, \n// tak se vezme hodnota z glovalniho buffru\n/*function fCheckPVPower(pvPowerReading, readingCount) {\n    let zeroReadingsCount = global.get('zeroReadingsCount') || 0;\n    let pvPower;\n\n    if (pvPowerReading === 0) {// Zvýšení čítače, pokud byla přečtena hodnota 0\n        zeroReadingsCount += 1;\n\n        if (zeroReadingsCount >= readingCount) {// Pokud čítač dosáhne požadovaného počtu, nastavíme pvPower na 0\n            pvPower = 0;\n            zeroReadingsCount = 0; // Resetování čítače\n        } else {// Jinak používáme globální proměnnou nebo poslední platnou hodnotu\n            pvPower = global.get('pvPower') ?? 0;\n        }\n    } else if (pvPowerReading === null) {// Pokud je čtení neplatné, použijeme globální proměnnou\n        pvPower = global.get('pvPower') ?? 0;\n        zeroReadingsCount = 0; // Reset čítače, pokud čtení nebylo 0\n    } else {// Pokud je čtení platné a nenulové, používáme ho\n        pvPower = pvPowerReading;\n        zeroReadingsCount = 0; // Reset čítače, pokud čtení nebylo 0\n    }\n    // Uložení čítače zpět do globální proměnné\n    global.set('zeroReadingsCount', zeroReadingsCount);\n\n    return pvPower;\n}\n*/\n\n//const result = fCheckValue(pvPowerReading, 10, \"pvPower\")\n// Oprava validnich dat z MBUSu, pokud bude X krat po sobe nula, tak vysledek bude nula, pokud bude nula 1x a min nez trigger, \n// tak se vezme hodnota z glovalniho buffru\nfunction fCheckValue(pvPowerReading, readingCount, globalVarName) {\n    // Dynamicky vytvoří název čítače na základě globalVarName\n    let zeroReadingsCountKey = `${globalVarName}_Count`;\n\n    // Získá dynamicky čítač a počáteční hodnotu výkonu z globálních proměnných\n    let zeroReadingsCount = global.get(zeroReadingsCountKey) || 0;\n    let pvPower = global.get(globalVarName) ?? 0; // Defaultně nastavíme na 0, pokud není dostupná globální hodnota\n\n    if (pvPowerReading === 0) {\n        // Zvýšení čítače, pokud byla přečtena hodnota 0\n        zeroReadingsCount += 1;\n\n        if (zeroReadingsCount >= readingCount) {\n            // Pokud čítač dosáhne požadovaného počtu, nastavíme pvPower na 0\n            pvPower = 0;\n            zeroReadingsCount = 0; // Resetování čítače\n        }\n    } else if (pvPowerReading === null) {\n        // Pokud je čtení neplatné, použijeme globální proměnnou\n        zeroReadingsCount = 0; // Reset čítače, pokud čtení nebylo 0\n    } else {\n        // Pokud je čtení platné a nenulové, používáme ho\n        pvPower = pvPowerReading;\n        zeroReadingsCount = 0; // Reset čítače, pokud čtení nebylo 0\n    }\n\n    // Uložení dynamicky generovaného čítače zpět do globální proměnné\n    global.set(zeroReadingsCountKey, zeroReadingsCount);\n    // Uložení dynamicky generované hodnoty výkonu zpět do globální proměnné\n    global.set(globalVarName, pvPower);\n\n    return pvPower;\n}\n\n\n// funkce nastavuje GridPoint podle zadane hodnoty\nfunction fSet_Grid(nGridConsumptionEnable, nSetGridValue, isSpotAutoCtrlEnabled, spotTresholdPrice, currentPrice, nPretoky) {\n    let nSetGridPoint = 0;\n\n    if (currentPrice > 0) { // Dokud neni zaporný spot\n        if (nGridConsumptionEnable == true) { // zapnuy nuceny odber z Gridu\n            // if(spotTresholdPrice <= currentPrice) // aktualni cena je rovne nebo vetsi nastavena limitni cena\n            nSetGridPoint = nSetGridValue;\n        }\n    }\n    return nSetGridPoint; \n}\n\n// Tato funkce vypočítá medián zadaných hodnot\nfunction calculateMedian(values) {\n    values = values.slice().sort((a, b) => a - b);\n    const mid = Math.floor(values.length / 2);\n\n    if (values.length % 2 === 0) {\n        return (values[mid - 1] + values[mid]) / 2;\n    } else {\n        return values[mid];\n    }\n}\n\n// Tyto funkce používají calculateMedian k určení prahové hodnoty pro ranní a odpolední hodiny\nfunction findMorningPeakHours(hourlyValues, maxPeakLength = 3) {\n    if (hourlyValues.length !== 24) {\n        throw new Error('Array must contain exactly 24 elements.');\n    }\n\n    const peakThreshold = calculateMedian(hourlyValues.slice(0, 12));\n    let morningPeakHours = [];\n\n    // Najít ranní špičku (0-11 hodin)\n    for (let i = 0; i < 12; i++) {\n        if (hourlyValues[i] >= peakThreshold) {\n            morningPeakHours.push(i);\n        }\n    }\n\n    return findContinuousBlocks(morningPeakHours, maxPeakLength, hourlyValues);\n}\n\nfunction findAfternoonPeakHours(hourlyValues, maxPeakLength = 3) {\n    if (hourlyValues.length !== 24) {\n        throw new Error('Array must contain exactly 24 elements.');\n    }\n\n    const peakThreshold = calculateMedian(hourlyValues.slice(12, 24));\n    let afternoonPeakHours = [];\n\n    // Najít večerní špičku (12-23 hodin)\n    for (let i = 12; i < 24; i++) {\n        if (hourlyValues[i] >= peakThreshold) {\n            afternoonPeakHours.push(i);\n        }\n    }\n\n    return findContinuousBlocks(afternoonPeakHours, maxPeakLength, hourlyValues);\n}\n\n// Tato funkce zjišťuje souvislé bloky hodin v daném poli a vrací nejdelší blok nebo prázdné pole\nfunction findContinuousBlocks(hoursArray, maxPeakLength, values) {\n    let blocks = [];\n    let currentBlock = [];\n\n    for (let i = 0; i < hoursArray.length; i++) {\n        if (currentBlock.length === 0) {\n            currentBlock.push(hoursArray[i]);\n        } else if (hoursArray[i] === currentBlock[currentBlock.length - 1] + 1) {\n            currentBlock.push(hoursArray[i]);\n        } else {\n            blocks.push(currentBlock);\n            currentBlock = [hoursArray[i]];\n        }\n    }\n\n    if (currentBlock.length > 0) {\n        blocks.push(currentBlock);\n    }\n\n    // Najít nejdelší blok nebo vrátit prázdné pole, s maximální délkou bloku\n    let longestBlock = blocks.reduce((a, b) => (a.length > b.length ? a : b), []);\n\n    if (longestBlock.length > maxPeakLength) {\n        let bestBlock = longestBlock.slice(0, maxPeakLength);\n        let bestAvg = calculateAverage(bestBlock, values);\n\n        for (let i = 1; i <= longestBlock.length - maxPeakLength; i++) {\n            let currentBlock = longestBlock.slice(i, i + maxPeakLength);\n            let currentAvg = calculateAverage(currentBlock, values);\n\n            if (currentAvg > bestAvg) {\n                bestBlock = currentBlock;\n                bestAvg = currentAvg;\n            }\n        }\n\n        return bestBlock;\n    } else {\n        return longestBlock;\n    }\n}\n\n// Tato funkce vypočítá průměrnou hodnotu pro daný blok hodin\nfunction calculateAverage(block, values) {\n    let sum = block.reduce((acc, hour) => acc + values[hour], 0);\n    return sum / block.length;\n}\n\n//funkce prevede kladne cislo na zaporne a ignoruje text a zapornou hodnotu ponecha bezezmeny..\nfunction EnsureNegativeValue(inputValue) {\n    // Check if the input is a number\n    if (typeof inputValue === 'number') {\n        // Ensure the value is negative\n        if (inputValue > 0) {\n            // Convert positive value to negative\n            return -Math.abs(inputValue);\n        } else {\n            // Leave the value unchanged if it is already negative or zero\n            return inputValue;\n        }\n    } else {\n        // If the input is not a number, return 0\n        return 0;\n    }\n}\n\n//funkce prevede vstupni císlo na kladné a innoruje text\nfunction EnsurePositiveValue(inputValue) {\n    // Check if the input is a number\n    if (typeof inputValue === 'number') {\n        // Ensure the value is positive\n        if (inputValue < 0) {\n            // Convert negative value to positive\n            return Math.abs(inputValue);\n        } else {\n            // Leave the value unchanged if it is already positive or zero\n            return inputValue;\n        }\n    } else {\n        // If the input is not a number, return 0\n        return 0;\n    }\n}\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":660,"y":320,"wires":[["e3e693e4b61850ee","9a1f2f8805f543fb","3f208915524075da","f3d65ae8e65e4ac6","ba14073142dc8d0a"]]},{"id":"e3e693e4b61850ee","type":"debug","z":"7996ac9a8ad2ee7a","name":"AC LOAD","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload.totalACLoad","targetType":"msg","statusVal":"payload","statusType":"auto","x":840,"y":120,"wires":[]},{"id":"cec600dec1d94bfd","type":"join","z":"7996ac9a8ad2ee7a","name":"AC CON.","mode":"custom","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","useparts":true,"accumulate":false,"timeout":"1","count":"12","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":510,"y":320,"wires":[["3115d0ce2030ec6f"]]},{"id":"c7a153a07781cdf5","type":"modbus-read","z":"7996ac9a8ad2ee7a","name":"READ ESS control loop setpoint","topic":"readgridpoint","showStatusActivities":false,"logIOActivities":false,"showErrors":false,"showWarnings":true,"unitid":"100","dataType":"InputRegister","adr":"2700","quantity":"1","rate":"1","rateUnit":"s","delayOnStart":false,"startDelayTime":"10","server":"6c801ec0cc108747","useIOFile":false,"ioFile":"","useIOForPayload":false,"emptyMsgOnFail":false,"x":270,"y":600,"wires":[["394228e3099e5995"],["1f5e9abebc20c462"]]},{"id":"1f78db0fc7ca1706","type":"debug","z":"7996ac9a8ad2ee7a","name":"GRID POINT","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload","statusType":"auto","x":850,"y":580,"wires":[]},{"id":"394228e3099e5995","type":"function","z":"7996ac9a8ad2ee7a","name":"convert signet to unsignet","func":"//*****************************************************************************\n//\n// File Name        : N/A \n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 20-06-2024, 11:00\n// Revised          : 14-07-2024\n// Version          : 1.01\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst nConvertSignetUnsignet = global.get('nConvertSignetUnsignet');\nconst readgridpoint = parseFloat(msg.payload) || 0; //\n\n\n // Debugging\nif (debug) {\n    node.warn(\"readgridpoint: \" + readgridpoint);\n}\n        \nif (nConvertSignetUnsignet) {\n    msg.payload = nConvertSignetUnsignet(readgridpoint);\n}   else {\n    node.error(\"Globální funkce nebyly nalezeny. <-FORM Battery Control -- convert Signet to Unsignet\");\n}\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":610,"y":580,"wires":[["1f78db0fc7ca1706","cdbb430a58676409"]]},{"id":"ab5ff1b4c5a7c628","type":"modbus-read","z":"7996ac9a8ad2ee7a","name":"Total PV Power","topic":"totalPVPower","showStatusActivities":false,"logIOActivities":false,"showErrors":false,"showWarnings":true,"unitid":"100","dataType":"InputRegister","adr":"850","quantity":"1","rate":"1","rateUnit":"s","delayOnStart":false,"startDelayTime":"10","server":"6c801ec0cc108747","useIOFile":false,"ioFile":"","useIOForPayload":false,"emptyMsgOnFail":false,"x":220,"y":540,"wires":[["cec600dec1d94bfd"],["1f5e9abebc20c462"]]},{"id":"9a1f2f8805f543fb","type":"debug","z":"7996ac9a8ad2ee7a","name":"pvPower","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload.pvPower","targetType":"msg","statusVal":"payload. pvPower","statusType":"auto","x":840,"y":180,"wires":[]},{"id":"3f208915524075da","type":"debug","z":"7996ac9a8ad2ee7a","name":"nZbytekFV","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload.nZbytekFV","targetType":"msg","statusVal":"payload","statusType":"auto","x":850,"y":240,"wires":[]},{"id":"4fa928a26e09c60d","type":"modbus-write","z":"7996ac9a8ad2ee7a","name":"WRITE ESS control loop setpoint","showStatusActivities":false,"showErrors":false,"showWarnings":true,"unitid":"100","dataType":"HoldingRegister","adr":"2700","quantity":"1","server":"6c801ec0cc108747","emptyMsgOnFail":false,"keepMsgProperties":false,"delayOnStart":false,"startDelayTime":"","x":1200,"y":360,"wires":[[],["868a11fddbae10cd"]]},{"id":"868a11fddbae10cd","type":"modbus-response","z":"7996ac9a8ad2ee7a","name":"","registerShowMax":"5","x":1470,"y":360,"wires":[]},{"id":"ba14073142dc8d0a","type":"function","z":"7996ac9a8ad2ee7a","name":"convert unsignet to signet","func":"//*****************************************************************************\n//\n// File Name        : N/A \n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 20-06-2024, 11:00\n// Revised          : 14-07-2024\n// Version          : 1.01\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n// Získat poslední odeslanou hodnotu z kontextu\nlet nLastValue_Set_Grid_Point = context.get('nLastValue_Set_Grid_Point');\n\n// Definice globálních funkcí\nconst nConvertUnsignetToSignet = global.get('nConvertUnsignetToSignet');\nlet writegridpoint = parseFloat(msg.payload.nSet_Grid_Point) || 0;\n\nif (nConvertUnsignetToSignet) {\n    writegridpoint = nConvertUnsignetToSignet(writegridpoint);\n    \n    // Porovnat aktuální hodnotu s poslední odeslanou hodnotou\n    if (writegridpoint !== nLastValue_Set_Grid_Point) {\n\n        // Hodnota se změnila, uložit novou hodnotu do kontextu\n        context.set('nLastValue_Set_Grid_Point', writegridpoint); \n        \n        msg.payload = writegridpoint; // Odeslat zprávu\n\n    } else {\n        // Hodnota je stejná, neodeslat zprávu\n\n        return null; // Vrátit null, aby zpráva nebyla odeslána\n    }\n    \n    // Debugging\n    if (debug) {\n        node.warn(\"writegridpoint: \" + writegridpoint);\n        node.warn(\"nLastValue_Set_Grid_Point: \" + nLastValue_Set_Grid_Point);\n        node.warn(\"msg.payload: \" + msg.payload);\n    }\n} else {\n    node.error(\"Globální funkce nebyly nalezeny. <-FORM Battery Control -- convert Unsignet to signet\");\n}\n\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":870,"y":360,"wires":[["2ef53d56057d98bc","4fa928a26e09c60d"]]},{"id":"2ef53d56057d98bc","type":"debug","z":"7996ac9a8ad2ee7a","name":"debug 7","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":1120,"y":300,"wires":[]},{"id":"f3d65ae8e65e4ac6","type":"debug","z":"7996ac9a8ad2ee7a","name":"nSet_Grid_Point","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload.nSet_Grid_Point","targetType":"msg","statusVal":"payload","statusType":"auto","x":860,"y":300,"wires":[]},{"id":"cdbb430a58676409","type":"ui_text","z":"7996ac9a8ad2ee7a","group":"b1eb05edab318eb0","order":1,"width":6,"height":1,"name":"","label":"Cerbo ESS control loop setpoint","format":"<font color={{fcolor}}>{{msg.payload}}","layout":"row-spread","className":"Kulati_Nahore","style":true,"font":"","fontSize":"16","color":"#0084ff","x":910,"y":540,"wires":[]},{"id":"fe4b662be5a55416","type":"modbus-read","z":"7996ac9a8ad2ee7a","name":"Battery State of Charge","topic":"nBattery_State_Charge","showStatusActivities":false,"logIOActivities":false,"showErrors":false,"showWarnings":true,"unitid":"100","dataType":"InputRegister","adr":"843","quantity":"1","rate":"1","rateUnit":"s","delayOnStart":false,"startDelayTime":"1","server":"6c801ec0cc108747","useIOFile":false,"ioFile":"","useIOForPayload":false,"emptyMsgOnFail":false,"x":240,"y":240,"wires":[["cec600dec1d94bfd"],["1f5e9abebc20c462"]]},{"id":"579d1b1761410efc","type":"catch","z":"7996ac9a8ad2ee7a","name":"Catch Errors","scope":["868a11fddbae10cd","3115d0ce2030ec6f","e3e693e4b61850ee"],"uncaught":false,"x":610,"y":80,"wires":[["e29bc9e03cf59245"]]},{"id":"e29bc9e03cf59245","type":"debug","z":"7996ac9a8ad2ee7a","name":"Debug Errors","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload","statusType":"auto","x":850,"y":80,"wires":[]},{"id":"945ee483a66e0df2","type":"modbus-read","z":"7996ac9a8ad2ee7a","name":"GRID L1","topic":"grid1","showStatusActivities":false,"logIOActivities":false,"showErrors":false,"showWarnings":true,"unitid":"100","dataType":"InputRegister","adr":"820","quantity":"1","rate":"1","rateUnit":"s","delayOnStart":false,"startDelayTime":"10","server":"6c801ec0cc108747","useIOFile":false,"ioFile":"","useIOForPayload":false,"emptyMsgOnFail":false,"x":200,"y":660,"wires":[["cec600dec1d94bfd"],["1f5e9abebc20c462"]]},{"id":"56ad64547e499cf0","type":"modbus-read","z":"7996ac9a8ad2ee7a","name":"GRID L2","topic":"grid2","showStatusActivities":false,"logIOActivities":false,"showErrors":false,"showWarnings":true,"unitid":"100","dataType":"InputRegister","adr":"821","quantity":"1","rate":"1","rateUnit":"s","delayOnStart":false,"startDelayTime":"10","server":"6c801ec0cc108747","useIOFile":false,"ioFile":"","useIOForPayload":false,"emptyMsgOnFail":false,"x":200,"y":720,"wires":[["cec600dec1d94bfd"],["1f5e9abebc20c462"]]},{"id":"f7a0a85aa9e9b556","type":"modbus-read","z":"7996ac9a8ad2ee7a","name":"GRID L3","topic":"grid3","showStatusActivities":false,"logIOActivities":false,"showErrors":false,"showWarnings":true,"unitid":"100","dataType":"InputRegister","adr":"822","quantity":"1","rate":"1","rateUnit":"s","delayOnStart":false,"startDelayTime":"10","server":"6c801ec0cc108747","useIOFile":false,"ioFile":"","useIOForPayload":false,"emptyMsgOnFail":false,"x":200,"y":780,"wires":[["cec600dec1d94bfd"],["1f5e9abebc20c462"]]},{"id":"e809cfb2809a0836","type":"modbus-read","z":"7996ac9a8ad2ee7a","name":"Battery Power","topic":"nBattery_Power","showStatusActivities":false,"logIOActivities":false,"showErrors":false,"showWarnings":true,"unitid":"100","dataType":"InputRegister","adr":"842","quantity":"1","rate":"1","rateUnit":"s","delayOnStart":false,"startDelayTime":"1","server":"6c801ec0cc108747","useIOFile":false,"ioFile":"","useIOForPayload":false,"emptyMsgOnFail":false,"x":210,"y":180,"wires":[["cec600dec1d94bfd"],["1f5e9abebc20c462"]],"info":"Postive: battery begin charged. Negative: battery being"},{"id":"5b7617e45d09ab22","type":"modbus-read","z":"7996ac9a8ad2ee7a","name":"Battery Current ","topic":"nBattery_Current","showStatusActivities":false,"logIOActivities":false,"showErrors":false,"showWarnings":true,"unitid":"100","dataType":"InputRegister","adr":"841","quantity":"1","rate":"1","rateUnit":"s","delayOnStart":false,"startDelayTime":"1","server":"6c801ec0cc108747","useIOFile":false,"ioFile":"","useIOForPayload":false,"emptyMsgOnFail":false,"x":220,"y":120,"wires":[["cec600dec1d94bfd"],["1f5e9abebc20c462"]],"info":"Postive: battery begin charged. Negative: battery being"},{"id":"5912ccd19f0ae5d0","type":"modbus-read","z":"7996ac9a8ad2ee7a","name":"Battery Voltage","topic":"nBattery_Voltage","showStatusActivities":false,"logIOActivities":false,"showErrors":false,"showWarnings":true,"unitid":"100","dataType":"InputRegister","adr":"840","quantity":"1","rate":"1","rateUnit":"s","delayOnStart":false,"startDelayTime":"1","server":"6c801ec0cc108747","useIOFile":false,"ioFile":"","useIOForPayload":false,"emptyMsgOnFail":false,"x":220,"y":60,"wires":[["cec600dec1d94bfd"],["1f5e9abebc20c462"]],"info":"Postive: battery begin charged. Negative: battery being"},{"id":"2d331a50b0d61710","type":"http request","z":"b986d298710d9da5","g":"b42fb09a89761abc","name":"http SPOT request","method":"GET","ret":"txt","paytoqs":"ignore","url":"https://moje.deltagreen.cz/api/prices/daily","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":270,"y":620,"wires":[["d153678c838836aa"]]},{"id":"d153678c838836aa","type":"json","z":"b986d298710d9da5","g":"b42fb09a89761abc","name":"SPOT Data","property":"payload","action":"","pretty":true,"x":470,"y":620,"wires":[["94da292e68864339","64105c5a3b20bb19","ad3b7d4443f6b79e","f7b462f22622136e","e2c55a383129cb1d"]]},{"id":"94da292e68864339","type":"switch","z":"b986d298710d9da5","g":"b42fb09a89761abc","name":"","property":"payload.currentPrice","propertyType":"msg","rules":[{"t":"lt","v":"spotTresholdPrice","vt":"flow"},{"t":"gte","v":"spotTresholdPrice","vt":"flow"},{"t":"else"}],"checkall":"false","repair":false,"outputs":3,"x":690,"y":420,"wires":[[],[],["f96e7d2a877f8124"]]},{"id":"e418a527df65e767","type":"ui_text","z":"b986d298710d9da5","g":"b42fb09a89761abc","group":"6bdf3420903b72e3","order":4,"width":6,"height":1,"name":"","label":"Aktuální SPOT cena","format":"<font color={{msg.fcolor}}>{{msg.payload.currentPrice | number:2}} Kč/kWh","layout":"row-spread","className":"Indicator_ActualSpotCena","style":false,"font":"","fontSize":"","color":"#000000","x":1320,"y":700,"wires":[]},{"id":"31e526f3dcbd2b2a","type":"ui_switch","z":"b986d298710d9da5","g":"f5e086d890235524","name":"Automaticky","label":"Automaticky podle SPOTu","tooltip":"","group":"6bdf3420903b72e3","order":2,"width":6,"height":1,"passthru":true,"decouple":"false","topic":"topic","topicType":"msg","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","animate":false,"className":"Switch_Spot","x":390,"y":280,"wires":[["50f051b4bbe07cc5"]]},{"id":"16f96aa183feec96","type":"ui_text","z":"b986d298710d9da5","g":"b42fb09a89761abc","group":"6bdf3420903b72e3","order":3,"width":6,"height":1,"name":"","label":"Připojení na SPOT","format":"<font color={{msg.fcolor}}>{{msg.payload}}","layout":"row-spread","className":"Indicator_Online","style":false,"font":"","fontSize":16,"color":"#000000","x":1450,"y":820,"wires":[]},{"id":"b5253809c21b8037","type":"debug","z":"b986d298710d9da5","g":"b42fb09a89761abc","name":"ERROR IN SPOT REQUEST","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":1480,"y":860,"wires":[]},{"id":"76540fe7bea2088e","type":"change","z":"b986d298710d9da5","g":"b42fb09a89761abc","name":"hCurrentPrice Active","rules":[{"t":"set","p":"payload","pt":"msg","to":"AKTIVNÍ","tot":"str"},{"t":"set","p":"fcolor","pt":"msg","to":"limegreen","tot":"str"},{"t":"set","p":"enabled","pt":"msg","to":"isSpotAutoCtrlEnabled","tot":"global"}],"action":"","property":"","from":"","to":"","reg":false,"x":1220,"y":820,"wires":[["16f96aa183feec96","cf6ec63e9e803b5c"]]},{"id":"b70c9a8e3f33594d","type":"change","z":"b986d298710d9da5","g":"b42fb09a89761abc","name":"hCurrentPrice Error","rules":[{"t":"set","p":"payload","pt":"msg","to":"SELHALO","tot":"str"},{"t":"set","p":"fcolor","pt":"msg","to":"red","tot":"str"},{"t":"set","p":"enabled","pt":"msg","to":"isSpotAutoCtrlEnabled","tot":"global"}],"action":"","property":"","from":"","to":"","reg":false,"x":1210,"y":860,"wires":[["16f96aa183feec96","b5253809c21b8037"]]},{"id":"af6a1b22fa66ca61","type":"catch","z":"b986d298710d9da5","g":"b42fb09a89761abc","name":"","scope":["2d331a50b0d61710","d153678c838836aa"],"uncaught":false,"x":510,"y":900,"wires":[["f7b462f22622136e"]]},{"id":"e30fb63eea32171a","type":"change","z":"b986d298710d9da5","g":"5ece208427d51524","name":"Set UI (ON)","rules":[{"t":"set","p":"payload","pt":"msg","to":"POVOLENY","tot":"str"},{"t":"set","p":"fcolor","pt":"msg","to":"limegreen","tot":"str"},{"t":"set","p":"nPretoky","pt":"global","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":610,"y":120,"wires":[["e206cc31a3e05c0f"]]},{"id":"d4ef1b7263f1f0c7","type":"switch","z":"b986d298710d9da5","g":"5ece208427d51524","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"num"},{"t":"eq","v":"1","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":390,"y":100,"wires":[["d0c4a942cea93b17"],["e30fb63eea32171a"]]},{"id":"e206cc31a3e05c0f","type":"ui_text","z":"b986d298710d9da5","g":"5ece208427d51524","group":"6bdf3420903b72e3","order":1,"width":6,"height":1,"name":"","label":"Přetoky","format":"<font color={{fcolor}}>{{msg.payload}}","layout":"row-spread","className":"Kulati_Nahore","style":false,"font":"","fontSize":16,"color":"#000000","x":800,"y":100,"wires":[]},{"id":"d0c4a942cea93b17","type":"change","z":"b986d298710d9da5","g":"5ece208427d51524","name":"Set UI (OFF)","rules":[{"t":"set","p":"payload","pt":"msg","to":"ZAKÁZÁNY","tot":"str"},{"t":"set","p":"fcolor","pt":"msg","to":"dd6875","tot":"str"},{"t":"set","p":"nPretoky","pt":"global","to":"false","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":610,"y":80,"wires":[["e206cc31a3e05c0f"]]},{"id":"13ea6ca0b9ca3e03","type":"ui_chart","z":"b986d298710d9da5","g":"b42fb09a89761abc","name":"","group":"7d718c13f8419912","order":2,"width":6,"height":6,"label":"Dnešní SPOT","chartType":"line","legend":"true","xformat":"HH","interpolate":"step","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":"24","removeOlderPoints":"","removeOlderUnit":"3600","cutout":0,"useOneColor":false,"useUTC":true,"colors":["#ff8800","#55ff55","#eea5a5","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"outputs":1,"useDifferentColor":false,"className":"Kulati_Dole","x":1300,"y":560,"wires":[[]]},{"id":"ad3b7d4443f6b79e","type":"function","z":"b986d298710d9da5","g":"b42fb09a89761abc","name":"Prepare tomorrow chart data","func":"//*****************************************************************************\n//\n// File Name        : 'Node_Graf_Spot_Zitra'\n// Title            : Node pro vypočet grafu\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 14-07-2024, 11:00\n// Revised          : 14-07-2024, 12:35\n// Version          : 1.11\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst removeSpacesAroundDots = global.get('removeSpacesAroundDots');\nconst sExtractTime = global.get('sExtractTime');\nconst sCounty_Code = global.get('sCounty_Code');\nconst sTZidentifier = global.get('sTZidentifier');\nconst fGetConfigProperty = global.get('getConfigProperty');\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst spotTresholdPrice = fGetConfigProperty(\"spotTresholdPrice\") || 0; //dotaz na data z globalni strukturu\n\nif (removeSpacesAroundDots && sExtractTime && sCounty_Code && sTZidentifier) {\n    if (\"tomorrowHourlyPrices\" in msg.payload) {\n        var line1 = [];\n        var line2 = [];\n        const currentTime = new Date();\n        const sDate = currentTime.toLocaleString(sCounty_Code, { timeZone: sTZidentifier }); // prida CZ lokaci\n        const oDate_CZ = sExtractTime(removeSpacesAroundDots(sDate)); // upravi stavajici objekt cas na prijatelnou podobu pro porovnavani\n\n        var hourlyPrices = msg.payload.tomorrowHourlyPrices;\n\n        var minPrice = Math.min(...hourlyPrices);\n        var maxPrice = Math.max(...hourlyPrices);\n\n        for (var i = 0; i < 24;) {\n\n            // spot price\n            line1[i] = { \"x\": new Date(oDate_CZ.setUTCHours(i, 0, 0)), \"y\": hourlyPrices[i] };\n            // spot treshold\n            line2[i] = { \"x\": new Date(oDate_CZ.setUTCHours(i, 0, 0)), \"y\": spotTresholdPrice };\n\n            if (debug) {\n                //   node.warn(\"oDate_CZ: \" + oDate_CZ);\n                //   node.warn(\"i: \" + i);\n                //   node.warn(\"hourlyPrices[i] : \" + hourlyPrices[i] );\n            }\n            i++;\n        }\n\n        // add one more point to finish chart line\n        line1[24] = { \"x\": new Date(oDate_CZ.setUTCHours(23, 59, 59)), \"y\": hourlyPrices[23] };\n        line2[24] = { \"x\": new Date(oDate_CZ.setUTCHours(23, 59, 59)), \"y\": spotTresholdPrice };\n\n        msg.payload = [{\n            \"series\": [\"Kč/kWh\", \"Spot limit\"],\n            \"data\": [line1, line2]\n        }];\n\n        msg.minmax = minPrice.toFixed(2) + \" | \" + maxPrice.toFixed(2);\n    } else {\n        // clear chart data to reset, data not available\n        msg.payload = [];\n    }\n\n} else {// nenalezeny globalni funkce\n    node.error(\"Globální funkce nebyly nalezeny. <-- FORM SPOT GRAF -- Prepare tomorrow chart data\");\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":740,"y":660,"wires":[["75ac1831bb5e13e0","117c2520b271ab18"]]},{"id":"64105c5a3b20bb19","type":"function","z":"b986d298710d9da5","g":"b42fb09a89761abc","name":"Prepare today chart data","func":"//*****************************************************************************\n//\n// File Name        : 'Node_Graf_Spot'\n// Title            : Node pro vypočet grafu\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 14-07-2024, 11:00\n// Revised          : 14-07-2024, 12:35\n// Version          : 1.11\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst removeSpacesAroundDots = global.get('removeSpacesAroundDots');\nconst sExtractTime = global.get('sExtractTime');\nconst sCounty_Code = global.get('sCounty_Code');\nconst sTZidentifier = global.get('sTZidentifier');\nconst fGetConfigProperty = global.get('getConfigProperty');\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst spotTresholdPrice = fGetConfigProperty(\"spotTresholdPrice\") || 0; //dotaz na data z globalni strukturu\n\nif (removeSpacesAroundDots && sExtractTime && sCounty_Code && sTZidentifier) {\n    if(\"todayHourlyPrices\" in msg.payload) { \n        var line1 = [];\n        var line2 = [];\n        var currentTimeLine = [];\n        const currentTime = new Date();\n        const sDate = currentTime.toLocaleString(sCounty_Code, { timeZone: sTZidentifier }); // prida CZ lokaci\n        const oDate_CZ = sExtractTime(removeSpacesAroundDots(sDate)); // upravi stavajici objekt cas na prijatelnou podobu pro porovnavani\n\n        var hourlyPrices = msg.payload.todayHourlyPrices;\n        var currPrice = hourlyPrices[oDate_CZ.getHours()];\n        var minPrice = Math.min(...hourlyPrices);\n        var maxPrice = Math.max(...hourlyPrices);\n\n        for(var i=0; i<24;)\n        {\n            // spot price\n            line1[i] = { \"x\": new Date(oDate_CZ.setUTCHours(i,0,0)), \"y\": hourlyPrices[i] };\n            // spot treshold\n            line2[i] = { \"x\": new Date(oDate_CZ.setUTCHours(i,0,0)), \"y\": spotTresholdPrice };\n\n            if (debug){\n            //   node.warn(\"oDate_CZ: \" + oDate_CZ);\n            //   node.warn(\"i: \" + i);\n            //   node.warn(\"hourlyPrices[i] : \" + hourlyPrices[i] );\n            }\n            i++;\n        }   \n        // add one more point to finish chart line\n        line1[24] = { \"x\": new Date(oDate_CZ.setUTCHours(23,59,59)), \"y\": hourlyPrices[23] };\n        line2[24] = { \"x\": new Date(oDate_CZ.setUTCHours(23,59,59)), \"y\": spotTresholdPrice };\n            \n\n        // Získání časového posunu mezi lokálním časem a UTC v minutách\n        // Výpočet časového posunu v hodinách: Použitím metody getTimezoneOffset na aktuálním datu currentTime zjistíme časový posun mezi \n        // lokálním časem a UTC. Tento posun je v minutách, takže jej převedeme na hodiny a násobíme -1, abychom získali obrácený posun.\n        // Úprava aktuálního času: K aktuálnímu času currentTime přičítáme(nebo odečítáme) časový posun v \n        // milisekundách(timezoneOffsetHours * 60 * 60 * 1000), abychom získali čas v UTC.\n        var timezoneOffsetHours = -currentTime.getTimezoneOffset() / 60;\n        var adjustedCurrentTime = new Date(currentTime.getTime() + timezoneOffsetHours * 60 * 60 * 1000);\n\n        if (debug) {\n            node.warn(\"adjustedCurrentTime: \" + adjustedCurrentTime);\n            node.warn(\"sDate: \" + sDate);\n            node.warn(\"currPrice: \" + currPrice);\n            node.warn(\"Časový posun (hodin): \" + timezoneOffsetHours);\n        }\n\n        // current time line marker\n        // Řádky currentTimeLine[0], currentTimeLine[1] a currentTimeLine[2] slouží k vytvoření čáry reprezentující aktuální čas na grafu. \n        // Tyto tři body určují pozici a výšku čáry:\n\n        // X: Aktuální čas(currentDate).\n        // Y: Aktuální cena(currPrice).\n        // Tímto bodem začíná čára na grafu na úrovni aktuální ceny.\n        currentTimeLine[0] = { \"x\": adjustedCurrentTime, \"y\": currPrice };\n        // X: Aktuální čas (currentDate).\n        // Y: Nejnižší cena dne nebo spotová prahová cena minus 0, 1.\n        // Tento bod určuje spodní část čáry, která se nachází těsně pod minimální cenou dne nebo pod spotovou prahovou cenou.\n        currentTimeLine[1] = { \"x\": adjustedCurrentTime, \"y\": ((minPrice < spotTresholdPrice) ? minPrice : spotTresholdPrice) - 0.1 };\n        // X: Aktuální čas (currentDate).\n        // Y: Nejvyšší cena dne nebo spotová prahová cena plus 0, 1.\n        // Tento bod určuje horní část čáry, která se nachází těsně nad maximální cenou dne nebo nad spotovou prahovou cenou.\n        currentTimeLine[2] = { \"x\": adjustedCurrentTime, \"y\": ((maxPrice > spotTresholdPrice) ? maxPrice : spotTresholdPrice) + 0.1 };\n\n\n        msg.payload = [{\n            \"series\": [\"Kč/kWh\", \"Spot limit\", \"Aktuálně\"],\n            \"data\": [line1, line2, currentTimeLine]\n        }];\n        \n        msg.minmax = minPrice.toFixed(2) + \" | \" + maxPrice.toFixed(2);\n    }\n    else{// clear chart data to reset, data not available\n        msg.payload = [];\n    }\n} else {// nenalezeny globalni funkce\n    node.error(\"Globální funkce nebyly nalezeny. <-- FORM SPOT GRAF -- Prepare today chart data\");\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":730,"y":620,"wires":[["13ea6ca0b9ca3e03","a434319c79a45492"]]},{"id":"75ac1831bb5e13e0","type":"ui_chart","z":"b986d298710d9da5","g":"b42fb09a89761abc","name":"","group":"7d718c13f8419912","order":5,"width":6,"height":6,"label":"Zítřejší SPOT","chartType":"line","legend":"true","xformat":"HH","interpolate":"step","nodata":"- nedostupná data -","dot":false,"ymin":"","ymax":"","removeOlder":"24","removeOlderPoints":"","removeOlderUnit":"3600","cutout":0,"useOneColor":false,"useUTC":true,"colors":["#04cece","#aaff55","#17e6f7","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"outputs":1,"useDifferentColor":false,"className":"Kulati_Dole","x":1300,"y":660,"wires":[[]]},{"id":"a7a9fcb365020e85","type":"switch","z":"b986d298710d9da5","g":"b42fb09a89761abc","name":"hCurrentPrice","property":"payload.hCurrentPrice","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"str"},{"t":"neq","v":"1","vt":"str"}],"checkall":"false","repair":false,"outputs":2,"x":1000,"y":860,"wires":[["76540fe7bea2088e"],["b70c9a8e3f33594d"]]},{"id":"76a8d8c71ef25fc8","type":"catch","z":"b986d298710d9da5","g":"b42fb09a89761abc","name":"","scope":["2d331a50b0d61710","d153678c838836aa"],"uncaught":false,"x":690,"y":480,"wires":[["5ce3d905b124c09d","f96e7d2a877f8124","9679043aa5a0ea06"]]},{"id":"5ce3d905b124c09d","type":"function","z":"b986d298710d9da5","g":"b42fb09a89761abc","name":"Reset chart data","func":"// reset chart data\nmsg.minmax = \"---\";\nmsg.payload = [];\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":940,"y":540,"wires":[["75ac1831bb5e13e0","a434319c79a45492","117c2520b271ab18","13ea6ca0b9ca3e03"]]},{"id":"f96e7d2a877f8124","type":"function","z":"b986d298710d9da5","g":"b42fb09a89761abc","name":"Reset data","func":"// reset data\nmsg.fcolor = \"grey\";\nmsg.enabled = flow.get(\"isSpotAutoCtrlEnabled\");\nmsg.payload = {\"currentPrice\": \"---\"};\n    \nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":990,"y":440,"wires":[[]]},{"id":"7a2eeb482b9cbe62","type":"ui_numeric","z":"b986d298710d9da5","g":"f5e086d890235524","name":"","label":"Limitní cena","tooltip":"","group":"6bdf3420903b72e3","order":5,"width":6,"height":1,"wrap":false,"passthru":true,"topic":"topic","topicType":"msg","format":"{{value | number:2}} Kč/kWh","min":"-100","max":"100","step":"0.01","className":"Input_LimitCena","x":810,"y":280,"wires":[["01e3c862dbe56043","c9ce59a6ae17f721"]]},{"id":"a434319c79a45492","type":"ui_text","z":"b986d298710d9da5","g":"b42fb09a89761abc","group":"7d718c13f8419912","order":1,"width":6,"height":1,"name":"Today Min/Max","label":"Dnes:  Min / Max","format":"{{msg.minmax}} Kč/kWh","layout":"row-left","className":"Kulati_Nahore","style":false,"font":"","fontSize":16,"color":"#000000","x":1300,"y":520,"wires":[]},{"id":"117c2520b271ab18","type":"ui_text","z":"b986d298710d9da5","g":"b42fb09a89761abc","group":"7d718c13f8419912","order":4,"width":6,"height":1,"name":"Tomorrow Min/Max","label":"Zítra:  Min / Max","format":"{{msg.minmax}} Kč/kWh","layout":"row-spread","className":"Kulati_Nahore","style":false,"font":"","fontSize":16,"color":"#000000","x":1310,"y":620,"wires":[]},{"id":"9679043aa5a0ea06","type":"debug","z":"b986d298710d9da5","g":"b42fb09a89761abc","name":"Http error - reset UI data","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":950,"y":480,"wires":[]},{"id":"bf176b832b69029b","type":"modbus-read","z":"b986d298710d9da5","g":"5ece208427d51524","name":"","topic":"","showStatusActivities":false,"logIOActivities":false,"showErrors":false,"showWarnings":true,"unitid":"100","dataType":"HoldingRegister","adr":"2707","quantity":"1","rate":"1","rateUnit":"s","delayOnStart":false,"startDelayTime":"","server":"6c801ec0cc108747","useIOFile":false,"ioFile":"","useIOForPayload":false,"emptyMsgOnFail":false,"x":230,"y":100,"wires":[["d4ef1b7263f1f0c7"],["16d87f0ccdd6c314"]]},{"id":"f4e1cf3a0ee52e37","type":"ui_switch","z":"b986d298710d9da5","g":"b42fb09a89761abc","name":"","label":"Přetoky: Vyp / Zap","tooltip":"","group":"6bdf3420903b72e3","order":7,"width":6,"height":1,"passthru":true,"decouple":"false","topic":"payload","topicType":"msg","style":"","onvalue":"1","onvalueType":"num","onicon":"","oncolor":"","offvalue":"0","offvalueType":"num","officon":"","offcolor":"","animate":false,"className":"Kulati_Dole","x":1170,"y":940,"wires":[["5fa9a82ebed3552f"]]},{"id":"16d87f0ccdd6c314","type":"modbus-response","z":"b986d298710d9da5","g":"5ece208427d51524","name":"","registerShowMax":"5","x":430,"y":160,"wires":[]},{"id":"f7b462f22622136e","type":"function","z":"b986d298710d9da5","g":"b42fb09a89761abc","name":"Logick write register 2707","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 14-07-2024, 20:40\n// Revised          : 15-07-2024, 21:35\n// Version          : 1.01\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n// Function to handle errors\nvar errorMessage = msg.error;\n\n//definice globalních funkci\nconst fGetConfigProperty = global.get('getConfigProperty');\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst isSpotAutoCtrlEnabled = !!fGetConfigProperty(\"isSpotAutoCtrlEnabled\"); //dotaz na data z globalni strukturu\nconst spotTresholdPrice = fGetConfigProperty(\"spotTresholdPrice\") || 0; //dotaz na data z globalni strukturu\n\nlet nSpot = 0;\nlet swOnOff = 0;\n\nif (typeof msg.payload === 'object' && \"currentPrice\" in msg.payload) {\n\n    const currentPrice = msg.payload.currentPrice;\n    const todayHourlyPrices = msg.payload.todayHourlyPrices;\n    // Ulozeni dat do globalnich promennych, ktere jsou dostupne mezi flow\n    global.set(\"currentPrice\", currentPrice);\n    global.set(\"todayHourlyPrices\", todayHourlyPrices);\n\n    if (isSpotAutoCtrlEnabled) {\n        if (currentPrice < spotTresholdPrice) {\n            nSpot = 0;\n            swOnOff = 0;\n        } else if (currentPrice >= spotTresholdPrice) {\n            nSpot = 1;\n            swOnOff = 1;\n        }\n        // Nastavit vystup\n        msg.payload = {\n            \"nSpot\": nSpot,\n            \"currentPrice\": currentPrice,\n            \"hCurrentPrice\": 1,\n            \"swOnOff\": swOnOff,\n            \"isSpotAutoCtrlEnabled\": isSpotAutoCtrlEnabled,\n            \"spotTresholdPrice\": spotTresholdPrice\n        };\n        if (debug) {\n            node.warn(\"currentPrice: \" + currentPrice);\n            node.warn(\"spotTresholdPrice: \" + spotTresholdPrice);\n            node.warn(\"nSpot: \" + nSpot);\n        }\n    } else { //obsluha chyby\n        msg.payload = hErrorHandle();\n    }\n} else { //obsluha chyby\n    msg.payload = hErrorHandle();\n}\nreturn msg;\n\nfunction hErrorHandle() {\n    // You can customize your error handling logic here\n    var errorPayload = {\n        \"hCurrentPrice\": 0,\n    };\n\n    // Log the error if debugging is enabled\n    if (debug && errorMessage) {\n        node.warn(\"Error caught: \" + errorMessage.toString());\n    }\n\n    return errorPayload;\n}\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":730,"y":900,"wires":[["5ea652330077301c","05f5f0a1cc1ee777","fb235672515d3eae","38b7ec7ee777b4a9","e20437d8bba5aa5e","a7a9fcb365020e85","b759b4c02def5194","b4b6f64ea3924b4e"]]},{"id":"5ea652330077301c","type":"debug","z":"b986d298710d9da5","g":"b42fb09a89761abc","name":"currentPrice","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload.currentPrice","targetType":"msg","statusVal":"payload","statusType":"auto","x":990,"y":1120,"wires":[]},{"id":"fb235672515d3eae","type":"debug","z":"b986d298710d9da5","g":"b42fb09a89761abc","name":"nSpot","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload.nSpot","targetType":"msg","statusVal":"payload.nSpot","statusType":"auto","x":970,"y":1180,"wires":[]},{"id":"05f5f0a1cc1ee777","type":"debug","z":"b986d298710d9da5","g":"b42fb09a89761abc","name":"spotTresholdPrice","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload.spotTresholdPrice","targetType":"msg","statusVal":"payload.spotTresholdPrice","statusType":"auto","x":1010,"y":1060,"wires":[]},{"id":"5fa9a82ebed3552f","type":"modbus-write","z":"b986d298710d9da5","g":"b42fb09a89761abc","name":"","showStatusActivities":false,"showErrors":false,"showWarnings":true,"unitid":"100","dataType":"HoldingRegister","adr":"2707","quantity":"1","server":"6c801ec0cc108747","emptyMsgOnFail":false,"keepMsgProperties":false,"delayOnStart":false,"startDelayTime":"","x":1440,"y":900,"wires":[[],["96deeb8958d5a03f"]]},{"id":"96deeb8958d5a03f","type":"modbus-response","z":"b986d298710d9da5","g":"b42fb09a89761abc","name":"","registerShowMax":"5","x":1650,"y":940,"wires":[]},{"id":"38b7ec7ee777b4a9","type":"change","z":"b986d298710d9da5","g":"b42fb09a89761abc","name":"Convert_msg","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload.swOnOff","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":990,"y":940,"wires":[["f4e1cf3a0ee52e37"]],"info":"Předani dat do globalnich promennych"},{"id":"e20437d8bba5aa5e","type":"debug","z":"b986d298710d9da5","g":"b42fb09a89761abc","name":"isSpotAutoCtrlEnabled","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload.isSpotAutoCtrlEnabled","targetType":"msg","statusVal":"payload","statusType":"auto","x":1020,"y":1000,"wires":[]},{"id":"b759b4c02def5194","type":"debug","z":"b986d298710d9da5","g":"b42fb09a89761abc","name":"hCurrentPrice","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload.hCurrentPrice","targetType":"msg","statusVal":"payload.spotTresholdPrice","statusType":"auto","x":1000,"y":800,"wires":[]},{"id":"cf6ec63e9e803b5c","type":"debug","z":"b986d298710d9da5","g":"b42fb09a89761abc","name":"Text","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":1410,"y":760,"wires":[]},{"id":"b4b6f64ea3924b4e","type":"function","z":"b986d298710d9da5","g":"b42fb09a89761abc","name":"CopyOnChange_2707","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 16-07-2024, 04:40\n// Revised          : 16-07-2024, 16:01\n// Version          : 1.00\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n// Získat poslední odeslanou hodnotu z kontextu\nlet nCopyOnChange2707 = context.get('nCopyOnChange2707');\n\n//Načtení vstupních dat\nlet nCopyOnChange = parseFloat(msg.payload.nSpot) || 0;\n\n// Porovnat aktuální hodnotu s poslední odeslanou hodnotou\nif (nCopyOnChange !== nCopyOnChange2707) {\n\n    // Hodnota se změnila, uložit novou hodnotu do kontextu\n    context.set('nCopyOnChange2707', nCopyOnChange);\n\n    msg.payload = nCopyOnChange; // Odeslat zprávu\n    return msg;\n    \n} else {// Hodnota je stejná, neodeslat zprávu\n    return null; // Vrátit null, aby zpráva nebyla odeslána\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1020,"y":900,"wires":[["5fa9a82ebed3552f"]]},{"id":"c9ce59a6ae17f721","type":"link out","z":"b986d298710d9da5","g":"f5e086d890235524","name":"SPOT","mode":"link","links":["473c56a48351ed18"],"x":945,"y":280,"wires":[]},{"id":"473c56a48351ed18","type":"link in","z":"b986d298710d9da5","g":"b42fb09a89761abc","name":"link in 1","links":["60292bcfa0867a50","c9ce59a6ae17f721"],"x":145,"y":640,"wires":[["2d331a50b0d61710"]]},{"id":"60292bcfa0867a50","type":"link out","z":"b986d298710d9da5","g":"f5e086d890235524","name":"SPOT","mode":"link","links":["473c56a48351ed18"],"x":685,"y":280,"wires":[]},{"id":"5039e3fad1c8aabc","type":"function","z":"b986d298710d9da5","g":"f5e086d890235524","name":"SET GUI","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 31-07-2024, 17:39\n// Revised          : 31-07-2024, 17:50\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fGetConfigProperty = global.get('getConfigProperty');\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst sBuffer = !!fGetConfigProperty(\"isSpotAutoCtrlEnabled\"); //dotaz na data z globalni strukturu\nmsg.payload  = sBuffer; //SET switch to read data\n\n//Dvojitý negátor !!: Použití dvou negátorů ! převede jakoukoli hodnotu na její boolean ekvivalent.\n// První ! hodnotu zneguje (což znamená, že true se změní na false a naopak), a druhý ! změní hodnotu zpět na boolean:\n//Pokud je původní hodnota \"truthy\" (např. 1, true, ne-prázdný řetězec), výsledek bude true.\n//Pokud je původní hodnota \"falsy\" (např. 0, false, NaN, undefined, prázdný řetězec), výsledek bude false.\n\n// Debugging\nif (debug) {\n    node.warn(\"isSpotAutoCtrlEnabled: \" + sBuffer);\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":240,"y":280,"wires":[["31e526f3dcbd2b2a"]]},{"id":"f2fb9e0e6990da1e","type":"link in","z":"b986d298710d9da5","g":"f5e086d890235524","name":"RESET_GUI","links":["e5706dfefece2626"],"x":145,"y":280,"wires":[["5039e3fad1c8aabc"]]},{"id":"50f051b4bbe07cc5","type":"function","z":"b986d298710d9da5","g":"f5e086d890235524","name":"SET CONFIG","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 31-07-2024, 18:39\n// Revised          : 31-07-2024, 18:55\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fGetConfigProperty = global.get('getConfigProperty');\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst isSpotAutoCtrlEnabled = msg.payload; //nacteni vstupu\nconst spotTresholdPrice = fGetConfigProperty(\"spotTresholdPrice\") || 0; //dotaz na data z globalni strukturu\nfSetConfigProperty(\"isSpotAutoCtrlEnabled\", isSpotAutoCtrlEnabled); //ulozit data do globalni struktury\n\nmsg.payload = spotTresholdPrice;          //nastaveni hodnoty\nmsg.enabled = isSpotAutoCtrlEnabled; //enable switch\n\n// Debugging\nif (debug) {\n    node.warn(\"isSpotAutoCtrlEnabled: \" + isSpotAutoCtrlEnabled);\n    node.warn(\"spotTresholdPrice: \" + spotTresholdPrice);\n    node.warn(\"msg.payload: \" + msg.payload);\n    node.warn(\"msg.enabled: \" + msg.enabled);\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":560,"y":280,"wires":[["7a2eeb482b9cbe62","60292bcfa0867a50"]]},{"id":"01e3c862dbe56043","type":"function","z":"b986d298710d9da5","g":"f5e086d890235524","name":"Set nGridValue","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 31-07-2024, 18:37\n// Revised          : 31-07-2024, 18:47\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst spotTresholdPrice = msg.payload; //nacteni vstupu\nfSetConfigProperty(\"spotTresholdPrice\", spotTresholdPrice); //ulozit data do globalni struktury\n\n// Debugging\nif (debug) {\n    node.warn(\"spotTresholdPrice: \" + spotTresholdPrice);\n}\n\nreturn null;","outputs":0,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1060,"y":280,"wires":[]},{"id":"e2c55a383129cb1d","type":"function","z":"b986d298710d9da5","g":"b42fb09a89761abc","name":"Actual_price_spot","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 01-08-2024, 15:40\n// Revised          : 01-08-2024, 16:35\n// Version          : 1.00\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n// Function to handle errors\nvar errorMessage = msg.error;\n\n//definice globalních funkci\nconst fGetConfigProperty = global.get('getConfigProperty');\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst isSpotAutoCtrlEnabled = !!fGetConfigProperty(\"isSpotAutoCtrlEnabled\"); //dotaz na data z globalni strukturu\nconst spotTresholdPrice = fGetConfigProperty(\"spotTresholdPrice\") || 0; //dotaz na data z globalni strukturu\nvar nFColor = 0;\n\n\nif (typeof msg.payload === 'object' && \"currentPrice\" in msg.payload) {\n\n    const currentPrice = msg.payload.currentPrice;\n    const todayHourlyPrices = msg.payload.todayHourlyPrices;\n    // Ulozeni dat do globalnich promennych, ktere jsou dostupne mezi flow\n    global.set(\"currentPrice\", currentPrice);\n    global.set(\"todayHourlyPrices\", todayHourlyPrices);\n   \n    if (currentPrice < spotTresholdPrice) {//cervena\n        nFColor = \"#dd6875\";\n\n    } else if (currentPrice >= spotTresholdPrice) {//zelena\n        nFColor = \"limegreen\";\n\n    }else {//neurcity stav\n        nFColor = \"#grey\";\n       // currentPrice = \"---\";\n    }\n\n\n\n\n    // Nastavit vystup\n    msg.payload = {\n        \"fcolor\": nFColor,\n        \"enabled\": isSpotAutoCtrlEnabled,\n        \"currentPrice\": currentPrice\n    };\n    if (debug) {\n        node.warn(\"currentPrice: \" + currentPrice);\n        node.warn(\"spotTresholdPrice: \" + spotTresholdPrice);\n\n    }\n\n} else { //obsluha chyby\n    msg.payload = hErrorHandle();\n}\nreturn msg;\n\nfunction hErrorHandle() {\n    // You can customize your error handling logic here\n    var errorPayload = {\n        \"hCurrentPrice\": 0,\n    };\n\n    // Log the error if debugging is enabled\n    if (debug && errorMessage) {\n        node.warn(\"Error caught: \" + errorMessage.toString());\n    }\n\n    return errorPayload;\n}\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":710,"y":700,"wires":[["e418a527df65e767"]]},{"id":"e3cb434152e4befa","type":"link in","z":"b986d298710d9da5","g":"b42fb09a89761abc","name":"CLOCK_15_5S","links":["26e69bb073bbcc02"],"x":145,"y":560,"wires":[["2d331a50b0d61710"]]},{"id":"7f7c294712a3580b","type":"ui_text","z":"dc14bd796219d9ad","g":"1a9d21242a01ebdd","group":"eff8c2fb7917b0ab","order":2,"width":6,"height":1,"name":"","label":"L1","format":"<font color={{fcolor}}>{{msg.payload.phase1}} W","layout":"row-spread","className":"","style":false,"font":"","fontSize":"11","color":"#ffffff","x":1430,"y":520,"wires":[]},{"id":"03042c98ed1f8bd2","type":"ui_text","z":"dc14bd796219d9ad","g":"1a9d21242a01ebdd","group":"eff8c2fb7917b0ab","order":3,"width":6,"height":1,"name":"","label":"L2","format":"<font color={{fcolor}}>{{msg.payload.phase2}} W","layout":"row-spread","className":"zakazano","style":false,"font":"","fontSize":16,"color":"#000000","x":1430,"y":560,"wires":[]},{"id":"47bee02fd17241cc","type":"ui_text","z":"dc14bd796219d9ad","g":"1a9d21242a01ebdd","group":"eff8c2fb7917b0ab","order":4,"width":6,"height":1,"name":"","label":"L3","format":"<font color={{fcolor}}>{{msg.payload.phase3}} W","layout":"row-spread","className":"Kulati_Dole","style":false,"font":"","fontSize":16,"color":"#000000","x":1430,"y":600,"wires":[]},{"id":"3012d4563c8a76e7","type":"ui_text","z":"dc14bd796219d9ad","g":"1a9d21242a01ebdd","group":"eff8c2fb7917b0ab","order":7,"width":6,"height":1,"name":"","label":"L1","format":"<font color={{fcolor}}>{{msg.payload.grid1}} W","layout":"row-spread","className":"","style":false,"font":"","fontSize":16,"color":"#000000","x":1430,"y":700,"wires":[]},{"id":"f901c314b54b444a","type":"ui_text","z":"dc14bd796219d9ad","g":"1a9d21242a01ebdd","group":"eff8c2fb7917b0ab","order":8,"width":6,"height":1,"name":"","label":"L2","format":"<font color={{fcolor}}>{{msg.payload.grid2}} W","layout":"row-spread","className":"","style":false,"font":"","fontSize":16,"color":"#000000","x":1430,"y":740,"wires":[]},{"id":"ecd21f6cd73a0f64","type":"ui_text","z":"dc14bd796219d9ad","g":"1a9d21242a01ebdd","group":"eff8c2fb7917b0ab","order":9,"width":6,"height":1,"name":"","label":"L3","format":"<font color={{fcolor}}>{{msg.payload.grid3}} W","layout":"row-spread","className":"Kulati_Dole","style":false,"font":"","fontSize":16,"color":"#000000","x":1430,"y":780,"wires":[]},{"id":"80350a39c69e782f","type":"ui_text","z":"dc14bd796219d9ad","g":"1a9d21242a01ebdd","group":"eff8c2fb7917b0ab","order":20,"width":6,"height":1,"name":"","label":"🔋 Baterie","format":"<font color={{fcolor}}>{{msg.payload.nBattery_State_Charge}} %","layout":"row-spread","className":"Kulati_Nahore","style":true,"font":"","fontSize":16,"color":"#ffbb00","x":1440,"y":840,"wires":[]},{"id":"87d5cf8d58679897","type":"ui_text","z":"dc14bd796219d9ad","g":"1a9d21242a01ebdd","group":"eff8c2fb7917b0ab","order":24,"width":6,"height":1,"name":"","label":"FW regulatory","format":"<font color={{fcolor}}>{{msg.payload}} W","layout":"row-spread","className":"Kulati_Nahore","style":true,"font":"","fontSize":16,"color":"#ff7200","x":1460,"y":1080,"wires":[]},{"id":"881b340c53404d98","type":"function","z":"dc14bd796219d9ad","g":"1a9d21242a01ebdd","name":"Set AC OUT UI","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 21-10-2023, 11:00\n// Revised          : 06-07-2024, 10:27\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\nlet phase1 = global.get('phase1') || 0;\nlet phase2 = global.get('phase2') || 0;\nlet phase3 = global.get('phase3') || 0;\n\nlet total = phase1 + phase2 + phase3;\n\nmsg.payload = { phase1, phase2, phase3, total };\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1220,"y":520,"wires":[["7f7c294712a3580b","03042c98ed1f8bd2","47bee02fd17241cc","e74ec256923af82c"]]},{"id":"ba02ecffa7282388","type":"inject","z":"dc14bd796219d9ad","g":"1a9d21242a01ebdd","name":"Inject every second","props":[{"p":"payload"}],"repeat":"1","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":420,"y":840,"wires":[["881b340c53404d98","b7f5bd5a3eb90166","33af33642fa0d5a2","fe1d5acc45c21435","9bdbf5d33911e135","c52e4f69764e8ab7"]]},{"id":"b7f5bd5a3eb90166","type":"function","z":"dc14bd796219d9ad","g":"1a9d21242a01ebdd","name":"Set Label1","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 21-10-2023, 11:00\n// Revised          : 04-02-2025, 18:55\n// Version          : 1.3\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2025 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst nConvertSignetUnsignet = global.get('nConvertSignetUnsignet');\n\nif (nConvertSignetUnsignet) {\n        \n        // Skalovací faktor\n        var scaleFactor = 10; \n\n        const nBattery_State_Charge = global.get(\"nBattery_State_Charge\");\n        let nBattery_Power = global.get(\"nBattery_Power\");\n        let nBattery_Current = global.get(\"nBattery_Current\");\n        let nBattery_Voltage = global.get(\"nBattery_Voltage\");\n\n        nBattery_Current = nConvertSignetUnsignet(nBattery_Current);\n        nBattery_Voltage = nConvertSignetUnsignet(nBattery_Voltage);\n        nBattery_Power = nConvertSignetUnsignet(nBattery_Power);\n\n        msg.power = \"Baterie Idle\";\n        msg.current = \"Baterie Idle\";\n        if (nBattery_Power > 0) {\n                msg.power = \"Nabíjení baterie\";\n        }\n        if (nBattery_Power < 0) {\n                msg.power = \"Vybíjení baterie\";\n        }\n\n        if (nBattery_Current > 0) {\n                msg.current = \"Nabíjecí proud baterie\";\n        }\n        if (nBattery_Current < 0) {\n                msg.current = \"Vybíjecí proud baterie\";\n        }\n\n        nBattery_Current = nBattery_Current / scaleFactor;\n        nBattery_Voltage = nBattery_Voltage / scaleFactor;\n       \n        msg.payload = { nBattery_State_Charge, nBattery_Power, nBattery_Current , nBattery_Voltage };\n    } else {\n    node.error(\"Globální funkce nebyly nalezeny. <- FORM GUI -- Set Label1\");\n}\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1210,"y":840,"wires":[["80350a39c69e782f","e7abeb99abbcadac","440fdfb71d3c952e","f85e8528950ff714"]]},{"id":"33af33642fa0d5a2","type":"function","z":"dc14bd796219d9ad","g":"1a9d21242a01ebdd","name":"Set Label","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 21-10-2023, 11:00\n// Revised          : 06-07-2024, 10:27\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\nlet a = global.get(\"pvPower\")|| 0;\nmsg.payload = a;\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1200,"y":1080,"wires":[["87d5cf8d58679897"]]},{"id":"e74ec256923af82c","type":"ui_text","z":"dc14bd796219d9ad","g":"1a9d21242a01ebdd","group":"eff8c2fb7917b0ab","order":1,"width":6,"height":1,"name":"","label":"Total AC zátěž","format":"<font color={{fcolor}}>{{msg.payload.total}} W","layout":"row-spread","className":"Kulati_Nahore","style":true,"font":"","fontSize":16,"color":"#ffbb00","x":1460,"y":480,"wires":[]},{"id":"fe1d5acc45c21435","type":"function","z":"dc14bd796219d9ad","g":"1a9d21242a01ebdd","name":"Set GRID UI","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 21-10-2023, 11:00\n// Revised          : 06-07-2024, 10:27\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\nlet grid1 = global.get('grid1') || 0;\nlet grid2 = global.get('grid2') || 0;\nlet grid3 = global.get('grid3') || 0;\n\nlet total = grid1 + grid2 + grid3;\n\nmsg.payload = { grid1, grid2, grid3, total };\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1210,"y":700,"wires":[["ecd21f6cd73a0f64","f901c314b54b444a","3012d4563c8a76e7","be54171f553bba4a"]]},{"id":"be54171f553bba4a","type":"ui_text","z":"dc14bd796219d9ad","g":"1a9d21242a01ebdd","group":"eff8c2fb7917b0ab","order":6,"width":6,"height":1,"name":"","label":"Total Síť","format":"<font color={{fcolor}}>{{msg.payload.total}} W","layout":"row-spread","className":"Kulati_Nahore","style":true,"font":"","fontSize":16,"color":"#ffbb00","x":1440,"y":660,"wires":[]},{"id":"909f0fa3f4147ede","type":"ui_template","z":"dc14bd796219d9ad","g":"e5111d27ef0bf43d","group":"6bdf3420903b72e3","name":"Dashboard Theme : HaCeSOFT","order":6,"width":6,"height":1,"format":"<style>\n    :root {\n        --accent: red;\n        --background-color: #3c3c3c;            /* pozadi v kartach a mezerach */\n        --background: #2e2d2d;                  /* pozadi pod LABELem */\n        --barva-textu: #cccbc8;                 /* barva textu */\n        --color_border: #004f4b;\n        --color_pozadi_switche_on: #bc981f;     /* barva pozadi posuvneho prepinace, aktivni stav */\n        --color_pozadi_switche_off: #bc981f;    /* barva pozadi posuvneho prepinace, neaktivni stav */\n        --color_switche_on: green;              /* barva zapnuteho prepinace */\n        --color_switche_off: #cc6a00;           /* barva vypnuteho prepinace */\n        --color_sub_menu: grey;                 /* barva submenu nakarte REAL DAT, SPOT atd */\n        --color_ind_on: #32cd32;                /*barva indicator fan zalena - on */\n        --color_ind_off: grey;                  /*barva indicator fan seda - OFF */\n        --font-family: Arial, Helvetica, sans-serif;\n        --margin: 0;\n        --menu-background: #ffffff;\n        --menu-color: #111111;\n        --okraj-karty: #504f4b;                 /* barva okraje karty */\n        --on-background: #4790d0;\n        --on-primary: #faf9f5;\n        --on-surface: #faf9f5;\n        --padding: 0;\n        --primary: var(--nr-dashboard-widgetColor);\n        --radius-s: 9px;                        /* hodnota zakulaceni okraju, pokud je funkce povolene */\n        --secondary: var(--nr-dashboard-groupTextColor);\n        --surface: #373737;                     //zahlavi a pozadi zmenovych inputu se sipkama nahotu a dolu\n        --inputs: red;                          //zahlavi a pozadi zmenovych inputu se sipkama nahotu a dolu\n        /* další proměnné dle potřeby */\n    }\n\n    body {\n        background-color: var(--background-color);\n        color: var(--barva-textu);\n        font-family: var(--font-family);\n        margin: var(--margin);\n        padding: var(--padding);\n    }\n\n    body.nr-dashboard-theme {\n        background-color: var(--background);\n        font-family: var(--font-family);\n    }\n\n    body.nr-dashboard-theme md-content md-card {\n        background-color: var(--background-color);\n        color: var(--barva-textu);\n    }\n\n    body.nr-dashboard-theme md-sidenav {\n        background-color: var(--surface);\n    }\n\n    body.nr-dashboard-theme md-toolbar {\n        background-color: var(--surface);\n    }\n\n    /* Calendar and Date picker */\n    .md-calendar,\n    .md-datepicker-calendar,\n    .md-default-theme .md-calendar,\n    .md-default-theme .md-datepicker-calendar {\n        background-color: var(--surface);\n        color: var(--on-surface);\n    }\n\n    .md-datepicker-calendar-pane,\n    .md-default-theme .md-datepicker-calendar-pane {\n        border: 0;\n    }\n\n    .md-datepicker-input,\n    .md-default-theme .md-datepicker-input,\n    .md-default-theme .md-calendar-month-label md-icon,\n    .md-datepicker-calendar-pane,\n    .md-default-theme .md-calendar-month-label md-icon {\n        color: var(--on-surface);\n    }\n\n    md-card,\n    md-card.md-default-theme {\n        border-radius: 0;\n        /* Zakulacení rohů odstraněno */\n    }\n\n    md-list-item .md-list-item-inner,\n    md-list-item._md-button-wrap>div.md-button:first-child {\n        background-color: var(--inputs);\n    }\n\n\n    .nr-dashboard-template {\n        padding: var(--padding); \n    }\n\n    /* Chart */\n    .nr-dashboard-theme .nr-dashboard-chart {\n        color: var(--on-surface);\n    }\n\n    .nr-dashboard-theme ui-card-panel p.nr-dashboard-cardtitle {\n    color: var(--color_sub_menu); \n    }\n\n    .nr-dashboard-theme .nr-dashboard-chart-container {\n        color: var(--on-surface);\n    }\n\n    .nr-dashboard-theme .nr-dashboard-chart-title {\n        color: var(--on-surface);\n    }\n\n    /* Dropdown */\n    .nr-dashboard-theme .nr-dashboard-dropdown .md-select-icon {\n        color: var(--on-surface);\n    }\n\n    .nr-dashboard-theme .nr-dashboard-switch md-switch.md-checked .md-bar {/* aktivni stav - pozadi prepinace */\n        background-color: var(--color_pozadi_switche_on);\n    }\n\n    .nr-dashboard-theme .nr-dashboard-switch md-switch .md-bar {/*neaktivni stav - pozadi prepinace */\n        background-color: var(--color_pozadi_switche_off);\n    }\n\n    .nr-dashboard-theme .nr-dashboard-switch md-switch.md-checked .md-thumb {/* aktivni stav - barva přepinace */\n        background-color: var(--color_switche_on);\n    }\n\n    .nr-dashboard-theme .nr-dashboard-switch md-switch .md-thumb {/*neaktivni stav - barva prepinace */\n        background-color: var(--color_switche_off);\n    }\n\n    .nr-dashboard-theme .nr-dashboard-dropdown md-select .md-select-value,\n    .nr-dashboard-theme .nr-dashboard-dropdown md-select .md-select-value.md-select-placeholder {\n        color: var(--on-surface);\n    }\n\n    .nr-dashboard-theme md-select-menu,\n    .nr-dashboard-theme md-select-menu md-option {\n        background-color: var(--surface);\n        color: var(--on-surface);\n    }\n\n    .nr-dashboard-theme md-select-menu md-option[selected] {\n        background-color: var(--surface) !important;\n        color: #1bbfff !important;\n    }\n\n    /* Date picker */\n    .nr-dashboard-theme .nr-dashboard-date-picker md-input-container .md-input {\n        color: var(--on-surface);\n    }\n\n    .nr-dashboard-theme .nr-dashboard-date-picker .md-datepicker-triangle-button .md-datepicker-expand-triangle {\n        border-top-color: #1d85fc;\n    }\n\n    /* Zmenšení mezer mezi prvky */\n    .nr-dashboard-theme .nr-dashboard-text {\n        margin-bottom: 5px;\n        /* Zmenšení spodního okraje mezi texty */\n    }\n\n    .nr-dashboard-theme .nr-dashboard-button .md-button {\n        background-color: var(--primary);\n        color: var(--on-primary);\n        line-height: inherit;\n    }\n\n    .nr-dashboard-theme .nr-dashboard-button .md-button:hover {\n        background-color: var(--secondary);\n    }\n\n    .nr-dashboard-theme .nr-dashboard-button .md-button ui-icon {\n        margin-bottom: 8px;\n    }\n\n    .nr-dashboard-theme [ui-card-size=\"2x2\"].nr-dashboard-button .md-button {\n        align-items: center;\n        display: flex;\n        flex-direction: column;\n        justify-content: center;\n        white-space: pre-line;\n    }\n\n    .nr-dashboard-theme .nr-dashboard-cardpanel {\n        margin: var(--margin);\n        padding: var(--padding);\n    }\n\n    .nr-dashboard-theme .nr-dashboard-date-picker md-input-container .md-input {\n        color: var(--on-surface);\n    }\n\n    .nr-dashboard-theme .nr-dashboard-gauge-titlel {\n        font-weight: var(--font-weight-l) !important;\n    }\n\n    .nr-dashboard-theme .nr-dashboard-numeric .value {\n        background-color: var(--surface);\n        color: var(--on-surface);\n    }\n\n    .nr-dashboard-theme .nr-dashboard-template {\n        background-color: var(--surface);\n    }\n\n    .nr-dashboard-theme .nr-dashboard-textinput md-input-container.md-input-has-value label {\n        color: #5d5e5f;\n    }\n\n    .nr-dashboard-theme md-select-menu {\n        background-color: var(--surface);\n        color: var(--on-surface);\n    }\n\n    .nr-dashboard-theme md-menu-content {\n        background-color: var(--menu-background);\n        color: var(--menu-color);\n    }\n\n    .nr-dashboard-theme md-menu-content md-menu-item {\n        background-color: var(--menu-background);\n        color: var(--menu-color);\n    }\n\n    /* Kulatění rohů */\n    .Kulati_Dole {\n     //   border-bottom-left-radius: var(--radius-s);\n     //   border-bottom-right-radius: var(--radius-s);\n    }\n\n    .Kulati_Nahore {\n     //   border-top-left-radius: var(--radius-s);\n     //   border-top-right-radius: var(--radius-s);\n    }\n\n    .label_time{\n        color: #aaaaaa;\n        font-size: 13px;\n    }\n</style>","storeOutMessages":true,"fwdInMessages":true,"resendOnRefresh":false,"templateScope":"global","className":"","x":710,"y":140,"wires":[[]],"icon":"node-red-dashboard/ui_colour_picker.png","info":"# Modern Dark Theme for node-red-dashboard\n\nInspired by Victor Lucachi with his [Node Red Dashboard Concept](https://dribbble.com/shots/10356530-Node-Red-Dashboard-Concept) on Dribbble. Thank you for your work.\n\n## Customize\n\n1. Go on dashboard customisation tab (At the right of Debug Console).\n2. Select the style `Dark`.\n3. Pick the color you want. Example `#66B5F8`\n\n## Buttons\n\nUse `2x2` size for buttons with icon and text on the screenshot"},{"id":"5dbba70ddd44d673","type":"debug","z":"dc14bd796219d9ad","g":"e5111d27ef0bf43d","name":"debug 9","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"","statusType":"counter","x":560,"y":100,"wires":[]},{"id":"8f10bed02dbe3b9b","type":"ui_template","z":"dc14bd796219d9ad","d":true,"g":"e5111d27ef0bf43d","group":"eff8c2fb7917b0ab","name":"Linea_CCS","order":26,"width":0,"height":0,"format":"<style>\n    body {\n        --margin: 0;\n        --padding: 0;\n        --font-family: Arial, Helvetica, sans-serif;\n        --background-color: #3c3c3c;    // pozadi v kartach amererach\n        --background: #2e2d2d;          // pozadi pod LABELem\n        --color: #faf9f5;\n        --barva-textu: #cccbc8;         //barva textu \n        --color_border: #004f4b;\n        --on-background: #4790d0;\n        --on-surface: #faf9f5;\n        --on-primary: #faf9f5;\n        --surface: #373737;\n        --okraj-karty: #504f4b;         //barva okraje karty\n        --primary: var(--nr-dashboard-widgetColor);\n        --secondary: var(--nr-dashboard-groupTextColor);\n        --accent: red;\n        --radius-s: 9px;                //hodnota zakulaceni okraju, pokud je funkce povolene\n        //--nr-dashboard-widgetTextColor: var(--on-primary);\n    }\n\n    body.nr-dashboard-theme md-content md-card {\n        background-color: var(--background-color);\n        color: var(--barva-textu);\n    }\n\n    body.nr-dashboard-theme {\n        background-color: var(--background);\n        font-family: var(--font-family);\n    }\n\n    .nr-dashboard-theme .nr-dashboard-template {\n        background-color: var(--surface);\n    }\n\n    .nr-dashboard-theme ui-card-panel {\n        background-color: var(--background);\n        border: 2px solid var(--okraj-karty);      //nastaveni okraje karet\n    }\n\n    .nr-dashboard-theme .nr-dashboard-button .md-button {\n        background-color: var(--primary);\n        line-height: inherit;\n        color: var(--on-primary);\n    }\n\n    .nr-dashboard-theme [ui-card-size=\"2x2\"].nr-dashboard-button .md-button {\n        display: flex;\n        flex-direction: column;\n        justify-content: center;\n        align-items: center;\n        white-space: pre-line;\n    }\n\n    .nr-dashboard-theme .nr-dashboard-button .md-button ui-icon {\n        margin-bottom: 8px;\n    }\n\n    .nr-dashboard-theme .nr-dashboard-button .md-button:hover {\n        background-color: var(--secondary);\n    }\n\n    md-card.md-default-theme,\n    md-card {\n        //border-radius: 0; /* Zakulacení rohů odstraněno */\n    }\n\n    .nr-dashboard-theme .nr-dashboard-gauge-titlel {\n        font-weight: var(--font-weight-l) !important;\n    }\n\n    .nr-dashboard-theme ui-card-panel p.nr-dashboard-cardtitle {\n        font-weight: var(--font-weight-l);\n        text-transform: capitalize;\n        color: var(--on-background);\n    }\n\n    .nr-dashboard-cardpanel>p {\n        margin-left: 0;\n        padding-left: 8px; /* Zmenšená výplň */\n    }\n\n    body.nr-dashboard-theme md-toolbar {\n        background-color: var(--surface);\n    }\n\n    /* Calendar and Date picker */\n    .md-default-theme .md-datepicker-calendar,\n    .md-datepicker-calendar,\n    .md-default-theme .md-calendar,\n    .md-calendar {\n        background-color: var(--surface);\n        color: var(--on-surface);\n    }\n\n    .md-default-theme .md-datepicker-calendar-pane,\n    .md-datepicker-calendar-pane {\n        border: 0;\n    }\n\n    .md-default-theme .md-calendar-month-label md-icon,\n    .md-calendar-month-label md-icon,\n    .md-default-theme .md-datepicker-input,\n    .md-datepicker-input {\n        color: var(--on-surface);\n    }\n\n    .nr-dashboard-theme .nr-dashboard-date-picker md-input-container .md-input {\n        color: var(--on-surface);\n    }\n\n    .nr-dashboard-theme .nr-dashboard-numeric .value {\n        background-color: var(--surface);\n        color: var(--on-surface);\n    }\n\n    .nr-dashboard-theme md-select-menu {\n        background-color: var(--surface);\n        color: var(--on-surface);\n    }\n\n    .nr-dashboard-textinput md-input-container .md-input,\n    .nr-dashboard-theme md-input-container.md-default-theme .md-input,\n    md-input-container .md-input {\n        color: var(--on-surface);\n    }\n\n    .nr-dashboard-theme .nr-dashboard-textinput md-input-container.md-input-has-value label {\n        color: #5d5e5f;\n    }\n\n    /* Dropdown */\n    .nr-dashboard-theme .nr-dashboard-dropdown md-select .md-select-value,\n    .nr-dashboard-theme .nr-dashboard-dropdown md-select .md-select-value.md-select-placeholder {\n        color: var(--on-surface);\n        //border-color: #1d85fc;\n    }\n\n    .nr-dashboard-theme .nr-dashboard-dropdown .md-select-icon {\n        color: var(--on-surface);\n    }\n\n    .nr-dashboard-theme md-select-menu,\n    .nr-dashboard-theme md-select-menu md-option {\n        background-color: var(--surface);\n        color: var (--on-surface);\n    }\n\n    .nr-dashboard-theme md-select-menu md-option[selected] {\n        color: #1bbfff !important;\n        background-color: var(--surface) !important;\n    }\n\n    .nr-dashboard-theme md-menu-content {\n        background-color: #ffffff;\n        color: #111111;\n    }\n\n    .nr-dashboard-theme md-menu-content md-menu-item {\n        background-color: #ffffff;\n        color: #111111;\n    }\n\n    /* Date picker */\n    .nr-dashboard-theme .nr-dashboard-date-picker md-input-container .md-input {\n        color: var(--on-surface);\n        //border-color: #1d85fc;\n    }\n\n    .nr-dashboard-theme .nr-dashboard-date-picker .md-datepicker-triangle-button .md-datepicker-expand-triangle {\n        border-top-color: #1d85fc;\n    }\n\n    body.nr-dashboard-theme md-sidenav {\n        background-color: var(--surface);\n    }\n\n    md-list-item._md-button-wrap>div.md-button:first-child,\n    md-list-item .md-list-item-inner {\n        background-color: var(--surface);\n    }\n\n    /* Chart */\n    .nr-dashboard-theme .nr-dashboard-chart-title {\n        color: var(--on-surface);\n        //border-color: #1d85fc;\n    }\n\n    .nr-dashboard-theme .nr-dashboard-chart-container {\n        color: var(--on-surface);\n        //border-color: #1d85fc;\n    }\n\n    .nr-dashboard-theme .nr-dashboard-chart {\n        color: var(--on-surface);\n        //border-color: #1d85fc;\n    }\n\n    /* Kulatění rohů */\n    .Kulati_Nahore {\n       // border-top-left-radius: var(--radius-s);\n       // border-top-right-radius: var(--radius-s);\n    }\n\n    .Kulati_Dole {\n       // border-bottom-left-radius: var(--radius-s);\n       // border-bottom-right-radius: var(--radius-s);\n    }\n\n    /* Zmenšení mezer mezi prvky */\n    .nr-dashboard-theme .nr-dashboard-text {\n        margin-bottom: 5px; /* Zmenšení spodního okraje mezi texty */\n    }\n\n    /* Zmenšení okrajů a výplní karet */\n    .nr-dashboard-theme .nr-dashboard-cardpanel {\n        padding: 0px;\n        margin: 0px;\n    }\n\n\n</style>\n","storeOutMessages":true,"fwdInMessages":true,"resendOnRefresh":true,"templateScope":"global","className":"","x":390,"y":100,"wires":[["5dbba70ddd44d673"]]},{"id":"abaebf4fb42da20d","type":"inject","z":"dc14bd796219d9ad","g":"48de5eb1ca74eafc","name":"","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payload":"","payloadType":"date","x":460,"y":1260,"wires":[["97f2b4c61f843634","79fee107e7a6a7ff"]]},{"id":"2823d9b0dfcce47f","type":"ui_chart","z":"dc14bd796219d9ad","g":"1b84d1ab8eb2c216","name":"","group":"18637dcfe1e79007","order":2,"width":"20","height":"15","label":"Dnešní statistika spotřeby","chartType":"line","legend":"true","xformat":"HH","interpolate":"monotone","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":"1","removeOlderPoints":"","removeOlderUnit":"3600","cutout":0,"useOneColor":false,"useUTC":false,"colors":["#f7ab3e","#fa717f","#0084ff","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"outputs":1,"useDifferentColor":false,"className":"","x":2190,"y":640,"wires":[[]]},{"id":"9ddbec260baed1ae","type":"debug","z":"dc14bd796219d9ad","g":"1b84d1ab8eb2c216","name":"DATA_GRAF","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":2170,"y":580,"wires":[]},{"id":"95b1ec484d912acd","type":"function","z":"dc14bd796219d9ad","g":"1b84d1ab8eb2c216","name":"Parse_DATA_graf","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> haceSoft 2024\n// Created          : 14-07-2024, 11:00\n// Revised          : 24-09-2024, 18:24\n// Version          : 2.1\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uvedený jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 haceSoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n// Konfigurační proměnná pro výběr intervalu\nconst intervalType = global.get('intervalType'); // Může být \"hours\" nebo \"15mins\"\n\n// Definice globalních funkcí\nconst fWrite_LogFile = global.get('fWrite_LogFile');\nconst removeSpacesAroundDots = global.get('removeSpacesAroundDots');\nconst sExtractTime = global.get('sExtractTime');\nconst sCounty_Code = global.get('sCounty_Code');\nconst sTZidentifier = global.get('sTZidentifier');\n\n\n// Konfigurace sérií\n// Konfigurační objekt seriesConfig: Konfigurace sérií je definována jedním objektem, což usnadňuje přidávání, \n// odstraňování nebo modifikaci jednotlivých sérií.\n// name - urcuje jmeno ktere se bude hleted v nactenych datech z VRM API.\n// type - urcuje chovani krivky, real bude na konci ukoncena v prostoru a forecast bude tak jak prijdou data.\n// sign - urcuje zda bude vykreslena na kladne strane a nebo zaporne strane grafu (pod čarou).\n// scale - urcuje meritko robrazeni.\n// color - definuje se barva primky - asi nefunguje\n// smootch - true urcuje zda bude bude křivka vyhlazena pomocí pohyblivého průměru.\n// api - urcuje odkud se maji brat data : global.get(\"sAPI_live_feed\")  nebo global.get(\"sAPI_forecast\")\n\nconst seriesConfig = [\n    { name: \"grid_history_to\", label: \"Grid History To\", type: \"real\", sign: false, scale: 1, color: \"#FF0000\", smooth: false, api: \"live_feed\" },\n    { name: \"grid_history_from\", label: \"Grid History From\", type: \"real\", sign: false, scale: 1, color: \"#00ff00\", smooth: false, api: \"live_feed\" },\n    { name: \"total_consumption\", label: \"Total Consumption\", type: \"real\", sign: true, scale: 1, color: \"#0000FF\", smooth: false, api: \"live_feed\" },\n    { name: \"total_solar_yield\", label: \"Total Solar Yield\", type: \"real\", sign: true, scale: 0.01, color: \"#FFFF00\", smooth: false, api: \"live_feed\" },\n    { name: \"vrm_consumption_fc\", label: \"VRM Consumption Forecast\", type: \"forecast\", sign: true, scale: 0.001, color: \"#FF00FF\", smooth: true, api: \"forecast\" },\n    { name: \"solar_yield_forecast\", label: \"Solar Yield Forecast\", type: \"forecast\", sign: true, scale: 0.001, color: \"#00FFFF\", smooth: true, api: \"forecast\" },\n    { name: \"Pdc\", label: \"Pdc\", type: \"real\", sign: true, scale: 0.001, color: \"#8A2BE2\", smooth: false, api: \"live_feed\" },\n    { name: \"bs\", label: \"Battery State\", type: \"real\", sign: true, scale: 0.01, color: \"#A52A2A\", smooth: false, api: \"live_feed\" },\n    { name: \"bv\", label: \"Battery Voltage\", type: \"real\", sign: true, scale: 0.01, color: \"#5F9EA0\", smooth: false, api: \"live_feed\" },\n];\n\n// Inicializace sérií a popisků\nlet series = [], labels = [];\ninitializeSeriesAndLabels(); //Inicializace pole\nfillZerosUntilNowInSeries(); // Inicializace pole podle aktualního času.\n\n// Načtení dat do globálních proměnných, které jsou dostupné mezi flow\nconst nBuffer_live_feed = global.get(\"sAPI_live_feed\") || {}; // config.api === \"live_feed\"\nconst nBuffer_forecast = global.get(\"sAPI_forecast\") || {}; // config.api === \"forecast\"\n\n// Kontrola, zda nBuffer_live_feed.records existuje\nif (nBuffer_live_feed.records && nBuffer_forecast.records) {\n    // Zpracování dat pro každou sérii na základě konfigurace\n    seriesConfig.forEach((config, index) => {\n        let records;\n        if (config.api === \"live_feed\") {\n            records = nBuffer_live_feed.records[config.name];\n        } else if (config.api === \"forecast\") {\n            records = nBuffer_forecast.records[config.name];\n        }\n        processSeries(records, series[index], config.sign, config.scale, config.type);\n\n        // Aplikace vyhlazování, pokud je zapnuto\n        if (config.smooth) {\n            series[index] = smoothData(series[index]); // Aplikace vyhlazování\n            //fWrite_LogFile(\"serie: \", series[index]);\n        }\n    });\n\n    // Vytvoření výstupního formátu\n    msg.payload = [{\n        \"series\": seriesConfig.map(s => s.label),\n        \"data\": series,\n        \"labels\": labels,\n        \"colors\": seriesConfig.map(s => s.color),\n        \"lines\": Array(seriesConfig.length).fill(true)\n    }];\n} else {\n    if (debug) {\n        node.warn(\"nBuffer.records nebo jeho některé části neexistují nebo nejsou pole.\");\n    }\n}\n\n// Debugging\nif (debug) {\n    node.warn(\"intervalType: \" + intervalType);\n    node.warn(\"series: \" + JSON.stringify(series));\n    node.warn(\"labels: \" + JSON.stringify(labels));\n}\n\nreturn msg;\n\n// Funkce pro inicializaci sérií a popisků\n// Funkce inicializuje potrebne pole. Pole series je inicializovano s hodnotou NULL\nfunction initializeSeriesAndLabels() {\n    const intervalCount = intervalType === \"15mins\" ? 96 : 24;\n    series = Array(seriesConfig.length).fill().map(() => Array(intervalCount).fill(null));\n\n    labels = Array.from({ length: intervalCount }, (_, i) => {\n        const hours = String(Math.floor(i / (intervalType === \"15mins\" ? 4 : 1))).padStart(2, '0');\n        const minutes = intervalType === \"15mins\" ? String((i % 4) * 15).padStart(2, '0') : \"00\";\n        return `${hours}:${minutes}`;\n    });\n}\n\n// Funkce pro doplnění hodnot 0 od 00:00 do aktuálního času v globálním poli series\n// Funkce zjisti aktualni cas, a co je od daného času do minulosti je 0 a zbytek zustane NULL, tím se zajisti, že realná data nebudou staženy do 0 kdýt nejdou v té době známě hodnoty,\n// Ale budou nedokončena\nfunction fillZerosUntilNowInSeries() {\n    const now = new Date();\n\n    // Získání lokalizovaného času (CZ lokalizace)\n    const oTimeCZ = now.toLocaleString(sCounty_Code, { timeZone: sTZidentifier });\n    //node.warn(\"Localized time string: \" + oTimeCZ);\n\n    // Extrahování času z řetězce podle aktuálního formátu\n    const timePart = oTimeCZ.match(/\\d{1,2}:\\d{2}/); // Vyhledá formát HH:MM\n    if (timePart) {\n        const timeParts = timePart[0].split(':');  // Rozdělení na hodiny a minuty\n        const currentHours = parseInt(timeParts[0], 10);   // Hodiny\n        const currentMinutes = parseInt(timeParts[1], 10); // Minuty\n\n       // node.warn(`Current time in TZ: ${currentHours}:${currentMinutes}`);\n\n        // Výpočet aktuálního indexu v poli podle času\n        const intervalsPerHour = intervalType === \"15mins\" ? 4 : 1;\n        const currentIntervalIndex = currentHours * intervalsPerHour + Math.floor(currentMinutes / (60 / intervalsPerHour));\n\n        // Procházení celého pole series a doplnění hodnoty 0 od 00:00 do aktuálního času\n        series.forEach((seriesData, seriesIndex) => {\n            for (let i = 0; i <= currentIntervalIndex; i++) {\n                if (seriesData[i] === null) {\n                    seriesData[i] = 0; // Nahrazení null hodnotou 0\n                }\n            }\n\n            // Výpis upraveného pole do logu po každém průchodu\n            //node.warn(`series[${seriesIndex}]: ${JSON.stringify(seriesData)}`);\n        });\n    } else {\n        //node.error(\"Error: Unable to extract time from localized string.\");\n    }\n}\n\n\n// Pomocná funkce pro získání indexu intervalu z timestampu\nfunction getIntervalIndex(timestamp) {\n    const date = new Date(timestamp);\n    //prevest na aktualní časové pásmo.\n    \n    const hours = date.getHours();\n    const minutes = date.getMinutes();\n    if (intervalType === \"15mins\") {\n        return hours * 4 + Math.floor(minutes / 15);\n    } else if (intervalType === \"hours\") {\n        return hours;\n    }\n    return 0; // default index if none matched\n}\n\n// Pomocná funkce pro zpracování hodnot s ohledem na znaménko\nfunction processValue(value, isPositive, scale) {\n    let processedValue = parseFloat(value) * scale;\n    return isPositive ? processedValue : -processedValue;\n}\n\nfunction interpolateData(data) {\n    const interpolatedData = [...data];  // Kopie dat pro manipulaci\n    let lastKnownValue = null;\n    let startIndex = null;\n\n    // Najdi první známou hodnotu (není null, undefined nebo 0)\n    for (let i = 0; i < data.length; i++) {\n        if (data[i] !== null && data[i] !== undefined && data[i] !== 0) {\n            lastKnownValue = parseFloat(data[i]);\n            startIndex = i;\n            break;\n        }\n    }\n\n    // Procházej zbytek dat a interpoluj pouze hodnoty null, undefined nebo 0\n    for (let i = startIndex + 1; i < data.length; i++) {\n        if (data[i] !== null && data[i] !== undefined && data[i] !== 0) {\n            const nextKnownValue = parseFloat(data[i]);\n            const step = (nextKnownValue - lastKnownValue) / (i - startIndex);\n            for (let j = startIndex + 1; j < i; j++) {\n                interpolatedData[j] = (lastKnownValue + step * (j - startIndex)).toFixed(2);\n            }\n            lastKnownValue = nextKnownValue;\n            startIndex = i;\n        }\n    }\n\n    return interpolatedData;\n}\n\n\n// Vylepšená funkce pro vyhlazení dat\nfunction smoothData(data, windowSize = 2) {\n    const smoothedData = [];\n    for (let i = 0; i < data.length; i++) {\n        const start = Math.max(0, i - windowSize);\n        const end = Math.min(data.length, i + windowSize + 1);\n        const windowData = data.slice(start, end).filter(v => v !== null);\n\n        const sum = windowData.reduce((acc, val) => acc + parseFloat(val), 0);\n        const avg = windowData.length ? (sum / windowData.length).toFixed(2) : null;\n        smoothedData.push(avg);\n    }\n    return smoothedData;\n}\n\nfunction processSeries(records, seriesData, isPositive, scale, type) {\n    if (Array.isArray(records)) {\n        records.forEach(item => {\n            if (item && item[0] && item[1]) {\n                const index = getIntervalIndex(item[0]);\n                const value = parseFloat(item[1]);\n                if (type === \"real\") {\n                        if (value !== null && value !== undefined) {\n                            seriesData[index] = processValue(value, isPositive, scale).toFixed(2);\n                    } else {\n                          seriesData[index] = null;\n                    }\n                } else if (type === \"forecast\") {\n                    if (value !== null && value !== undefined) {\n                        seriesData[index] = processValue(value, isPositive, scale).toFixed(2);\n                    } else {\n                        seriesData[index] = null;\n                    }\n                }\n            }\n        });\n        // Aplikovat interpolaci jen pokud type === \"forecast\"\n        if (type === \"forecast\") {\n            // Po zpracování celé série aplikujeme interpolaci chybějících dat (null a undefined)\n            const interpolatedSeriesData = interpolateData(seriesData);\n\n            // Uložení interpolovaných dat zpět do series[index]\n            seriesData.splice(0, seriesData.length, ...interpolatedSeriesData);\n        }\n    }\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1930,"y":600,"wires":[["9ddbec260baed1ae","2823d9b0dfcce47f"]]},{"id":"e125373b24fcca21","type":"ui_button","z":"dc14bd796219d9ad","g":"1b84d1ab8eb2c216","name":"","group":"18637dcfe1e79007","order":13,"width":0,"height":0,"passthru":false,"label":"button","tooltip":"","color":"","bgcolor":"","className":"","icon":"","payload":"1","payloadType":"num","topic":"topic","topicType":"msg","x":1730,"y":620,"wires":[["95b1ec484d912acd"]]},{"id":"85170cc176fe9ecd","type":"comment","z":"dc14bd796219d9ad","name":"https://nodered.org/docs/getting-started/docker","info":"https://nodered.org/docs/getting-started/docker","x":210,"y":20,"wires":[]},{"id":"e7abeb99abbcadac","type":"ui_text","z":"dc14bd796219d9ad","g":"1a9d21242a01ebdd","group":"eff8c2fb7917b0ab","order":21,"width":6,"height":1,"name":"Nabijeni baterie","label":"{{msg.power}}","format":"<font color={{fcolor}}>{{msg.payload.nBattery_Power}} W","layout":"row-spread","className":"","style":false,"font":"","fontSize":16,"color":"#000000","x":1460,"y":880,"wires":[]},{"id":"440fdfb71d3c952e","type":"ui_text","z":"dc14bd796219d9ad","g":"1a9d21242a01ebdd","group":"eff8c2fb7917b0ab","order":22,"width":6,"height":1,"name":" Prout baterie","label":"{{msg.current}}","format":"<font color={{fcolor}}>{{msg.payload.nBattery_Current}} A","layout":"row-spread","className":"","style":false,"font":"","fontSize":16,"color":"#000000","x":1450,"y":920,"wires":[]},{"id":"f85e8528950ff714","type":"ui_text","z":"dc14bd796219d9ad","g":"1a9d21242a01ebdd","group":"eff8c2fb7917b0ab","order":23,"width":6,"height":1,"name":"","label":"Napětí baterie","format":"<font color={{fcolor}}>{{msg.payload.nBattery_Voltage}} V","layout":"row-spread","className":"","style":false,"font":"","fontSize":16,"color":"#000000","x":1462,"y":959,"wires":[]},{"id":"eb2aebb66e80d341","type":"function","z":"dc14bd796219d9ad","g":"e5111d27ef0bf43d","name":"** GLOBAL FUNCTION **","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2025\n// Created          : 21-10-2023, 11:00\n// Revised          : 09-02-2025, 15:56\n// Version          : 1.30\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2025 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n\n//Definice timezone and Country code\n//LIST CODES: https://en.wikipedia.org/wiki/List_of_tz_database_time_zones\nconst sCounty_Code = \"cs-CZ\";\nconst sTZidentifier = \"Europe/Prague\";\n\n// Konfigurační proměnná pro výběr intervalu\nconst intervalType = \"15mins\"; // Může být \"hours\" nebo \"15mins\"\n//*****************************************************************************\n//Definice cesty ke konfiguraci\nconst filename = \"config_hacesoft.json\" // nazev konfiguracniho souboru\nconst log_file_name = \"_log_file.txt\" // nazev logovaciho souboru\nconst defaultConfig = \"config_default.json\" // nazev defaultni konfigurace\n\nconst filename_paths = [\n    `/data/home/nodered/.node-red/node_modules/`,\n    `/data/node_modules/`\n];\n\nglobal.set(\"startTime\", Date.now()); //definice času pro funkci UPTIME\n//*****************************************************************************\nconst config = {\n    oVersion: \"09022025:1557\",\n    spotTresholdPrice: 1.04,\n    isSpotAutoCtrlEnabled: true,\n    nGridConsumptionEnable: false,\n    switchDelayCharging: false,\n    nMorningPeakBatterySales: false,\n    nEveningPeakBatterySales: false,\n    tStartBattery: 16200000,\n    tStopBattery: 39600000,\n    nMorningSOC_sales: 38,\n    nEveningSOC_sales: 95,\n    nSetGridValue: -100,\n    nMAX_Grid_Point: -4000,\n    nBalancingReserve: 230,\n    sGridChargingSwitch: false,\n    nGridChargingSOC: 90,\n    sIpAddress_m: '172.16.10.9',\n    sIpAddress_ch: '172.16.10.7',\n    sIpAddress_boiler: '172.16.10.8',\n    nVRM_site_id: 0,\n    username_VRM: 'muj@mail.com',\n    name_instalation: 'Moje_Instalece',\n    bearerToken: 'VRM_TOKEN',\n    deposit_Token: 'deposit_TOKEN',\n    connectorConfig: {\n        tcpHost: \"172.16.10.2\",  //'tcpHost'\n        tcpPort: \"502\",          //'tcpPort'\n        unitId: 100              //'unitId'\n    }\n};\n\n//*****************************************************************************\n// Uložení konfigurace do globální proměnné\nglobal.set(\"config\", config);\nglobal.set(\"intervalType\", intervalType);\n\nglobal.set(\"filename\", filename);\nglobal.set(\"defaultConfig\", defaultConfig);\nglobal.set(\"log_file_name\", log_file_name);\n\nglobal.set('sCounty_Code', sCounty_Code);\nglobal.set('sTZidentifier', sTZidentifier);\nglobal.set(\"backup_filename_paths\", [...filename_paths]);  // Záložní kopie\nglobal.set(\"current_filename_paths\", [...filename_paths]); // Pracovní kopie\n\n//*****************************************************************************\n\n// Funkce vracející začátek dne (00:00:00)\nglobal.set('getStartOfDayTimestamp', function getStartOfDayTimestamp() {\n    let now = new Date(); // Dnešní datum\n    let formatter = new Intl.DateTimeFormat('en-US', {\n        timeZone: sTZidentifier,\n        year: 'numeric',\n        month: 'numeric',\n        day: 'numeric',\n    });\n\n    // Naformátujeme na datum ve správném časovém pásmu\n    let parts = formatter.formatToParts(now);\n    let year = parseInt(parts.find(part => part.type === 'year').value, 10);\n    let month = parseInt(parts.find(part => part.type === 'month').value, 10) - 1;\n    let day = parseInt(parts.find(part => part.type === 'day').value, 10);\n\n    // Vytvoříme začátek dne\n    let startOfDay = new Date(year, month, day, 0, 0, 0);\n\n    // Vrátíme timestamp v sekundách\n    return Math.floor(startOfDay.getTime() / 1000);\n});\n\n//*****************************************************************************\n// Funkce vracející konec dne (23:59:59)\nglobal.set('getEndOfDayTimestamp', function getEndOfDayTimestamp() {\n    let now = new Date(); // Dnešní datum\n    let formatter = new Intl.DateTimeFormat('en-US', {\n        timeZone: sTZidentifier,\n        year: 'numeric',\n        month: 'numeric',\n        day: 'numeric',\n    });\n\n    // Naformátujeme na datum ve správném časovém pásmu\n    let parts = formatter.formatToParts(now);\n    let year = parseInt(parts.find(part => part.type === 'year').value, 10);\n    let month = parseInt(parts.find(part => part.type === 'month').value, 10) - 1;\n    let day = parseInt(parts.find(part => part.type === 'day').value, 10);\n\n    // Vytvoříme konec dne\n    let endOfDay = new Date(year, month, day, 23, 59, 59);\n\n    // Vrátíme timestamp v sekundách\n    return Math.floor(endOfDay.getTime() / 1000);\n});","outputs":1,"timeout":0,"noerr":0,"initialize":"//*****************************************************************************\n//\n// File Name        : 'GLOBAL_FUNCTION'\n// Title            : GLOBALNI FUNKCE\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 14-07-2024, 12:42\n// Revised          : 25-07-2024, 09:37\n// Version          : 1.01\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n\n//const sCounty_Code = global.get('sCounty_Code');\n//const sTZidentifier = global.get('sTZidentifier');\n\n//*****************************************************************************\n//Funkce je napsána tak, aby byla robustní a zvládala chyby, což zajišťuje, že nedojde\n// k neočekávaným chybám při zpracování časových razítek.\nglobal.set('convertUnixTimestamp', function(inputTime, debug = true) {\n    try {\n        if (isNaN(inputTime)) {\n            if (debug) { node.error(\"Invalid time format: \" + inputTime);}\n            return null;\n        }\n        let date = new Date(parseInt(inputTime));\n        if (isNaN(date.getTime())) {\n            if (debug) { node.error(\"Constructed date is invalid.\");}\n            return null;\n        }\n        return date.getTime();\n    } catch (error) {\n        node.error(\"Error: \" + error.message);\n        return null;\n    }\n});\n\n//*****************************************************************************\n//dotaz na data z globalniho obektu\n//priklad: const tcpHost = getConfigProperty(\"connectorConfig.tcpHost\");\nglobal.set('getConfigProperty', function (propertyPath) {\n    let config = global.get(\"config\") || {};\n    return propertyPath.split('.').reduce((o, p) => (o ? o[p] : undefined), config);\n});\n\n//*****************************************************************************\n//ulozi data do globalniho obektu\n//priklad: setConfigProperty(\"connectorConfig.tcpHost\", \"192.168.50.250\");\nglobal.set('setConfigProperty',function (propertyPath, value) {\n    let config = global.get(\"config\") || {};\n    let schema = config;  // a moving reference to internal objects within config\n    let pList = propertyPath.split('.');\n    let len = pList.length;\n    for(let i = 0; i < len-1; i++) {\n        let elem = pList[i];\n        if( !schema[elem] ) schema[elem] = {};\n        schema = schema[elem];\n    }\n\n    schema[pList[len-1]] = value;\n    global.set(\"config\", config);\n});\n\n//*****************************************************************************\nglobal.set('removeSpacesAroundDots', function (inputString) {\n    return inputString.replace(/ \\. /g, '.').replace(/\\. /g, '.').replace(/ \\./g, '.');\n});\n\n//*****************************************************************************\nglobal.set('sExtractTime', function (dateString) {\n    const hFixedDate = fSetFixedDate();\n    let parts = dateString.split(' ');\n    //let dateParts = parts[0].split('.');\n    let timeParts = parts[1].split(':');\n\n      let date = new Date(\n          hFixedDate.getFullYear(), // rok\n          hFixedDate.getMonth(), // měsíc (od 0 do 11)\n          hFixedDate.getDate(), // den\n          parseInt(timeParts[0], 10), // hodina\n          parseInt(timeParts[1], 10), // minuta\n          parseInt(timeParts[2], 10) // sekunda\n    );\n\n    return date;\n});\n\n//*****************************************************************************\nglobal.set('mExtractTime',function mExtractTime(milliseconds) {\n        const hFixedDate = fSetFixedDate();\n        let date = new Date(milliseconds);\n\n    let oDate = new Date(\n        hFixedDate.getFullYear(), // rok\n        hFixedDate.getMonth(), // měsíc (od 0 do 11)\n        hFixedDate.getDate(), // den\n        date.getUTCHours(), // hodina\n        date.getUTCMinutes(), // minuta\n        date.getUTCSeconds(), // sekunda\n        0 // milisekunda\n    );\n    return oDate;\n});\n\n//*****************************************************************************\n// vrati casove razitko dnesniho dne 00:00 v sekundach\n/*global.set('getStartOfDayTimestamp', function getStartOfDayTimestamp() {\n    // Získání pevného data pro dnešní den v 00:00 pomocí fSetFixedDate\n    let fixedDate = fSetFixedDateA();\n    fixedDate.setHours(0, 0, 0, 0);\n    return Math.floor(fixedDate.getTime() / 1000); // Vrátí časové razítko v sekundách\n});\n*/\n/*global.set('getStartOfDayTimestamp', function getStartOfDayTimestamp() {\n    let now = new Date(); // Dnešní datum v lokálním čase\n    let startOfDayUTC = Date.UTC(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);\n    return Math.floor(startOfDayUTC / 1000); // Vrátí časové razítko v sekundách pro půlnoc UTC\n});\n\n*/\n\n//*****************************************************************************\n// vrati casove razitko dnesniho dne 23:59:0:0 v sekundach\n/*global.set('getEndOfDayTimestamp', function getEndOfDayTimestamp() {\n    // Získání pevného data pro dnešní den v 00:00 pomocí fSetFixedDate\n    let fixedDate = fSetFixedDateA();\n    // Nastavení času na 23:59:0\n    fixedDate.setHours(23, 59, 0, 0);\n    // Vrácení časového razítka v sekundách\n    return Math.floor(fixedDate.getTime() / 1000);\n});*/\n\n/*\nglobal.set('getEndOfDayTimestamp', function getEndOfDayTimestamp() {\n    let now = new Date(); // Dnešní datum v lokálním čase\n    let startOfDayUTC = Date.UTC(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 0);\n    return Math.floor(startOfDayUTC / 1000); // Vrátí časové razítko v sekundách pro půlnoc UTC\n});\n*/\n\n\n\n\n//*****************************************************************************\nfunction fSetFixedDate(){\n    let hFIXDate = new Date();\n    let hFixedDate = new Date(\n        hFIXDate.getUTCFullYear(), // rok\n        hFIXDate.getUTCMonth(), // měsíc (od 0 do 11)\n        hFIXDate.getUTCDate(), // den\n        0, // hodina\n        0, // minuta\n        0, // sekunda\n        0 // milisekunda\n    );\n    return hFixedDate;\n}\n\n//*****************************************************************************\nfunction fSetFixedDateA() {\n    let hFIXDate = new Date();\n    let hFixedDate = new Date(\n        hFIXDate.getFullYear(), // rok (lokální)\n        hFIXDate.getMonth(), // měsíc (lokální)\n        hFIXDate.getDate(), // den (lokální)\n        0, // hodina\n        0, // minuta\n        0, // sekunda\n        0 // milisekunda\n    );\n    return hFixedDate;\n}\n//*****************************************************************************\n// Funkce pro generování URL\nglobal.set('fSendUrl',function fSendUrl(sIpAddress, nRelayNumber, sTurn) {\n    return `http://${sIpAddress}/relay/${nRelayNumber}?turn=${sTurn}`;\n});\n\n//*****************************************************************************\n// Convert Function Number Signet To Unsignet\nglobal.set('nConvertSignetUnsignet',function nConvertSignetUnsignet(nNumber) {\n    if (nNumber > 32767) nNumber -= 65536; \n    return nNumber;\n});\n\n//*****************************************************************************\n// Convert Function Number Unsignet To Signet\nglobal.set('nConvertUnsignetToSignet', function nConvertUnsignetToSignet(nNumber) {\n    if (nNumber < 0) nNumber += 65536;\n    return nNumber;\n});\n\n//*****************************************************************************\n// Funkce pro reset pole: obnoví pracovní pole ze záložního pole\nglobal.set('resetFilenamePaths', function () {\n    const backupPaths = global.get(\"backup_filename_paths\");\n\n    // Zkontroluj, zda záložní pole existuje a není prázdné\n    if (backupPaths && backupPaths.length > 0) {\n        global.set(\"current_filename_paths\", [...backupPaths]); // Obnova pracovní kopie\n        //node.warn(\"Pracovní pole bylo resetováno.\");\n    } else {\n        node.warn(\"Záložní pole je prázdné nebo neexistuje.\");\n    }\n    return null;\n});\n\n//*****************************************************************************\n// Funkce pro zpracování prvku (odebere první prvek z pracovního pole)\nglobal.set('shiftFilenamePath', function () {\n    let currentPaths = global.get(\"current_filename_paths\");\n\n    // Pokud je pracovní pole prázdné, vrátíme hlášku o prázdném poli\n    if (!currentPaths || currentPaths.length === 0) {\n        //node.warn(\"Pracovní pole je prázdné, provádím reset.\");\n        // Reset pole, protože je prázdné\n        global.get('resetFilenamePaths')();\n        currentPaths = global.get(\"current_filename_paths\");\n    }\n\n    // Odebereme první prvek z pole\n    const path = currentPaths.shift(); // Odebíráme první prvek\n\n    // Uložíme aktualizované pracovní pole zpět do globální proměnné\n    global.set(\"current_filename_paths\", currentPaths);\n\n    // Pokud bylo pole prázdné i po resetu\n    if (!path) {\n        node.warn(\"Pole je prázdné, žádný soubor k návratu.\");\n        return null;\n    } else {\n        // Vraťme odebranou cestu\n        return path;\n    }\n});","finalize":"","libs":[],"x":870,"y":200,"wires":[[]]},{"id":"79aa433d75f5c77d","type":"ui_switch","z":"dc14bd796219d9ad","g":"092c429e967f8893","name":"Set Point SWITCH","label":"Vyp/Zap AcPowerSetPoint","tooltip":"","group":"b1eb05edab318eb0","order":2,"width":6,"height":1,"passthru":true,"decouple":"false","topic":"topic","topicType":"msg","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","animate":false,"className":"Switch_GridPoint","x":650,"y":1500,"wires":[["9f24640183c226de"]],"info":"AcPowerSetPoint"},{"id":"a5313ad38ca271ce","type":"ui_numeric","z":"dc14bd796219d9ad","g":"092c429e967f8893","name":"","label":"AcPowerSetPoint","tooltip":"","group":"b1eb05edab318eb0","order":3,"width":6,"height":1,"wrap":false,"passthru":true,"topic":"topic","topicType":"msg","format":"{{value | number:0}} W","min":"-1000","max":"1000","step":"10","className":"Kulati_Dole","x":1070,"y":1500,"wires":[["6d8f74ee9bbd502e"]]},{"id":"4fd0e3b86bad2c09","type":"ui_switch","z":"dc14bd796219d9ad","g":"092c429e967f8893","name":"delayCharging","label":"Posunutí nabíjení Baterie","tooltip":"","group":"b1eb05edab318eb0","order":5,"width":6,"height":1,"passthru":true,"decouple":"false","topic":"topic","topicType":"msg","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","animate":true,"className":"Kulati_Nahore","x":660,"y":1540,"wires":[["27daf111ebee34ee"]]},{"id":"871a86486ee9f688","type":"ui_text_input","z":"dc14bd796219d9ad","g":"092c429e967f8893","name":"","label":"Začatek posunutí nabíjení baterie","tooltip":"","group":"b1eb05edab318eb0","order":6,"width":6,"height":2,"passthru":true,"mode":"time","delay":300,"topic":"payload","sendOnBlur":true,"className":"","topicType":"msg","x":1260,"y":1540,"wires":[["4a871194f875172f"]]},{"id":"fc94735e37de1038","type":"ui_text_input","z":"dc14bd796219d9ad","g":"092c429e967f8893","name":"","label":"Konec posunutí nabíjení baterie","tooltip":"","group":"b1eb05edab318eb0","order":7,"width":6,"height":2,"passthru":true,"mode":"time","delay":300,"topic":"payload","sendOnBlur":true,"className":"Kulati_Dole","topicType":"msg","x":1250,"y":1580,"wires":[["6358518a8acac836"]]},{"id":"50be985d5cdf539d","type":"change","z":"dc14bd796219d9ad","g":"092c429e967f8893","name":"Set UI","rules":[{"t":"set","p":"payload","pt":"msg","to":"tStartBattery","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1030,"y":1540,"wires":[["871a86486ee9f688"]]},{"id":"9fc9c0af9d89595f","type":"change","z":"dc14bd796219d9ad","g":"092c429e967f8893","name":"Set UI","rules":[{"t":"set","p":"payload","pt":"msg","to":"tStopBattery","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1030,"y":1580,"wires":[["fc94735e37de1038"]]},{"id":"befe99cc74adfbc1","type":"function","z":"dc14bd796219d9ad","g":"092c429e967f8893","name":"Control Set Time","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 14-07-2024, 11:00\n// Revised          : 14-07-2024, 13:56\n// Version          : 1.1\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = true;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fGetConfigProperty = global.get('getConfigProperty');\nconst removeSpacesAroundDots = global.get('removeSpacesAroundDots');\nconst sExtractTime = global.get('sExtractTime');\nconst mExtractTime = global.get('mExtractTime');\nconst sCounty_Code = global.get('sCounty_Code');\nconst sTZidentifier = global.get('sTZidentifier');\n\n\nif (removeSpacesAroundDots && sExtractTime && sCounty_Code && sTZidentifier && mExtractTime && fGetConfigProperty) {\n    const tStopBattery = fGetConfigProperty(\"tStopBattery\") || 0;\n    const tStartBattery = fGetConfigProperty(\"tStartBattery\") || 0;\n\n    // Získejte aktuální čas ve správném časovém pásmu\n    var currentTime = new Date();\n    var sDate = currentTime.toLocaleString(sCounty_Code, { timeZone: sTZidentifier }); \n\n    // Převod aktuálního času na Date objekt\n    var oDate_CZ = sExtractTime(removeSpacesAroundDots(sDate));\n\n    // Převod časů začátku a konce na Date objekty\n    var tStartBatteryTime = mExtractTime(tStartBattery);\n    var tStopBatteryTime = mExtractTime(tStopBattery);\n\n    if (tStartBatteryTime && tStopBatteryTime) {\n        if (debug) {\n            node.warn(\"tStartBattery: \" + tStartBatteryTime);\n            node.warn(\"tStopBattery: \" + tStopBatteryTime);\n            node.warn(\"oDate_CZ: \" + oDate_CZ);\n        }\n\n        msg.payload = `Aktuální čas je: (${tStartBatteryTime.toLocaleTimeString()} - ${tStopBatteryTime.toLocaleTimeString()}).`;\n    } else {\n        msg.payload = 'Čas začátku nebo konce není nastaven.';\n    }\n    } else {\n    node.error(\"Globální funkce nebyly nalezeny. <- FORM GUI -- Control Set Time\");\n}\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1730,"y":1560,"wires":[["b3b1aee73fc70ea9"]]},{"id":"b3b1aee73fc70ea9","type":"debug","z":"dc14bd796219d9ad","g":"092c429e967f8893","name":"debug 18","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":1900,"y":1560,"wires":[]},{"id":"382fa935783c989a","type":"ui_switch","z":"dc14bd796219d9ad","g":"092c429e967f8893","name":"MorningPeakBatterySales","label":"Prodej baterii - ranní špička","tooltip":"","group":"b1eb05edab318eb0","order":9,"width":6,"height":1,"passthru":true,"decouple":"false","topic":"topic","topicType":"msg","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","animate":true,"className":"Kulati_Nahore","x":630,"y":1620,"wires":[["61f4fd4c31877d07"]]},{"id":"9aa2e20d1b0d31a8","type":"ui_switch","z":"dc14bd796219d9ad","g":"092c429e967f8893","name":"EveningPeakBatterySales","label":"Prodej baterii - večerní špička","tooltip":"","group":"b1eb05edab318eb0","order":12,"width":6,"height":1,"passthru":true,"decouple":"false","topic":"topic","topicType":"msg","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","animate":true,"className":"Kulati_Nahore","x":630,"y":1660,"wires":[["278437d717d71b33"]]},{"id":"1bc725c7c8c31f6f","type":"ui_numeric","z":"dc14bd796219d9ad","g":"092c429e967f8893","name":"","label":"Prodej Rano do SOC","tooltip":"","group":"b1eb05edab318eb0","order":10,"width":6,"height":1,"wrap":false,"passthru":true,"topic":"topic","topicType":"msg","format":"{{value | number:0}} %","min":"20","max":"100","step":"1","className":"Kulati_Dole","x":1080,"y":1620,"wires":[["d3a06abf63a62a6a"]]},{"id":"4a750209e1c034d4","type":"ui_numeric","z":"dc14bd796219d9ad","g":"092c429e967f8893","name":"","label":"Prodej Večer do SOC","tooltip":"","group":"b1eb05edab318eb0","order":13,"width":6,"height":1,"wrap":false,"passthru":true,"topic":"topic","topicType":"msg","format":"{{value | number:0}} %","min":"20","max":"100","step":"1","className":"Kulati_Dole","x":1080,"y":1660,"wires":[["949730c7a68bec19"]]},{"id":"9f24640183c226de","type":"function","z":"dc14bd796219d9ad","g":"092c429e967f8893","name":"SET CONFIG","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 25-07-2024, 09:43\n// Revised          : 25-07-2024, 10:27\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fGetConfigProperty = global.get('getConfigProperty');\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst nGridConsumptionEnable = msg.payload; //nacteni vstupu\nconst nSetGridValue = fGetConfigProperty(\"nSetGridValue\") || 0; //dotaz na data z globalni strukturu\nfSetConfigProperty(\"nGridConsumptionEnable\", nGridConsumptionEnable); //ulozit data do globalni struktury\n\nmsg.payload = nSetGridValue;          //nastaveni hodnoty\nmsg.enabled = nGridConsumptionEnable; //enable switch\n\n// Debugging\nif (debug) {\n    node.warn(\"nGridConsumptionEnable: \" + nGridConsumptionEnable);\n    node.warn(\"nSetGridValue: \" + nSetGridValue);\n    node.warn(\"msg.payload: \" + msg.payload);\n    node.warn(\"msg.enabled: \" + msg.enabled);\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":860,"y":1500,"wires":[["a5313ad38ca271ce"]]},{"id":"9243e651dea96d4c","type":"inject","z":"dc14bd796219d9ad","g":"e5111d27ef0bf43d","name":"RESET","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":true,"onceDelay":"0.1","topic":"","payload":"","payloadType":"date","x":380,"y":200,"wires":[["eb2aebb66e80d341","ea8e613bd96afead","50e7df9e8b3bc878"]]},{"id":"6d8f74ee9bbd502e","type":"function","z":"dc14bd796219d9ad","g":"092c429e967f8893","name":"Set nGridValue","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 25-07-2024, 09:43\n// Revised          : 25-07-2024, 11:27\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst nSetGridValue = msg.payload; //nacteni vstupu\nfSetConfigProperty(\"nSetGridValue\", nSetGridValue); //ulozit data do globalni struktury\n\n// Debugging\nif (debug) {\n    node.warn(\"nSetGridValue: \" + nSetGridValue);\n}\n\nreturn null;","outputs":0,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1280,"y":1500,"wires":[]},{"id":"d3a06abf63a62a6a","type":"function","z":"dc14bd796219d9ad","g":"092c429e967f8893","name":"Set nMorningSOC_sales","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 25-07-2024, 09:43\n// Revised          : 25-07-2024, 11:27\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst nMorningSOC_sales = msg.payload; //nacteni vstupu\nfSetConfigProperty(\"nMorningSOC_sales\", nMorningSOC_sales); //ulozit data do globalni struktury\n\n// Debugging\nif (debug) {\n    node.warn(\"nMorningSOC_sales: \" + nMorningSOC_sales);\n}\n\nreturn null;","outputs":0,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1330,"y":1620,"wires":[]},{"id":"949730c7a68bec19","type":"function","z":"dc14bd796219d9ad","g":"092c429e967f8893","name":"Set nEveningSOC_sales","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 25-07-2024, 09:43\n// Revised          : 25-07-2024, 11:27\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst nEveningSOC_sales = msg.payload; //nacteni vstupu\nfSetConfigProperty(\"nEveningSOC_sales\", nEveningSOC_sales); //ulozit data do globalni struktury\n\n// Debugging\nif (debug) {\n    node.warn(\"nEveningSOC_sales: \" + nEveningSOC_sales);\n}\n\nreturn null;","outputs":0,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1330,"y":1660,"wires":[]},{"id":"61f4fd4c31877d07","type":"function","z":"dc14bd796219d9ad","g":"092c429e967f8893","name":"SET CONFIG","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 25-07-2024, 09:43\n// Revised          : 25-07-2024, 10:27\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fGetConfigProperty = global.get('getConfigProperty');\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst nMorningPeakBatterySales = msg.payload; //nacteni vstupu\nconst nMorningSOC_sales = fGetConfigProperty(\"nMorningSOC_sales\") || 0; //dotaz na data z globalni strukturu\nfSetConfigProperty(\"nMorningPeakBatterySales\", nMorningPeakBatterySales); //ulozit data do globalni struktury\n\nmsg.payload = nMorningSOC_sales;        //nastaveni hodnoty\nmsg.enabled = nMorningPeakBatterySales; //enable switch\n\n// Debugging\nif (debug) {\n    node.warn(\"nMorningPeakBatterySales: \" + nMorningPeakBatterySales);\n    node.warn(\"nMorningSOC_sales: \" + nMorningSOC_sales);\n    node.warn(\"msg.payload: \" + msg.payload);\n    node.warn(\"msg.enabled: \" + msg.enabled);\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":860,"y":1620,"wires":[["1bc725c7c8c31f6f"]]},{"id":"278437d717d71b33","type":"function","z":"dc14bd796219d9ad","g":"092c429e967f8893","name":"SET CONFIG","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 25-07-2024, 09:43\n// Revised          : 25-07-2024, 10:27\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fGetConfigProperty = global.get('getConfigProperty');\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst nEveningPeakBatterySales = msg.payload; //nacteni vstupu\nconst nEveningSOC_sales = fGetConfigProperty(\"nEveningSOC_sales\") || 0; //dotaz na data z globalni strukturu\nfSetConfigProperty(\"nEveningPeakBatterySales\", nEveningPeakBatterySales); //ulozit data do globalni struktury\n\nmsg.payload = nEveningSOC_sales;          //nastaveni hodnoty\nmsg.enabled = nEveningPeakBatterySales; //enable switch\n\n// Debugging\nif (debug) {\n    node.warn(\"nEveningPeakBatterySales: \" + nEveningPeakBatterySales);\n    node.warn(\"nEveningSOC_sales: \" + nEveningSOC_sales);\n    node.warn(\"msg.payload: \" + msg.payload);\n    node.warn(\"msg.enabled: \" + msg.enabled);\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":860,"y":1660,"wires":[["4a750209e1c034d4"]]},{"id":"27daf111ebee34ee","type":"function","z":"dc14bd796219d9ad","g":"092c429e967f8893","name":"SET CONFIG","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 25-07-2024, 09:43\n// Revised          : 25-07-2024, 10:27\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fGetConfigProperty = global.get('getConfigProperty');\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst switchDelayCharging = msg.payload; //nacteni vstupu\nconst tStartBattery = fGetConfigProperty(\"tStartBattery\") || 0; //dotaz na data z globalni strukturu\nconst tStopBattery = fGetConfigProperty(\"tStopBattery\") || 0; //dotaz na data z globalni strukturu\nfSetConfigProperty(\"switchDelayCharging\", switchDelayCharging); //ulozit data do globalni struktury\n\nmsg.tStartBattery = tStartBattery; //nastaveni hodnoty\nmsg.tStopBattery = tStopBattery;   //nastaveni hodnoty\nmsg.enabled = switchDelayCharging; //enable switch\n\n// Debugging\nif (debug) {\n    node.warn(\"switchDelayCharging: \" + switchDelayCharging);\n    node.warn(\"tStartBattery: \" + tStartBattery);\n    node.warn(\"tStopBattery: \" + tStopBattery);\n    node.warn(\"msg.tStartBattery: \" + msg.tStartBattery);\n    node.warn(\"msg.tStopBattery: \" + msg.tStopBattery);\n    node.warn(\"msg.enabled: \" + msg.enabled);\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":860,"y":1540,"wires":[["50be985d5cdf539d","9fc9c0af9d89595f"]]},{"id":"4a871194f875172f","type":"function","z":"dc14bd796219d9ad","g":"092c429e967f8893","name":"Set tStartBattery","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 25-07-2024, 09:43\n// Revised          : 25-07-2024, 11:27\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fSetConfigProperty = global.get('setConfigProperty');\nconst convertUnixTimestamp = global.get('convertUnixTimestamp');\n\nconst inputTime = msg.payload; //nacteni vstupu\nconst tStartBattery = convertUnixTimestamp(inputTime, debug);\n\nfSetConfigProperty(\"tStartBattery\", tStartBattery); //ulozit data do globalni struktury\n\n// Debugging\nif (debug) {\n    node.warn(\"tStartBattery: \" + tStartBattery);\n    msg.tStartBattery = tStartBattery; // Přidání hodnoty do zprávy\n    return msg; // Vrácení zprávy, pokud je debug true\n} else {\n    return null; // Nevracet nic, pokud je debug false\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1500,"y":1540,"wires":[["befe99cc74adfbc1"]]},{"id":"6358518a8acac836","type":"function","z":"dc14bd796219d9ad","g":"092c429e967f8893","name":"Set tStopBattery","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 25-07-2024, 09:43\n// Revised          : 25-07-2024, 11:27\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fSetConfigProperty = global.get('setConfigProperty');\nconst convertUnixTimestamp = global.get('convertUnixTimestamp');\n\nconst inputTime = msg.payload; //nacteni vstupu\nconst tStopBattery = convertUnixTimestamp(inputTime, debug);\n\nfSetConfigProperty(\"tStopBattery\", tStopBattery); //ulozit data do globalni struktury\n\n// Debugging\nif (debug) {\n    node.warn(\"tStopBattery: \" + tStopBattery);\n    msg.tStopBattery = tStopBattery; // Přidání hodnoty do zprávy\n    return msg; // Vrácení zprávy, pokud je debug true\n} else {\n    return null; // Nevracet nic, pokud je debug false\n};","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1500,"y":1580,"wires":[["befe99cc74adfbc1"]]},{"id":"e82772f3cfe17836","type":"link in","z":"dc14bd796219d9ad","g":"092c429e967f8893","name":"CLOCK","links":["9bdbf5d33911e135"],"x":305,"y":1580,"wires":[["79aa433d75f5c77d","4fd0e3b86bad2c09","382fa935783c989a","9aa2e20d1b0d31a8","4da4a259c9bf266f"]]},{"id":"9bdbf5d33911e135","type":"link out","z":"dc14bd796219d9ad","g":"1a9d21242a01ebdd","name":"CLOCK","mode":"link","links":["e82772f3cfe17836","30fb0930ec720c71"],"x":595,"y":840,"wires":[]},{"id":"06864177b7791422","type":"link in","z":"dc14bd796219d9ad","g":"e5111d27ef0bf43d","name":"DELETE_CONFIG","links":["3bdc81473f9625ee"],"x":525,"y":200,"wires":[["eb2aebb66e80d341","50e7df9e8b3bc878"]]},{"id":"e4a510eeb5c4f70f","type":"function","z":"dc14bd796219d9ad","g":"092c429e967f8893","name":"SET GUI","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 31-07-2024, 17:39\n// Revised          : 31-07-2024, 17:50\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fGetConfigProperty = global.get('getConfigProperty');\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst sBuffer = !!fGetConfigProperty(\"nGridConsumptionEnable\"); //dotaz na data z globalni strukturu\nmsg.payload  = sBuffer; //SET switch to read data\n\n//Dvojitý negátor !!: Použití dvou negátorů ! převede jakoukoli hodnotu na její boolean ekvivalent.\n// První ! hodnotu zneguje (což znamená, že true se změní na false a naopak), a druhý ! změní hodnotu zpět na boolean:\n//Pokud je původní hodnota \"truthy\" (např. 1, true, ne-prázdný řetězec), výsledek bude true.\n//Pokud je původní hodnota \"falsy\" (např. 0, false, NaN, undefined, prázdný řetězec), výsledek bude false.\n\n// Debugging\nif (debug) {\n    node.warn(\"nGridConsumptionEnable: \" + sBuffer);\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":360,"y":1500,"wires":[["79aa433d75f5c77d"]]},{"id":"dca141d221dbecf7","type":"link in","z":"dc14bd796219d9ad","name":"RESET_GUI","links":["e5706dfefece2626"],"x":145,"y":1580,"wires":[["e4a510eeb5c4f70f","145474f6548c4ba6","010f32f4b84afaf6","7d82878c9a3e9cbf","1d81eac81eb2a6c6","4da4a259c9bf266f"]]},{"id":"145474f6548c4ba6","type":"function","z":"dc14bd796219d9ad","g":"092c429e967f8893","name":"SET GUI","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 31-07-2024, 17:39\n// Revised          : 31-07-2024, 17:50\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fGetConfigProperty = global.get('getConfigProperty');\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst sBuffer = !!fGetConfigProperty(\"switchDelayCharging\"); //dotaz na data z globalni strukturu\nmsg.payload  = sBuffer; //SET switch to read data\n\n//Dvojitý negátor !!: Použití dvou negátorů ! převede jakoukoli hodnotu na její boolean ekvivalent.\n// První ! hodnotu zneguje (což znamená, že true se změní na false a naopak), a druhý ! změní hodnotu zpět na boolean:\n//Pokud je původní hodnota \"truthy\" (např. 1, true, ne-prázdný řetězec), výsledek bude true.\n//Pokud je původní hodnota \"falsy\" (např. 0, false, NaN, undefined, prázdný řetězec), výsledek bude false.\n\n// Debugging\nif (debug) {\n    node.warn(\"switchDelayCharging: \" + sBuffer);\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":360,"y":1540,"wires":[["4fd0e3b86bad2c09"]]},{"id":"010f32f4b84afaf6","type":"function","z":"dc14bd796219d9ad","g":"092c429e967f8893","name":"SET GUI","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 31-07-2024, 17:39\n// Revised          : 31-07-2024, 17:50\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fGetConfigProperty = global.get('getConfigProperty');\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst sBuffer = !!fGetConfigProperty(\"nMorningPeakBatterySales\"); //dotaz na data z globalni strukturu\nmsg.payload  = sBuffer; //SET switch to read data\n\n//Dvojitý negátor !!: Použití dvou negátorů ! převede jakoukoli hodnotu na její boolean ekvivalent.\n// První ! hodnotu zneguje (což znamená, že true se změní na false a naopak), a druhý ! změní hodnotu zpět na boolean:\n//Pokud je původní hodnota \"truthy\" (např. 1, true, ne-prázdný řetězec), výsledek bude true.\n//Pokud je původní hodnota \"falsy\" (např. 0, false, NaN, undefined, prázdný řetězec), výsledek bude false.\n\n// Debugging\nif (debug) {\n    node.warn(\"nMorningPeakBatterySales: \" + sBuffer);\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":360,"y":1620,"wires":[["382fa935783c989a"]]},{"id":"7d82878c9a3e9cbf","type":"function","z":"dc14bd796219d9ad","g":"092c429e967f8893","name":"SET GUI","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 31-07-2024, 17:39\n// Revised          : 31-07-2024, 17:50\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fGetConfigProperty = global.get('getConfigProperty');\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst sBuffer = !!fGetConfigProperty(\"nEveningPeakBatterySales\"); //dotaz na data z globalni strukturu\nmsg.payload  = sBuffer; //SET switch to read data\n\n//Dvojitý negátor !!: Použití dvou negátorů ! převede jakoukoli hodnotu na její boolean ekvivalent.\n// První ! hodnotu zneguje (což znamená, že true se změní na false a naopak), a druhý ! změní hodnotu zpět na boolean:\n//Pokud je původní hodnota \"truthy\" (např. 1, true, ne-prázdný řetězec), výsledek bude true.\n//Pokud je původní hodnota \"falsy\" (např. 0, false, NaN, undefined, prázdný řetězec), výsledek bude false.\n\n// Debugging\nif (debug) {\n    node.warn(\"nEveningPeakBatterySales: \" + sBuffer);\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":360,"y":1660,"wires":[["9aa2e20d1b0d31a8"]]},{"id":"1d81eac81eb2a6c6","type":"function","z":"dc14bd796219d9ad","g":"092c429e967f8893","name":"SET GUI","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 31-07-2024, 17:39\n// Revised          : 31-07-2024, 17:50\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fGetConfigProperty = global.get('getConfigProperty');\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst sBuffer = fGetConfigProperty(\"nVRM_site_id\"); //dotaz na data z globalni strukturu\nmsg.payload  = sBuffer; //SET switch to read data\n\n// Debugging\nif (debug) {\n    node.warn(\"nVRM_site_id: \" + sBuffer);\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":360,"y":1740,"wires":[["4ebbc6fd923e2f36"]]},{"id":"0973f4e5a1eb8967","type":"function","z":"dc14bd796219d9ad","g":"092c429e967f8893","name":"Set nVRM_site_id","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 25-07-2024, 09:43\n// Revised          : 25-07-2024, 11:27\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst nVRM_site_id = msg.payload; //nacteni vstupu\nfSetConfigProperty(\"nVRM_site_id\", nVRM_site_id); //ulozit data do globalni struktury\n\n// Debugging\nif (debug) {\n    node.warn(\"nVRM_site_id: \" + nVRM_site_id);\n}\n\nreturn null;","outputs":0,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":870,"y":1740,"wires":[]},{"id":"4ebbc6fd923e2f36","type":"ui_text_input","z":"dc14bd796219d9ad","g":"092c429e967f8893","name":"nVRM_site_id","label":"VRM site ID","tooltip":"ID vasi instalaci ve VRM","group":"b5c590ba96324296","order":4,"width":6,"height":2,"passthru":true,"mode":"text","delay":300,"topic":"topic","sendOnBlur":true,"className":"","topicType":"msg","x":600,"y":1740,"wires":[["0973f4e5a1eb8967"]]},{"id":"79fee107e7a6a7ff","type":"function","z":"dc14bd796219d9ad","g":"48de5eb1ca74eafc","name":"API live_feed","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2025\n// Created          : 03-08-2024, 21:19\n// Revised          : 09-02-2025, 15:38\n// Version          : 1.6\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2025 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n// Definice globálních funkcí\nconst fGetConfigProperty = global.get('getConfigProperty');\nconst fSetConfigProperty = global.get('setConfigProperty');\nconst getStartOfDayTimestamp = global.get('getStartOfDayTimestamp');\nconst getEndOfDayTimestamp = global.get('getEndOfDayTimestamp');\nconst intervalType = global.get('intervalType');\nconst fWrite_LogFile = global.get('fWrite_LogFile');\n\n// Získání potřebných hodnot z globálního kontextu\nconst nVRM_site_id = fGetConfigProperty(\"nVRM_site_id\") || 0;\n//const bearerToken = fGetConfigProperty(\"bearerToken\") || 0;\nconst deposit_Token = fGetConfigProperty(\"deposit_Token\") || 0;\n\n\n// Získání časových značek pro začátek a konec dne\nconst tStart = getStartOfDayTimestamp();\nconst tStop = getEndOfDayTimestamp();\n\n// Nastavení hlaviček požadavku\nmsg.headers = {\n    \"Content-Type\": \"application/json\",\n    \"x-authorization\": `Token ${deposit_Token}`\n};\n\n// Nastavení parametrů dotazu\nconst params = {\n    start: tStart,\n    end: tStop,\n    type: \"live_feed\",\n    interval: intervalType,\n};\n\n// Nastavení payloadu\nmsg.payload = params;\n\n// Nastavení URL pro API požadavek\nmsg.url = `https://vrmapi.victronenergy.com/v2/installations/${nVRM_site_id}/stats?${serializeParams(params)}`;\n\n// Inicializace druhého výstupu (default je false)\nlet secondOutput = { live_feed: false };\n\n// Kontrola platnosti tokenu\nif (deposit_Token == \"VRM_TOKEN\" || nVRM_site_id == 0 || deposit_Token == 0) {\n    // Když je token neplatný, poslat true na druhý výstup\n    secondOutput.live_feed = true;\n    // Debugging\n    if (debug) {\n        //node.warn(\"neni token: \" + bearerToken);\n        fWrite_LogFile(\"neni token: *************************************** \", deposit_Token);\n        //fWrite_LogFile(\"msg.url: \", msg.url);\n        //fWrite_LogFile(\"nVRM_site_id: \", nVRM_site_id);\n    }\n}\n\n// Debugging\nif (debug) {\n    //node.warn(\"bearerToken: \" + bearerToken);\n    //fWrite_LogFile(\"bearerToken: \", bearerToken);\n    //fWrite_LogFile(\"msg.url: \", msg.url);\n}\n\n// Funkce pro serializaci objektu parametrů do URL query stringu\nfunction serializeParams(params) {\n    return Object.keys(params)\n        .map(key => `${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`)\n        .join('&');\n}\n\n// Vrátit pole zpráv pro oba výstupy\nreturn [msg, secondOutput];\n","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":710,"y":1180,"wires":[["165e92efd553fe94","3b71a96b67f875c3"],["ebf55f4e991cb354","0230cbe8d5c6e7b5"]]},{"id":"165e92efd553fe94","type":"http request","z":"dc14bd796219d9ad","g":"48de5eb1ca74eafc","name":"","method":"GET","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":1070,"y":1180,"wires":[["b1d7374a4e4bdfa6","17b9f487a18352cd"]]},{"id":"b1d7374a4e4bdfa6","type":"debug","z":"dc14bd796219d9ad","g":"48de5eb1ca74eafc","name":"Data from the function node","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload","statusType":"auto","x":1500,"y":1180,"wires":[]},{"id":"af54f00448a605d5","type":"ui_text","z":"dc14bd796219d9ad","g":"c8820631d746febb","group":"eff8c2fb7917b0ab","order":13,"width":6,"height":1,"name":"","label":"{{msg.text}}","format":"{{msg.payload}} kWh","layout":"row-spread","className":"","style":false,"font":"","fontSize":16,"color":"#000000","x":1470,"y":100,"wires":[]},{"id":"fed095ddcd77b1a2","type":"ui_text","z":"dc14bd796219d9ad","g":"c8820631d746febb","group":"eff8c2fb7917b0ab","order":14,"width":6,"height":1,"name":"","label":"{{msg.text}}","format":"{{msg.payload}} kWh","layout":"row-spread","className":"","style":false,"font":"","fontSize":16,"color":"#000000","x":1470,"y":140,"wires":[]},{"id":"06d228dd9e29523d","type":"ui_text","z":"dc14bd796219d9ad","g":"c8820631d746febb","group":"eff8c2fb7917b0ab","order":16,"width":6,"height":1,"name":"","label":"Spotřeba celkem","format":"{{msg.payload}} kWh","layout":"row-spread","className":"","style":false,"font":"","fontSize":16,"color":"#000000","x":1510,"y":180,"wires":[]},{"id":"99819cff5b984fd1","type":"ui_text","z":"dc14bd796219d9ad","g":"c8820631d746febb","group":"eff8c2fb7917b0ab","order":18,"width":6,"height":1,"name":"","label":"Solární energie celkem","format":"{{msg.payload}} kWh","layout":"row-spread","className":"Kulati_Dole","style":false,"font":"","fontSize":16,"color":"#000000","x":1520,"y":260,"wires":[]},{"id":"17b9f487a18352cd","type":"function","z":"dc14bd796219d9ad","g":"48de5eb1ca74eafc","name":"Set API live_feed","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 07-08-2024, 18:04\n// Revised          : 07-08-2024, 20:27\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\nconst sAPI_live_feed = msg.payload; //nacteni vstupu\n\n // Ulozeni dat do globalnich promennych, ktere jsou dostupne mezi flow\nglobal.set(\"sAPI_live_feed\", sAPI_live_feed);\nconst fWrite_LogFile = global.get('fWrite_LogFile');\n//fWrite_LogFile(\"serie: \", series[index]);\n\n// Debugging\nif (debug) {\n    //node.warn(\"sAPI_live_feed: \" + sAPI_live_feed);\n    //fWrite_LogFile(\"statusCode: \", sAPI_live_feed.headers.statusCode);\n    fWrite_LogFile(\"success: \", sAPI_live_feed.success);\n}\n\nreturn null;","outputs":0,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1250,"y":1180,"wires":[]},{"id":"8a38865c67bf35d9","type":"link in","z":"dc14bd796219d9ad","g":"48de5eb1ca74eafc","name":"CLOCK_2","links":["10d11499af100019"],"x":315,"y":1180,"wires":[["3a87775a04df95f8"]]},{"id":"02a502c924056fb6","type":"delay","z":"dc14bd796219d9ad","g":"e5111d27ef0bf43d","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":640,"y":380,"wires":[["26e69bb073bbcc02"]]},{"id":"784b0c28936b3da9","type":"link out","z":"dc14bd796219d9ad","g":"e5111d27ef0bf43d","name":"CLOCK_15","mode":"link","links":[],"x":525,"y":380,"wires":[]},{"id":"26e69bb073bbcc02","type":"link out","z":"dc14bd796219d9ad","g":"e5111d27ef0bf43d","name":"CLOCK_15_5S","mode":"link","links":["e3cb434152e4befa"],"x":775,"y":380,"wires":[]},{"id":"b2bd7ff600556974","type":"function","z":"dc14bd796219d9ad","g":"c8820631d746febb","name":"SET GUI - Do site","func":"//*****************************************************************************\n//\n// File Name        : N/A \n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 07-08-2024, 18:15\n// Revised          : 05-02-2025, 19:07\n// Version          : 1.11\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2025 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n// Uložení dat do globálních proměnných, které jsou dostupné mezi flow\nconst nBuffer = global.get(\"sAPI_live_feed\") || {};\n\n// Zelená šipka\nconst greenArrowLeftBase64 =\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABsAAAAQCAYAAADnEwSWAAABg2lDQ1BJQ0MgcHJvZmlsZQAAKJF9kT1Iw1AUhU9TS0UqDnYQcchQneyiIo6likWwUNIKrTqYvPQPmjQkKS6OgmvBwZ/FqoOLs64OroIg+APiLjgpukiJ9yWFFjFeeLyP8+45vHcfILRqTLP6EoCm26aUSor5wqoYfoWAEMIIQJSZZaSzizn41tc99VHdxXmWf9+fNagWLQYEROIEM0ybeIN4dtM2OO8TR1lFVonPiSdNuiDxI9cVj984l10WeGbUzEnzxFFisdzDSg+ziqkRzxDHVE2nfCHvscp5i7NWa7DOPfkLI0V9Jct1WmNIYQlpZCBCQQNV1GAjTrtOigWJzpM+/lHXnyGXQq4qGDkWUIcG2fWD/8Hv2Vql6SkvKZIEQi+O8zEOhHeBdtNxvo8dp30CBJ+BK73rr7eAuU/Sm10tdgQMbQMX111N2QMud4CRJ0M2ZVcK0hJKJeD9jL6pAAzfAgNr3tw65zh9AHI0q+Ub4OAQmChT9rrPu/t75/ZvT2d+PzWCco4mKLbOAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA3ElEQVQ4y9XUoUoEYRTF8d98rohWhWkWweUzmnwKQRA06jsoKigW38FgMQo230EwbZ3iC9xoElG+tWyQBVGYmUUP3HLD/XPhnMNfU4o8Pxe5an3nF6A1HI1Z7g2WIi+myAd4wBZeeoGlyENcT2YDo1I3721h1RRkCfs4wfpkXXCHUQvOY6mbp+oLaBOn2MZCxx67KHVzNUiRBzjEOVZ7dfVMI1Tq5qPUzQ12cI+3vmAzNch3GRumyLcp8muKPE6RLzv/bDrU2MMxnrHbRdZ+rKsU+SxFXvlXRTxTfQIqF0LlO5TcdwAAAABJRU5ErkJggg==\";\nmsg.text = `<img src=\"${greenArrowLeftBase64}\" width=\"16\"> Do sítě`;\n\n// Kontrola, zda nBuffer a nBuffer.totals existují\nif (nBuffer && nBuffer.totals && typeof nBuffer.totals.grid_history_to !== 'undefined') {\n    // Získání hodnoty a zaokrouhlení na jedno desetinné místo\n    msg.payload = parseFloat(nBuffer.totals.grid_history_to).toFixed(1);\n\n} else {\n    // Pokud nBuffer.totals nebo grid_history_to neexistuje, nastavíme payload na 0\n    msg.payload = 0;\n    if (debug) {\n        node.warn(\"grid_history_to is undefined\");\n    }\n}\n\n// Debugging\nif (debug) {\n    node.warn(\"grid_history_to: \" + msg.payload);\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1290,"y":100,"wires":[["af54f00448a605d5"]]},{"id":"5e6360379d323364","type":"function","z":"dc14bd796219d9ad","g":"c8820631d746febb","name":"SET GUI - Ze sítě","func":"//*****************************************************************************\n//\n// File Name        : N/A \n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 07-08-2024, 18:15\n// Revised          : 05-02-2025, 19:03\n// Version          : 1.11\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2025 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n// Uložení dat do globálních proměnných, které jsou dostupné mezi flow\nconst nBuffer = global.get(\"sAPI_live_feed\") || {};\n\n// Zelená šipka\nconst greenArrowRightBase64 = \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABsAAAAQCAYAAADnEwSWAAABg2lDQ1BJQ0MgcHJvZmlsZQAAKJF9kT1Iw1AUhU9TS0UqDnYQcchQneyiIo6likWwUNIKrTqYvPQPmjQkKS6OgmvBwZ/FqoOLs64OroIg+APiLjgpukiJ9yWFFjFeeLyP8+45vHcfILRqTLP6EoCm26aUSor5wqoYfoWAEMIIQJSZZaSzizn41tc99VHdxXmWf9+fNagWLQYEROIEM0ybeIN4dtM2OO8TR1lFVonPiSdNuiDxI9cVj984l10WeGbUzEnzxFFisdzDSg+ziqkRzxDHVE2nfCHvscp5i7NWa7DOPfkLI0V9Jct1WmNIYQlpZCBCQQNV1GAjTrtOigWJzpM+/lHXnyGXQq4qGDkWUIcG2fWD/8Hv2Vql6SkvKZIEQi+O8zEOhHeBdtNxvo8dp30CBJ+BK73rr7eAuU/Sm10tdgQMbQMX111N2QMud4CRJ0M2ZVcK0hJKJeD9jL6pAAzfAgNr3tw65zh9AHI0q+Ub4OAQmChT9rrPu/t75/ZvT2d+PzWCco4mKLbOAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA40lEQVQ4y9WUP0oDURCHvx13CaksLN4BLGQsrRY8h2BpkwtISsHCJsEDpE2plbB1DmC1pQ8EDzClTRYJvLVREJMFYd9bzK8e5ps/vxnYJx2YZmJa/CVW+sJaOAKmYnqcHAa8AyVQiemVmI6TwYLzG6AGToEFsBDTk12xGYCYlsB5D+YZcPmj+FdgDjwE59e/YTfAXWTvfAAVMAvO17F21qURcAE8ielETHMZ8kzyhLm3xvgNWwFNaoNEkZjeimkrpo2YLrusn0cAFV+dvQD3wGNwvkm1s0PgGbgOzr/9m0c8qD4BYvFCi0bTFV8AAAAASUVORK5CYII=\";\nmsg.text = `<img src=\"${greenArrowRightBase64}\" width=\"16\"> Ze sítě`;\n\n// Kontrola, zda nBuffer a nBuffer.totals existují\nif (nBuffer && nBuffer.totals && typeof nBuffer.totals.grid_history_from !== 'undefined') {\n    // Získání hodnoty a zaokrouhlení na jedno desetinné místo\n    msg.payload = parseFloat(nBuffer.totals.grid_history_from).toFixed(1);\n\n} else {\n    // Pokud nBuffer.totals nebo grid_history_to neexistuje, nastavíme payload na 0\n    msg.payload = 0;\n    if (debug) {\n        node.warn(\"grid_history_from is undefined\");\n    }\n}\n\n// Debugging\nif (debug) {\n    node.warn(\"grid_history_from: \" + msg.payload);\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1290,"y":140,"wires":[["fed095ddcd77b1a2"]]},{"id":"5db0fcb2d3432a58","type":"function","z":"dc14bd796219d9ad","g":"c8820631d746febb","name":"SET GUI","func":"//*****************************************************************************\n//\n// File Name        : N/A \n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 07-08-2024, 18:15\n// Revised          : 07-08-2024, 19:03\n// Version          : 1.10\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n// Uložení dat do globálních proměnných, které jsou dostupné mezi flow\nconst nBuffer = global.get(\"sAPI_live_feed\") || {};\n\n// Kontrola, zda nBuffer a nBuffer.totals existují\nif (nBuffer && nBuffer.totals && typeof nBuffer.totals.total_consumption !== 'undefined') {\n    // Získání hodnoty a zaokrouhlení na jedno desetinné místo\n    msg.payload = parseFloat(nBuffer.totals.total_consumption).toFixed(1);\n\n} else {\n    // Pokud nBuffer.totals nebo grid_history_to neexistuje, nastavíme payload na 0\n    msg.payload = 0;\n    if (debug) {\n        node.warn(\"total_consumption is undefined\");\n    }\n}\n\n// Debugging\nif (debug) {\n    node.warn(\"total_consumption: \" + msg.payload);\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1260,"y":180,"wires":[["06d228dd9e29523d"]]},{"id":"a8518f89fb213aa4","type":"function","z":"dc14bd796219d9ad","g":"c8820631d746febb","name":"SET GUI","func":"//*****************************************************************************\n//\n// File Name        : N/A \n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 07-08-2024, 18:15\n// Revised          : 07-08-2024, 19:03\n// Version          : 1.10\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n// Uložení dat do globálních proměnných, které jsou dostupné mezi flow\nconst nBuffer = global.get(\"sAPI_live_feed\") || {};\n\n// Kontrola, zda nBuffer a nBuffer.totals existují\nif (nBuffer && nBuffer.totals && typeof nBuffer.totals.total_solar_yield !== 'undefined') {\n    // Získání hodnoty a zaokrouhlení na jedno desetinné místo\n    msg.payload = parseFloat(nBuffer.totals.total_solar_yield).toFixed(1);\n\n} else {\n    // Pokud nBuffer.totals nebo grid_history_to neexistuje, nastavíme payload na 0\n    msg.payload = 0;\n    if (debug) {\n        node.warn(\"total_solar_yield is undefined\");\n    }\n}\n\n// Debugging\nif (debug) {\n    node.warn(\"total_solar_yield: \" + msg.payload);\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1260,"y":260,"wires":[["99819cff5b984fd1"]]},{"id":"9158e8cb04621410","type":"link in","z":"dc14bd796219d9ad","g":"c8820631d746febb","name":"CLOCK","links":["cb7a87ea7ca8d6c1","e5706dfefece2626"],"x":1105,"y":160,"wires":[["b2bd7ff600556974","5e6360379d323364","5db0fcb2d3432a58","a8518f89fb213aa4","21f1e3012ce7e0ca","a2ae83b1d097b508"]]},{"id":"2cf2059778055ad7","type":"ui_text","z":"dc14bd796219d9ad","g":"c8820631d746febb","group":"eff8c2fb7917b0ab","order":12,"width":6,"height":1,"name":"","label":"Údaje o instalaci:","format":"<p class=\"label_time\">{{msg.payload}}</p>","layout":"row-spread","className":"Kulati_Nahore","style":true,"font":"","fontSize":16,"color":"#ffbb00","x":1510,"y":340,"wires":[]},{"id":"b65295cb8678d439","type":"inject","z":"dc14bd796219d9ad","g":"e5111d27ef0bf43d","name":"Each 2 min","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"120","crontab":"","once":true,"onceDelay":"0.3","topic":"","payload":"","payloadType":"date","x":390,"y":320,"wires":[["10d11499af100019","a4c1923cc431fc76"]]},{"id":"10d11499af100019","type":"link out","z":"dc14bd796219d9ad","g":"e5111d27ef0bf43d","name":"CLOCK_2","mode":"link","links":["8a38865c67bf35d9"],"x":525,"y":320,"wires":[]},{"id":"a4c1923cc431fc76","type":"delay","z":"dc14bd796219d9ad","g":"e5111d27ef0bf43d","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":640,"y":320,"wires":[["cb7a87ea7ca8d6c1"]]},{"id":"cb7a87ea7ca8d6c1","type":"link out","z":"dc14bd796219d9ad","g":"e5111d27ef0bf43d","name":"CLOCK_2_5S","mode":"link","links":["9158e8cb04621410"],"x":775,"y":320,"wires":[]},{"id":"2b6b0572bca8c587","type":"inject","z":"dc14bd796219d9ad","g":"1b84d1ab8eb2c216","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1720,"y":560,"wires":[["95b1ec484d912acd"]]},{"id":"555d1b0cb34f6b9e","type":"http request","z":"dc14bd796219d9ad","g":"48de5eb1ca74eafc","name":"","method":"GET","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":1070,"y":1260,"wires":[["42ee3f3b8ea0ef0c","ddf420fd18dce565"]]},{"id":"42ee3f3b8ea0ef0c","type":"debug","z":"dc14bd796219d9ad","g":"48de5eb1ca74eafc","name":"Data from the function node","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload","statusType":"auto","x":1500,"y":1260,"wires":[]},{"id":"ddf420fd18dce565","type":"function","z":"dc14bd796219d9ad","g":"48de5eb1ca74eafc","name":"Set APIforecast","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 07-08-2024, 18:04\n// Revised          : 07-08-2024, 20:27\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\nconst sAPI_forecast = msg.payload; //nacteni vstupu\n\n // Ulozeni dat do globalnich promennych, ktere jsou dostupne mezi flow\nglobal.set(\"sAPI_forecast\", sAPI_forecast);\n\n// Debugging\nif (debug) {\n    node.warn(\"sAPI_forecast: \" + sAPI_forecast);\n}\n\nreturn null;","outputs":0,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1260,"y":1260,"wires":[]},{"id":"e9fd3c9095c3807f","type":"function","z":"dc14bd796219d9ad","g":"48de5eb1ca74eafc","name":"API forecast","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2025\n// Created          : 03-08-2024, 21:19\n// Revised          : 09-02-2025, 15:40\n// Version          : 1.4\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2025 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fGetConfigProperty = global.get('getConfigProperty');\nconst fSetConfigProperty = global.get('setConfigProperty');\nconst getStartOfDayTimestamp = global.get('getStartOfDayTimestamp');\nconst getEndOfDayTimestamp = global.get('getEndOfDayTimestamp');\nconst intervalType = global.get('intervalType');\n\nconst nVRM_site_id = fGetConfigProperty(\"nVRM_site_id\"); //dotaz na data z globalni strukturu\n//const bearerToken = fGetConfigProperty(\"bearerToken\") || 0; //dotaz na data z globalni strukturu\nconst deposit_Token = fGetConfigProperty(\"deposit_Token\") || 0;\n\nconst tStart = getStartOfDayTimestamp();\nconst tStop = getEndOfDayTimestamp();\n\n// Nastavení hlaviček a těla požadavku\nmsg.headers = {\n    \"Content-Type\": \"application/json\",\n    \"x-authorization\": `Token ${deposit_Token}`\n};\n\n// Nastavení parametrů dotazu\nconst params = {\n    start: tStart, //\"beginning_of_day\"\n    end: tStop, // \"end_of_day\"\n    type: \"forecast\",\n    interval: intervalType,\n    //\"attributeCodes[]\": 'bs',\n    //show_instance: true,\n};\n\n\n// Debugging\nif (debug) {\n    node.warn(\"tStart: \" + tStart);\n    node.warn(\"tStop: \" + tStop);\n}\n\n\n// Nastavení payloadu\nmsg.payload = params;\n\n// Nastavení URL pro vytvoření tokenu\nmsg.url = `https://vrmapi.victronenergy.com/v2/installations/${nVRM_site_id}/stats?${serializeParams(params)}`;\n\nreturn msg;\n\n// Serialize the parameters object into a URL query string\nfunction serializeParams(params) {\n    return Object.keys(params)\n        .map(key => `${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`)\n        .join('&');\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":910,"y":1260,"wires":[["555d1b0cb34f6b9e"]]},{"id":"1fb6f6cc27313f0e","type":"ui_text","z":"dc14bd796219d9ad","g":"c8820631d746febb","group":"eff8c2fb7917b0ab","order":17,"width":6,"height":1,"name":"","label":"Solární predikce","format":"{{msg.payload}} kWh","layout":"row-spread","className":"Kulati_Dole","style":true,"font":"","fontSize":16,"color":"#ff7300","x":1500,"y":300,"wires":[]},{"id":"6c03e0e8b1e92ff7","type":"ui_text","z":"dc14bd796219d9ad","g":"c8820631d746febb","group":"eff8c2fb7917b0ab","order":15,"width":6,"height":1,"name":"","label":"Spotřeba predikce","format":"{{msg.payload}} kWh","layout":"row-spread","className":"","style":true,"font":"","fontSize":16,"color":"#ff7300","x":1510,"y":220,"wires":[]},{"id":"21f1e3012ce7e0ca","type":"function","z":"dc14bd796219d9ad","g":"c8820631d746febb","name":"SET GUI","func":"//*****************************************************************************\n//\n// File Name        : N/A \n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 07-08-2024, 18:15\n// Revised          : 07-08-2024, 19:03\n// Version          : 1.10\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n// Uložení dat do globálních proměnných, které jsou dostupné mezi flow\nconst nBuffer = global.get(\"sAPI_forecast\") || {};\n\n// Kontrola, zda nBuffer a nBuffer.totals existují\nif (nBuffer && nBuffer.totals && typeof nBuffer.totals.vrm_consumption_fc !== 'undefined') {\n    // Získání hodnoty a zaokrouhlení na jedno desetinné místo\n    msg.payload = parseFloat(nBuffer.totals.vrm_consumption_fc / 1000).toFixed(1);\n\n} else {\n    // Pokud nBuffer.totals nebo grid_history_to neexistuje, nastavíme payload na 0\n    msg.payload = 0;\n    if (debug) {\n        node.warn(\"vrm_consumption_fc is undefined\");\n    }\n}\n\n// Debugging\nif (debug) {\n    node.warn(\"vrm_consumption_fc: \" + msg.payload);\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1260,"y":220,"wires":[["6c03e0e8b1e92ff7"]]},{"id":"a2ae83b1d097b508","type":"function","z":"dc14bd796219d9ad","g":"c8820631d746febb","name":"SET GUI","func":"//*****************************************************************************\n//\n// File Name        : N/A \n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 07-08-2024, 18:15\n// Revised          : 07-08-2024, 19:03\n// Version          : 1.10\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n// Uložení dat do globálních proměnných, které jsou dostupné mezi flow\nconst nBuffer = global.get(\"sAPI_forecast\") || {};\n\n// Kontrola, zda nBuffer a nBuffer.totals existují\nif (nBuffer && nBuffer.totals && typeof nBuffer.totals.solar_yield_forecast !== 'undefined') {\n    // Získání hodnoty a zaokrouhlení na jedno desetinné místo\n    msg.payload = parseFloat(nBuffer.totals.solar_yield_forecast / 1000).toFixed(1);\n\n} else {\n    // Pokud nBuffer.totals nebo grid_history_to neexistuje, nastavíme payload na 0\n    msg.payload = 0;\n    if (debug) {\n        node.warn(\"solar_yield_forecast is undefined\");\n    }\n}\n\n// Debugging\nif (debug) {\n    node.warn(\"solar_yield_forecast: \" + msg.payload);\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1260,"y":300,"wires":[["1fb6f6cc27313f0e"]]},{"id":"97f2b4c61f843634","type":"delay","z":"dc14bd796219d9ad","g":"48de5eb1ca74eafc","name":"","pauseType":"delay","timeout":"3","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":720,"y":1260,"wires":[["e9fd3c9095c3807f","ba5991c8956711e3"]]},{"id":"ceead5239e9d9903","type":"ui_template","z":"dc14bd796219d9ad","d":true,"g":"1b84d1ab8eb2c216","group":"18637dcfe1e79007","name":"Graf Statistiky","order":25,"width":"20","height":"12","format":"<div>\n    <canvas id=\"myChart\"></canvas>\n</div>\n\n<script src=\"https://cdn.jsdelivr.net/npm/chart.js\"></script>\n<script>\n    (function(scope) {\n  // Získání dat z msg.payload\n  const data = scope.msg.payload || {};\n  \n  // Základní konfigurace pro Chart.js\n  const ctx = document.getElementById('myChart').getContext('2d');\n  \n  const config = {\n    type: 'bar', // typ grafu, sloupcový\n    data: {\n      labels: data.labels,\n      datasets: [\n        {\n          label: 'Pdc',\n          data: data.series1,\n          backgroundColor: 'rgba(255, 0, 0, 0.5)', // Červená barva\n          borderColor: 'rgba(255, 0, 0, 1)',\n          borderWidth: 1\n        },\n        {\n          label: 'Spotřeba',\n          data: data.series2,\n          backgroundColor: 'rgba(0, 255, 0, 0.5)', // Zelená barva\n          borderColor: 'rgba(0, 255, 0, 1)',\n          borderWidth: 1,\n          type: 'bar', // Druhá série jako sloupec\n          barPercentage: 0.5, // Úprava šířky sloupce\n          borderDash: [5, 5] // Čárkované linie\n        },\n        {\n          label: 'Solární energie',\n          data: data.series3,\n          borderColor: 'rgba(0, 0, 255, 1)', // Modrá barva pro linku\n          fill: false,\n          type: 'line' // Třetí série jako linka\n        }\n      ]\n    },\n    options: {\n      responsive: true,\n      scales: {\n        x: {\n          stacked: true // Seskupení sloupců\n        },\n        y: {\n          stacked: false // Sloupce nejsou sčítány\n        }\n      },\n      plugins: {\n        legend: {\n          display: true // Zobrazení legendy\n        }\n      }\n    }\n  };\n  \n  const myChart = new Chart(ctx, config);\n  \n  // Redraw the chart when new data comes in\n  scope.$watch('msg', function(msg) {\n    if (msg) {\n      myChart.data.labels = msg.payload.labels;\n      myChart.data.datasets[0].data = msg.payload.series1;\n      myChart.data.datasets[1].data = msg.payload.series2;\n      myChart.data.datasets[2].data = msg.payload.series3;\n      myChart.update();\n    }\n  });\n})(scope);\n</script>","storeOutMessages":true,"fwdInMessages":true,"resendOnRefresh":false,"templateScope":"local","className":"","x":1920,"y":500,"wires":[[]]},{"id":"a05dd8ea01366a2b","type":"ui_template","z":"dc14bd796219d9ad","d":true,"g":"1b84d1ab8eb2c216","group":"ae5a5f33ce6405c9","name":"","order":1,"width":0,"height":0,"format":"<div style=\"text-align: center;\">\n    <md-button class=\"md-raised md-primary\" ng-click=\"send({payload: 'always'})\">Zapnuto Vždy</md-button>\n    <md-button class=\"md-raised md-warn\" ng-click=\"send({payload: 'conditional'})\">Podmíněné Zapnutí</md-button>\n</div>\n\n<div style=\"margin-top: 20px;\">\n    <p><strong>Vyberte dny v týdnu:</strong></p>\n    <md-select ng-model=\"days\" multiple>\n        <md-option ng-value=\"'Pondělí'\">Pondělí</md-option>\n        <md-option ng-value=\"'Úterý'\">Úterý</md-option>\n        <md-option ng-value=\"'Středa'\">Středa</md-option>\n        <md-option ng-value=\"'Čtvrtek'\">Čtvrtek</md-option>\n        <md-option ng-value=\"'Pátek'\">Pátek</md-option>\n        <md-option ng-value=\"'Sobota'\">Sobota</md-option>\n        <md-option ng-value=\"'Neděle'\">Neděle</md-option>\n    </md-select>\n</div>\n\n<div style=\"margin-top: 20px;\">\n    <p><strong>Vyberte měsíce v roce:</strong></p>\n    <md-select ng-model=\"months\" multiple>\n        <md-option ng-value=\"'Leden'\">Leden</md-option>\n        <md-option ng-value=\"'Únor'\">Únor</md-option>\n        <md-option ng-value=\"'Březen'\">Březen</md-option>\n        <md-option ng-value=\"'Duben'\">Duben</md-option>\n        <md-option ng-value=\"'Květen'\">Květen</md-option>\n        <md-option ng-value=\"'Červen'\">Červen</md-option>\n        <md-option ng-value=\"'Červenec'\">Červenec</md-option>\n        <md-option ng-value=\"'Srpen'\">Srpen</md-option>\n        <md-option ng-value=\"'Září'\">Září</md-option>\n        <md-option ng-value=\"'Říjen'\">Říjen</md-option>\n        <md-option ng-value=\"'Listopad'\">Listopad</md-option>\n        <md-option ng-value=\"'Prosinec'\">Prosinec</md-option>\n    </md-select>\n</div>\n\n<script>\n    $scope.send = function(msg) {\n        var days = $scope.days || [];\n        var months = $scope.months || [];\n        msg.payload = {days: days, months: months, mode: msg.payload};\n        node.send(msg);\n    };\n</script>\n","storeOutMessages":true,"fwdInMessages":true,"resendOnRefresh":true,"templateScope":"local","className":"","x":1740,"y":500,"wires":[[]]},{"id":"function_node_id","type":"function","z":"dc14bd796219d9ad","g":"c8820631d746febb","name":"Set DateTime","func":"//*****************************************************************************\n//\n// File Name        : GUI\n// Title            : GUI\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 14-08-2024, 12:00\n// Revised          : 12-11-2024, 20:36\n// Version          : 1.01\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n// definice globalních funkci\nconst fGetConfigProperty = global.get('getConfigProperty');\nconst fSetConfigProperty = global.get('setConfigProperty');\nconst removeSpacesAroundDots = global.get('removeSpacesAroundDots');\nconst nConvertSignetUnsignet = global.get('nConvertSignetUnsignet');\nconst mExtractTime = global.get('mExtractTime');\nconst sExtractTime = global.get('sExtractTime');\nconst sCounty_Code = global.get('sCounty_Code');\nconst sTZidentifier = global.get('sTZidentifier');\n\nconst date = new Date();\nconst sDate = date.toLocaleString(sCounty_Code, { timeZone: sTZidentifier });\nconst oDate_CZ = sExtractTime(removeSpacesAroundDots(sDate));\n\nconst time = oDate_CZ.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });\nconst dateStr = oDate_CZ.toLocaleDateString('cs-CZ', { year: '2-digit', day: '2-digit', month: '2-digit' }).replace(/\\s/g, '').replace(/\\//g, '.'); // Odstranění mezer a nahrazení lomítek tečkami\nconst dateTimeText = `${time} ${dateStr}`;\n\nmsg.payload = dateTimeText;\nmsg.fcolor = \"white\"; // Barva textu, můžete změnit dle potřeby\n\nreturn msg;\n\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1280,"y":340,"wires":[["2cf2059778055ad7"]]},{"id":"30fb0930ec720c71","type":"link in","z":"dc14bd796219d9ad","g":"c8820631d746febb","name":"link in 2","links":["9bdbf5d33911e135"],"x":1125,"y":340,"wires":[["function_node_id","4cd97b94f00e3dab"]]},{"id":"56bd165152f32606","type":"http request","z":"dc14bd796219d9ad","g":"48de5eb1ca74eafc","name":"","method":"GET","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":1270,"y":1380,"wires":[["ba5c1d360d2b53c9","b667f0259436c1e3"]]},{"id":"ba5c1d360d2b53c9","type":"debug","z":"dc14bd796219d9ad","g":"48de5eb1ca74eafc","name":"Data from the function node","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload","statusType":"auto","x":1500,"y":1320,"wires":[]},{"id":"b667f0259436c1e3","type":"function","z":"dc14bd796219d9ad","g":"48de5eb1ca74eafc","name":"Set API_consumption","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 25-08-2024, 18:07\n// Revised          : 25-08-2024, 20:27\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\nconst sAPI_consumption = msg.payload; //nacteni vstupu\n\n // Ulozeni dat do globalnich promennych, ktere jsou dostupne mezi flow\nglobal.set(\"sAPI_consumption\", sAPI_consumption);\n\n// Debugging\nif (debug) {\n    node.warn(\"sAPI_consumption: \" + sAPI_consumption);\n}\n\nreturn null;","outputs":0,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1480,"y":1380,"wires":[]},{"id":"3e1fc476c6a43e8a","type":"function","z":"dc14bd796219d9ad","g":"48de5eb1ca74eafc","name":"API consumption","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2025\n// Created          : 03-08-2024, 21:19\n// Revised          : 09-02-2025, 15:41\n// Version          : 1.2\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2025 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fGetConfigProperty = global.get('getConfigProperty');\nconst fSetConfigProperty = global.get('setConfigProperty');\nconst getStartOfDayTimestamp = global.get('getStartOfDayTimestamp');\nconst getEndOfDayTimestamp = global.get('getEndOfDayTimestamp');\nconst intervalType = global.get('intervalType');\n\nconst nVRM_site_id = fGetConfigProperty(\"nVRM_site_id\"); //dotaz na data z globalni strukturu\n//const bearerToken = fGetConfigProperty(\"bearerToken\") || 0; //dotaz na data z globalni strukturu\nconst deposit_Token = fGetConfigProperty(\"deposit_Token\") || 0;\n\n\nconst tStart = getStartOfDayTimestamp();\nconst tStop = getEndOfDayTimestamp();\n\n// Nastavení hlaviček a těla požadavku\nmsg.headers = {\n    \"Content-Type\": \"application/json\",\n    \"x-authorization\": `Token ${deposit_Token}`\n};\n\n// Nastavení parametrů dotazu\nconst params = {\n    start: tStart, //\"beginning_of_day\"\n    end: tStop, // \"end_of_day\"\n    type: \"consumption\",\n    interval: intervalType,\n    //\"attributeCodes[]\": 'bs',\n    //show_instance: true,\n};\n\n\n// Debugging\nif (debug) {\n    node.warn(\"tStart: \" + tStart);\n    node.warn(\"tStop: \" + tStop);\n}\n\n\n// Nastavení payloadu\nmsg.payload = params;\n\n// Nastavení URL pro vytvoření tokenu\nmsg.url = `https://vrmapi.victronenergy.com/v2/installations/${nVRM_site_id}/stats?${serializeParams(params)}`;\n\nreturn msg;\n\n// Serialize the parameters object into a URL query string\nfunction serializeParams(params) {\n    return Object.keys(params)\n        .map(key => `${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`)\n        .join('&');\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1090,"y":1380,"wires":[["56bd165152f32606"]]},{"id":"ba5991c8956711e3","type":"delay","z":"dc14bd796219d9ad","g":"48de5eb1ca74eafc","name":"","pauseType":"delay","timeout":"3","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":900,"y":1380,"wires":[["3e1fc476c6a43e8a"]]},{"id":"aa384c4538409199","type":"function","z":"dc14bd796219d9ad","g":"1b84d1ab8eb2c216","name":"Parse_DATA_graf","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> haceSoft 2024\n// Created          : 14-07-2024, 11:00\n// Revised          : 26-08-2024, 19:55\n// Version          : 2.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uvedený jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 haceSoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n// Konfigurační proměnná pro výběr intervalu\nconst intervalType = global.get('intervalType'); // Může být \"hours\" nebo \"15mins\"\n\n// Definice globalních funkcí\nconst removeSpacesAroundDots = global.get('removeSpacesAroundDots');\nconst sExtractTime = global.get('sExtractTime');\nconst sCounty_Code = global.get('sCounty_Code');\nconst sTZidentifier = global.get('sTZidentifier');\n\n// Konfigurace sérií\n// Konfigurační objekt seriesConfig: Konfigurace sérií je definována jedním objektem, což usnadňuje přidávání, \n// odstraňování nebo modifikaci jednotlivých sérií.\n// name - urcuje jmeno ktere se bude hleted v nactenych datech z VRM API.\n// type - urcuje chovani krivky, real bude na konci ukoncena v prostoru a forecast bude tak jak prijdou data.\n// sign - urcuje zda bude vykreslena na kladne strane a nebo zaporne strane grafu (pod čarou).\n// scale - urcuje meritko robrazeni.\n// color - definuje se barva primky - asi nefunguje\n// smootch - true urcuje zda bude bude křivka vyhlazena pomocí pohyblivého průměru.\n// api - urcuje odkud se maji brat data : global.get(\"sAPI_live_feed\")  nebo global.get(\"sAPI_forecast\")\n\nconst seriesConfig = [\n    { name: \"grid_history_to\", label: \"Grid History To\", type: \"real\", sign: false, scale: 1, color: \"#FF0000\", smooth: false, api: \"live_feed\" },\n    { name: \"grid_history_from\", label: \"Grid History From\", type: \"real\", sign: true, scale: 1, color: \"#00ff00\", smooth: false, api: \"live_feed\" },\n    { name: \"total_consumption\", label: \"Total Consumption\", type: \"real\", sign: true, scale: 1, color: \"#0000FF\", smooth: false, api: \"live_feed\" },\n    { name: \"total_solar_yield\", label: \"Total Solar Yield\", type: \"real\", sign: true, scale: 1, color: \"#FFFF00\", smooth: false, api: \"live_feed\" },\n    { name: \"vrm_consumption_fc\", label: \"VRM Consumption Forecast\", type: \"forecast\", sign: true, scale: 0.001, color: \"#FF00FF\", smooth: true, api: \"forecast\" },\n    { name: \"solar_yield_forecast\", label: \"Solar Yield Forecast\", type: \"forecast\", sign: true, scale: 0.001, color: \"#00FFFF\", smooth: true, api: \"forecast\" },\n    { name: \"Pdc\", label: \"Pdc\", type: \"real\", sign: true, scale: 0.001, color: \"#8A2BE2\", smooth: false, api: \"live_feed\" },\n    { name: \"bs\", label: \"Battery State\", type: \"real\", sign: true, scale: 0.01, color: \"#A52A2A\", smooth: false, api: \"live_feed\" },\n    { name: \"bv\", label: \"Battery Voltage\", type: \"real\", sign: true, scale: 0.01, color: \"#5F9EA0\", smooth: false, api: \"live_feed\" },\n];\n\n// Inicializace sérií a popisků\nlet series = [], labels = [];\ninitializeSeriesAndLabels();\n\n// Načtení dat do globálních proměnných, které jsou dostupné mezi flow\nconst nBuffer_live_feed = global.get(\"sAPI_live_feed\") || {}; // config.api === \"live_feed\"\nconst nBuffer_forecast = global.get(\"sAPI_forecast\") || {}; // config.api === \"forecast\"\n\n// Kontrola, zda nBuffer_live_feed.records existuje\nif (nBuffer_live_feed.records && nBuffer_forecast.records) {\n    // Zpracování dat pro každou sérii na základě konfigurace\n    seriesConfig.forEach((config, index) => {\n        let records;\n        if (config.api === \"live_feed\") {\n            records = nBuffer_live_feed.records[config.name];\n        } else if (config.api === \"forecast\") {\n            records = nBuffer_forecast.records[config.name];\n        }\n        processSeries(records, series[index], config.sign, config.scale, config.type);\n\n        // Aplikace vyhlazování, pokud je zapnuto\n        if (config.smooth) {\n          series[index] = smoothData(series[index]); // Aplikace vyhlazování\n        }\n    });\n\n    // Vytvoření výstupního formátu\n    msg.payload = [{\n        \"series\": seriesConfig.map(s => s.label),\n        \"data\": series,\n        \"labels\": labels,\n        \"colors\": seriesConfig.map(s => s.color),\n        \"lines\": Array(seriesConfig.length).fill(true)\n    }];\n} else {\n    if (debug) {\n        node.warn(\"nBuffer.records nebo jeho některé části neexistují nebo nejsou pole.\");\n    }\n}\n\n// Debugging\nif (debug) {\n    node.warn(\"intervalType: \" + intervalType);\n    node.warn(\"series: \" + JSON.stringify(series));\n    node.warn(\"labels: \" + JSON.stringify(labels));\n}\n\nreturn msg;\n\n// Funkce pro inicializaci sérií a popisků\nfunction initializeSeriesAndLabels() {\n    const intervalCount = intervalType === \"15mins\" ? 96 : 24;\n    series = Array(seriesConfig.length).fill().map(() => Array(intervalCount).fill(0));\n\n    labels = Array.from({ length: intervalCount }, (_, i) => {\n        const hours = String(Math.floor(i / (intervalType === \"15mins\" ? 4 : 1))).padStart(2, '0');\n        const minutes = intervalType === \"15mins\" ? String((i % 4) * 15).padStart(2, '0') : \"00\";\n        return `${hours}:${minutes}`;\n    });\n}\n\n// Pomocná funkce pro získání indexu intervalu z timestampu\nfunction getIntervalIndex(timestamp) {\n    const date = new Date(timestamp);\n    const hours = date.getHours();\n    const minutes = date.getMinutes();\n    if (intervalType === \"15mins\") {\n        return hours * 4 + Math.floor(minutes / 15);\n    } else if (intervalType === \"hours\") {\n        return hours;\n    }\n    return 0; // default index if none matched\n}\n\n// Pomocná funkce pro zpracování hodnot s ohledem na znaménko\nfunction processValue(value, isPositive, scale) {\n    let processedValue = parseFloat(value) * scale;\n    return isPositive ? processedValue : -processedValue;\n}\n\nfunction interpolateData(data) {\n    const interpolatedData = [...data];  // Kopie dat pro manipulaci\n    let lastKnownValue = null;\n    let startIndex = null;\n\n    // Najdi první známou hodnotu (není null, undefined nebo 0)\n    for (let i = 0; i < data.length; i++) {\n        if (data[i] !== null && data[i] !== undefined && data[i] !== 0) {\n            lastKnownValue = parseFloat(data[i]);\n            startIndex = i;\n            break;\n        }\n    }\n\n    // Procházej zbytek dat a interpoluj pouze hodnoty null, undefined nebo 0\n    for (let i = startIndex + 1; i < data.length; i++) {\n        if (data[i] !== null && data[i] !== undefined && data[i] !== 0) {\n            const nextKnownValue = parseFloat(data[i]);\n            const step = (nextKnownValue - lastKnownValue) / (i - startIndex);\n            for (let j = startIndex + 1; j < i; j++) {\n                interpolatedData[j] = (lastKnownValue + step * (j - startIndex)).toFixed(2);\n            }\n            lastKnownValue = nextKnownValue;\n            startIndex = i;\n        }\n    }\n\n    return interpolatedData;\n}\n\n\n// Vylepšená funkce pro vyhlazení dat\nfunction smoothData(data, windowSize = 2) {\n    const smoothedData = [];\n    for (let i = 0; i < data.length; i++) {\n        const start = Math.max(0, i - windowSize);\n        const end = Math.min(data.length, i + windowSize + 1);\n        const windowData = data.slice(start, end).filter(v => v !== null);\n\n        const sum = windowData.reduce((acc, val) => acc + parseFloat(val), 0);\n        const avg = windowData.length ? (sum / windowData.length).toFixed(2) : null;\n        smoothedData.push(avg);\n    }\n    return smoothedData;\n}\n\nfunction processSeries(records, seriesData, isPositive, scale, type) {\n    const now = new Date();\n    if (Array.isArray(records)) {\n        records.forEach(item => {\n            if (item && item[0] && item[1]) {\n                const index = getIntervalIndex(item[0]);\n                const recordDate = new Date(item[0]);\n                const value = parseFloat(item[1]);\n\n                if (type === \"real\") {\n                    if (recordDate < now) {\n                        seriesData[index] = value !== null && value !== undefined ? processValue(value, isPositive, scale).toFixed(2) : null;\n                    } else {\n                        seriesData[index] = null;\n                    }\n                } else if (type === \"forecast\") {\n                    if (value !== null && value !== undefined) {\n                        seriesData[index] = processValue(value, isPositive, scale).toFixed(2);\n                    } else {\n                        seriesData[index] = null;\n                    }\n                }\n            }\n        });\n        // Aplikovat interpolaci jen pokud type === \"forecast\"\n        if (type === \"forecast\") {\n            // Po zpracování celé série aplikujeme interpolaci chybějících dat (null a undefined)\n            const interpolatedSeriesData = interpolateData(seriesData);\n\n            // Uložení interpolovaných dat zpět do series[index]\n            seriesData.splice(0, seriesData.length, ...interpolatedSeriesData);\n        }\n    }\n}\n\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2110,"y":500,"wires":[[]]},{"id":"823d13d79f9bfc83","type":"inject","z":"dc14bd796219d9ad","g":"e5111d27ef0bf43d","name":"Testovací volání logu","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":420,"y":260,"wires":[["ea8e613bd96afead"]]},{"id":"ea8e613bd96afead","type":"function","z":"dc14bd796219d9ad","g":"e5111d27ef0bf43d","name":"Funkce pro logování","func":"","outputs":1,"timeout":"","noerr":0,"initialize":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 20-07-2024, 17:01\n// Revised          : 28-10-2024, 13:34\n// Version          : 1.01\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n// Globální funkce pro logování\nglobal.set('fWrite_LogFile', function fWrite_LogFile(variableName, value) {\n\n    // Získání názvu souboru z globální proměnné\n    const path_file = global.get(\"sValid_Patch\") + \"/\"; // nacti zjistenou cesta k souborum dle HW.\n    //const path_file = global.get(\"path_file\");          // cesta kam ukladat\n    const log_file_name = global.get(\"log_file_name\");  // nazev logovaciho souboru \n    const path_config = path_file + log_file_name;\n\n    // Formát aktuálního data a času\n    const now = new Date();\n    const formattedDate = now.toLocaleDateString('cs-CZ', { day: '2-digit', month: '2-digit', year: 'numeric' });\n    const formattedTime = now.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit', second: '2-digit' });\n\n    // Sestavení logovacího textu\n    const logText = `${formattedDate} - ${formattedTime} - ${variableName} : ${value}\\n`;\n\n    // msg.filename: Určuje cestu k souboru, do kterého se bude zapisovat.\n    // msg.payload: Obsah, který se bude zapisovat do souboru. Může to být textový řetězec nebo objekt, který se převede na JSON.\n\n    // Nastavení zprávy pro zápis do souboru\n\n    // Debugging\n    if (debug) {\n        node.warn(\"path_config: \" + path_config);\n        node.warn(\"path_file: \" + JSON.stringify(path_file));\n        node.warn(\"log_file_name: \" + JSON.stringify(log_file_name));\n    }\n\n\n    const msg = {};\n    msg.filename = path_config;\n    msg.payload = logText;       // Obsah logu\n    //msg.payload = JSON.stringify(logText, null, 2); // Konvertuje prázdný objekt na JSON řetězec\n\n    node.send(msg);\n    //return msg;\n});\n\n// Příklad volání funkce fLogovani\n//fWrite_LogFile(\"moje promenna\", true);","finalize":"","libs":[],"x":680,"y":260,"wires":[["edf36748480e70ff"]]},{"id":"edf36748480e70ff","type":"file","z":"dc14bd796219d9ad","g":"e5111d27ef0bf43d","name":"Write Log File","filename":"filename","filenameType":"msg","appendNewline":true,"createDir":false,"overwriteFile":"false","encoding":"none","x":900,"y":260,"wires":[[]]},{"id":"1a317d0976a1ddb3","type":"inject","z":"dc14bd796219d9ad","g":"e5111d27ef0bf43d","name":"Each 15 min","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"900","crontab":"","once":false,"onceDelay":"1","topic":"","payload":"","payloadType":"date","x":400,"y":380,"wires":[["784b0c28936b3da9","02a502c924056fb6"]]},{"id":"ebf55f4e991cb354","type":"link out","z":"dc14bd796219d9ad","g":"48de5eb1ca74eafc","name":"LOAD_CONFIG_API","mode":"link","links":["ca542ad4ccd6c23d"],"x":875,"y":1220,"wires":[]},{"id":"50637404bfdd22fe","type":"ui_switch","z":"dc14bd796219d9ad","g":"092c429e967f8893","name":"sGridChargingSwitch","label":"Grid Charging","tooltip":"","group":"b1eb05edab318eb0","order":15,"width":6,"height":1,"passthru":true,"decouple":"false","topic":"topic","topicType":"msg","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","animate":true,"className":"Kulati_Nahore","x":620,"y":1700,"wires":[["b8d434eb9ca5e1f2"]]},{"id":"5af06f5974ff0a1f","type":"ui_numeric","z":"dc14bd796219d9ad","g":"092c429e967f8893","name":"","label":"Grid Charging to SOC","tooltip":"","group":"b1eb05edab318eb0","order":16,"width":6,"height":1,"wrap":false,"passthru":true,"topic":"topic","topicType":"msg","format":"{{value | number:0}} %","min":"20","max":"100","step":"1","className":"Kulati_Dole","x":1080,"y":1700,"wires":[["32f717d7a39e56b8"]]},{"id":"32f717d7a39e56b8","type":"function","z":"dc14bd796219d9ad","g":"092c429e967f8893","name":"Set nGridChargingSOC","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 25-07-2024, 09:43\n// Revised          : 10-09-2024, 10:23\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst nGridChargingSOC = msg.payload; //nacteni vstupu\nfSetConfigProperty(\"nGridChargingSOC\", nGridChargingSOC); //ulozit data do globalni struktury\n\n// Debugging\nif (debug) {\n    node.warn(\"nGridChargingSOC: \" + nGridChargingSOC);\n}\n\nreturn null;","outputs":0,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1330,"y":1700,"wires":[]},{"id":"b8d434eb9ca5e1f2","type":"function","z":"dc14bd796219d9ad","g":"092c429e967f8893","name":"SET CONFIG","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 25-07-2024, 09:43\n// Revised          : 10-09-2024, 10:24\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fGetConfigProperty = global.get('getConfigProperty');\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst sGridChargingSwitch = msg.payload; //nacteni vstupu\nconst nGridChargingSOC = fGetConfigProperty(\"nGridChargingSOC\") || 0; //dotaz na data z globalni strukturu\nfSetConfigProperty(\"sGridChargingSwitch\", sGridChargingSwitch); //ulozit data do globalni struktury\n\nmsg.payload = nGridChargingSOC;    //nastaveni hodnoty\nmsg.enabled = sGridChargingSwitch; //enable switch\n\n// Debugging\nif (debug) {\n    node.warn(\"sGridChargingSwitch: \" + sGridChargingSwitch);\n    node.warn(\"nGridChargingSOC: \" + nGridChargingSOC);\n    node.warn(\"msg.payload: \" + msg.payload);\n    node.warn(\"msg.enabled: \" + msg.enabled);\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":860,"y":1700,"wires":[["5af06f5974ff0a1f"]]},{"id":"4da4a259c9bf266f","type":"function","z":"dc14bd796219d9ad","g":"092c429e967f8893","name":"SET GUI","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 31-07-2024, 17:39\n// Revised          : 15-09-2024, 11:01\n// Version          : 1.2\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fGetConfigProperty = global.get('getConfigProperty');\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst sBuffer = !!fGetConfigProperty(\"sGridChargingSwitch\"); //dotaz na data z globalni strukturu\n\nif (sBuffer){// toto zpusobí, ze když je uložena konfigurace se zapnutym switchem, tak zde se toto nastaveni ignoruje. \n//Je to z toho duvodu aby se nabijeni baterie samo vypnulo po dosazeni SOC a dale nepokracovalo\n    return null\n}\nmsg.payload  = sBuffer; //SET switch to read data\n\n//Dvojitý negátor !!: Použití dvou negátorů ! převede jakoukoli hodnotu na její boolean ekvivalent.\n// První ! hodnotu zneguje (což znamená, že true se změní na false a naopak), a druhý ! změní hodnotu zpět na boolean:\n//Pokud je původní hodnota \"truthy\" (např. 1, true, ne-prázdný řetězec), výsledek bude true.\n//Pokud je původní hodnota \"falsy\" (např. 0, false, NaN, undefined, prázdný řetězec), výsledek bude false.\n\n// Debugging\nif (debug) {\n    node.warn(\"sGridChargingSwitch: \" + sBuffer);\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":360,"y":1700,"wires":[["50637404bfdd22fe"]]},{"id":"065fe908fea8bd39","type":"function","z":"dc14bd796219d9ad","g":"48de5eb1ca74eafc","name":"triger","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 15-09-2024, 09:43\n// Revised          : 15-09-2024, 10:27\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n\nconst msgTrigger = msg.payload; //nacteni vstupu\n\n\nif (msgTrigger == false) {\n    return 10;\n} else {\n    return true;\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":910,"y":1320,"wires":[[]]},{"id":"3a87775a04df95f8","type":"delay","z":"dc14bd796219d9ad","g":"48de5eb1ca74eafc","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":460,"y":1180,"wires":[["79fee107e7a6a7ff","97f2b4c61f843634"]]},{"id":"0230cbe8d5c6e7b5","type":"debug","z":"dc14bd796219d9ad","g":"48de5eb1ca74eafc","name":"debug 54","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"live_feed","targetType":"msg","statusVal":"payload","statusType":"auto","x":920,"y":1220,"wires":[]},{"id":"f2475111cdae5c1a","type":"ui_text","z":"dc14bd796219d9ad","g":"c8820631d746febb","group":"eff8c2fb7917b0ab","order":11,"width":6,"height":1,"name":"","label":"⏳ Doba provozu:","format":"<p class=\"label_time\">{{msg.payload}}</p>","layout":"row-spread","className":"Kulati_Nahore","style":true,"font":"","fontSize":16,"color":"#ffbb00","x":1510,"y":380,"wires":[]},{"id":"4cd97b94f00e3dab","type":"function","z":"dc14bd796219d9ad","g":"c8820631d746febb","name":"UPTIME","func":"//*****************************************************************************\n//\n// File Name        : GUI\n// Title            : GUI\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 27-10-2024, 18:26\n// Revised          : 28-10-2024, 00:00\n// Version          : 1.00\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n// Funkce pro formátování uptime do kratšího formátu \"Xd Yh Zm\"\nfunction formatUptimeShort(seconds) {\n    const days = Math.floor(seconds / (3600 * 24));\n    const hours = Math.floor((seconds % (3600 * 24)) / 3600);\n    const minutes = Math.floor((seconds % 3600) / 60);\n    const secs = Math.floor(seconds % 60);\n\n    // Sestavíme kratší uptime string\n    let uptimeString = \"\";\n    if (days > 0) uptimeString += `${days}d `;\n    if (hours > 0 || days > 0) uptimeString += `${hours}h `;\n    uptimeString += `${minutes}m ${secs}s`;  // Sekundy přidáme vždy pro přesnost\n\n    return uptimeString.trim();\n}\n\n// Načtení start time z globální proměnné\nconst startTime = global.get(\"startTime\");\n\nif (!startTime) {\n    // Pokud startTime není definován, vrátí zprávu o chybě\n    msg.payload = \"Uptime není dostupný. Start time není nastaven.\";\n    return msg;\n}\n\n// Výpočet uptime\nconst now = Date.now();\nconst uptimeSeconds = Math.floor((now - startTime) / 1000); // rozdíl v sekundách\n\n// Převod uptime na kratší formát \"Xd Yh Zm\"\nconst uptimeText = formatUptimeShort(uptimeSeconds);\n\nmsg.payload = uptimeText;\nmsg.fcolor = \"white\"; // Barva textu, můžete změnit dle potřeby\n\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1260,"y":380,"wires":[["f2475111cdae5c1a"]]},{"id":"50e7df9e8b3bc878","type":"link out","z":"dc14bd796219d9ad","g":"e5111d27ef0bf43d","name":"RESET","mode":"link","links":["175fc04163da34f2","ad8e6c051ba1f7d6"],"x":645,"y":200,"wires":[]},{"id":"3c5fa477299720b4","type":"ui_text","z":"dc14bd796219d9ad","g":"1a9d21242a01ebdd","group":"eff8c2fb7917b0ab","order":23,"width":6,"height":1,"name":"","label":"{{msg.tCharge_efficiency}}","format":"<font color={{fcolor}}>{{msg.payload.nBattery_input_Wh}} Wh","layout":"row-spread","className":"","style":false,"font":"","fontSize":16,"color":"#000000","x":1430,"y":1000,"wires":[]},{"id":"7b225228052bc2f0","type":"ui_text","z":"dc14bd796219d9ad","g":"1a9d21242a01ebdd","group":"eff8c2fb7917b0ab","order":23,"width":6,"height":1,"name":"","label":"{{msg.tDischarge_efficiency}}","format":"<font color={{fcolor}}>{{msg.payload.nBattery_output_Wh}} Wh","layout":"row-spread","className":"","style":false,"font":"","fontSize":16,"color":"#000000","x":1430,"y":1040,"wires":[]},{"id":"c52e4f69764e8ab7","type":"function","z":"dc14bd796219d9ad","g":"1a9d21242a01ebdd","name":"Battery W couter","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2025\n// Created          : 04-02-2025, 18:19\n// Revised          : 07-02-2024, 17:56\n// Version          : 1.11\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2025 hacesoft.\n//\n//*****************************************************************************\n\nconst debug = false;  // Debugging flag\n\n// Base64 obrázek pro vybíjení\nconst imageBase64Vybijeni = \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAUCAYAAAD2rd/BAAAACXBIWXMAAC4jAAAuIwF4pT92AAAA20lEQVRIx2NkQALatk/+MwwScPWwDCNeBdq2T/4PFgcTdMtgciwhNzHCBGFRgE3R1cMyjGsefqabh0LkeeFuQU8aLMQa8uTDn0ER8kyDwRFlpmoEkwYs5okOYXZmJpo7euK5O0MjhGEg30iFYBHHQmvLsAF8IUnIHJbBGKJsbKL/h0SSIAYMaAjDkgZ6SP/69RqWZv/TzMHE5HBizcnU4WfA1cYZVEmCGE8THcJX3/2lqWPT9tzEagfZVfOZ+19p5lij2eeINp9oB//T4hr8TbnRNjEVHMs41LpIABH4dFp/2F+DAAAAAElFTkSuQmCC\";\n\n// Base64 obrázek pro nabíjení\nconst imageBase64Nabijeni = \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAUCAYAAAD2rd/BAAAACXBIWXMAAC4jAAAuIwF4pT92AAABBElEQVRIx2NkQALatk/+MwwScPWwDCNeBdq2T/4PFgcTdMtgciwhNzHCBGFRgE3R1cMyjGsefqabh0LkeeFuQU8aLMQa8uTDH5IsLTNVg7O7Tt+immeYBkP0szMzMbAzM6F4Ej1pwGKehRRDKXEQIZBvpEKU2kERwjDHElPEsdDDUnS5iefu4JQj5HiWwRiybGyi/wd1khgypQRy0kAGv369Zvz16zUjTZMEuuXI0Y3LYTA5dLWZOvwMuNo4gyJJ4PMQ2SF89d1f8lteROhN23OTYZaLOoZasqvmM/e/ku1gYvUazT5HUC3RDv6nxUWSIw2O3kDopXv7c7RNTL5jGYdaFwkAcDqHF7rfKAAAAAAASUVORK5CYII=\";\n\n// Globální funkce\nconst nConvertSignetUnsignet = global.get('nConvertSignetUnsignet');\n\n// Načtení aktuálních hodnot\nlet SOC_current = global.get(\"nBattery_State_Charge\") || 50;  // SOC v %\nlet SOC_previous = global.get(\"SOC_previous\") || SOC_current;  // Minulý SOC (%)\nlet SOC_cumulative = global.get(\"SOC_cumulative\") || 0;  // Kumulativní SOC pro daný směr\n\n// Sledování posledního směru SOC\nlet last_SOC_direction = global.get(\"last_SOC_direction\") || null;\n\n// Načtení přijaté a odebrané energie\nlet nBattery_Power = global.get(\"nBattery_Power\") || 0; // Výkon baterie (W)\nlet nBattery_input_Wh = global.get(\"nBattery_input_Wh\") || 0;\nlet nBattery_output_Wh = global.get(\"nBattery_output_Wh\") || 0;\n\n// Převedení výkonu na kladné/záporné číslo\nlet nSignet_Battery_Power = nConvertSignetUnsignet(nBattery_Power);\n\n// Výpočet přijaté a odebrané energie\nif (nSignet_Battery_Power > 0) {\n    nBattery_input_Wh += nSignet_Battery_Power / 3600;  // Přijatá energie do baterie\n} else {\n    nBattery_output_Wh += Math.abs(nSignet_Battery_Power) / 3600;  // Odebraná energie z baterie\n}\n\n// Výpočet změny SOC\nlet delta_SOC = SOC_current - SOC_previous;\nlet current_SOC_direction = delta_SOC > 0 ? \"charge\" : delta_SOC < 0 ? \"discharge\" : last_SOC_direction;\n\n// Pokud se změnil směr SOC (z nabíjení na vybíjení nebo opačně), uzavřeme předchozí výpočet\nif (current_SOC_direction !== last_SOC_direction && last_SOC_direction !== null) {\n    if (last_SOC_direction === \"charge\" && nBattery_input_Wh > 0) {\n        let charge_efficiency = nBattery_input_Wh > 0 ? (SOC_cumulative / nBattery_input_Wh) * 100 : 0;\n        global.set(\"last_charge_efficiency\", charge_efficiency.toFixed(2));\n    }\n    if (last_SOC_direction === \"discharge\" && nBattery_output_Wh > 0) {\n        let discharge_efficiency = Math.abs(SOC_cumulative) > 0 ? (nBattery_output_Wh / Math.abs(SOC_cumulative)) * 100 : 0;\n        global.set(\"last_discharge_efficiency\", discharge_efficiency.toFixed(2));\n    }\n\n    // Reset SOC kumulace při změně směru\n    SOC_cumulative = 0;\n    //nBattery_input_Wh = 0;\n    //nBattery_output_Wh = 0;\n}\n\n// Kumulace SOC pro aktuální směr\nSOC_cumulative += delta_SOC;\n\n// Uložení nových hodnot do global contextu\nglobal.set(\"nBattery_input_Wh\", nBattery_input_Wh);\nglobal.set(\"nBattery_output_Wh\", nBattery_output_Wh);\nglobal.set(\"SOC_previous\", SOC_current);\nglobal.set(\"SOC_cumulative\", SOC_cumulative);\nglobal.set(\"last_SOC_direction\", current_SOC_direction);\n\n// Načtení posledních vypočtených efektivit\nlet charge_efficiency = global.get(\"last_charge_efficiency\") || 0;\nlet discharge_efficiency = global.get(\"last_discharge_efficiency\") || 0;\n\n// Převeďte hodnoty na čísla, pokud jsou uloženy jako řetězce\ncharge_efficiency = Number(charge_efficiency);\ndischarge_efficiency = Number(discharge_efficiency);\n\n// Přidání ikon do zpráv\nmsg.tDischarge_efficiency = `<img src=\"${imageBase64Vybijeni}\"> ${discharge_efficiency.toFixed(1)}% výdej`;\nmsg.tCharge_efficiency = `<img src=\"${imageBase64Nabijeni}\"> ${charge_efficiency.toFixed(1)}% příjem`;\n\n// Debugging zprávy\nif (debug) {\n    node.warn(`SOC_current: ${SOC_current}%, SOC_previous: ${SOC_previous}%, ΔSOC: ${delta_SOC}%`);\n    node.warn(`Přijatá energie: ${nBattery_input_Wh} Wh, Odebraná energie: ${nBattery_output_Wh} Wh`);\n    node.warn(`Efektivita nabíjení: ${charge_efficiency}%, Efektivita vybíjení: ${discharge_efficiency}%`);\n    node.warn(`Aktuální směr SOC: ${current_SOC_direction}, Kumulovaný SOC: ${SOC_cumulative}`);\n}\n\n// Výstupní zpráva\nmsg.payload = {\n    SOC_current,\n    SOC_previous,\n    delta_SOC,\n    SOC_cumulative,\n    nBattery_input_Wh: nBattery_input_Wh.toFixed(2),\n    nBattery_output_Wh: nBattery_output_Wh.toFixed(2),\n    current_SOC_direction\n};\n\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1230,"y":1020,"wires":[["7b225228052bc2f0","3c5fa477299720b4"]]},{"id":"bb4bdfb7933e157a","type":"function","z":"dc14bd796219d9ad","g":"1a9d21242a01ebdd","name":"Reset_Battery_couter","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 05-02-2025, 14:19\n// Revised          : 05-02-2024, 15:18\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2025 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Zapni debug zprávy, pokud chceš vidět detaily\n\n\n// Reset hodnot\nglobal.set(\"nBattery_input_Wh\", 0);\nglobal.set(\"nBattery_output_Wh\", 0);\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1240,"y":980,"wires":[[]]},{"id":"ad8e6c051ba1f7d6","type":"link in","z":"dc14bd796219d9ad","g":"1a9d21242a01ebdd","name":"link in 3","links":["50e7df9e8b3bc878"],"x":1075,"y":980,"wires":[["bb4bdfb7933e157a"]]},{"id":"c30267afbab42020","type":"inject","z":"dc14bd796219d9ad","g":"1a9d21242a01ebdd","name":"RESET IN 23:59:59","props":[{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":730,"y":980,"wires":[["bb4bdfb7933e157a"]]},{"id":"9a1f199e2e88d24c","type":"function","z":"dc14bd796219d9ad","g":"1a9d21242a01ebdd","name":"Reset_Battery_Efficity","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 07-02-2025, 18:19\n// Revised          : 07-02-2024, 18:22\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2025 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Zapni debug zprávy, pokud chceš vidět detaily\n\n\n// Reset hodnot\nglobal.set(\"last_charge_efficiency\", 0);\nglobal.set(\"last_discharge_efficiency\", 0);\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1240,"y":940,"wires":[[]]},{"id":"8f8da0208c0b2888","type":"inject","z":"dc14bd796219d9ad","g":"1a9d21242a01ebdd","name":"reset","props":[{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":670,"y":940,"wires":[["9a1f199e2e88d24c"]]},{"id":"3b71a96b67f875c3","type":"debug","z":"dc14bd796219d9ad","name":"debug 2","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload","statusType":"auto","x":960,"y":1140,"wires":[]},{"id":"input_fanIPAddress","type":"ui_text_input","z":"bb58b085db8ab888","g":"ad8071fbcd6cb151","name":"","label":"Fan IP Address MPTT","tooltip":"","group":"b27def8d204439ed","order":1,"width":6,"height":2,"passthru":true,"mode":"text","delay":300,"topic":"payload","sendOnBlur":true,"className":"","topicType":"str","x":700,"y":1100,"wires":[["14bd47d7f9189b90"]]},{"id":"file_out","type":"file","z":"bb58b085db8ab888","g":"6167eebedbeaff5b","name":"","filename":"filename","filenameType":"msg","appendNewline":false,"createDir":false,"overwriteFile":"true","encoding":"none","x":1040,"y":860,"wires":[["66a7a43e7b5c3227","8c03e12124f30d0a"]]},{"id":"2ccb43e9550a841c","type":"modbus-read","z":"bb58b085db8ab888","g":"e1e5f4d74c9959c1","name":"Modbus Read","topic":"phase1","showStatusActivities":false,"logIOActivities":false,"showErrors":false,"showWarnings":true,"unitid":"100","dataType":"InputRegister","adr":"817","quantity":"1","rate":"1","rateUnit":"s","delayOnStart":false,"startDelayTime":"","server":"6c801ec0cc108747","useIOFile":false,"ioFile":"","useIOForPayload":false,"emptyMsgOnFail":false,"x":1190,"y":1260,"wires":[["155e6145814328c9"],["b8ced369e30c31c1"]]},{"id":"155e6145814328c9","type":"debug","z":"bb58b085db8ab888","g":"e1e5f4d74c9959c1","name":"debug 23","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":1420,"y":1260,"wires":[]},{"id":"eaba18aa7bbbdc69","type":"comment","z":"bb58b085db8ab888","name":"","info":"- https://flows.nodered.org/flow/bc19aff2598d6a214bbfbe0e6f66ee64\n- https://discourse.nodered.org/t/ip-address-as-a-variable/53225/7\nhttps://flows.nodered.org/node/node-red-contrib-modbustcp","x":80,"y":40,"wires":[]},{"id":"5c44997566df0d35","type":"function","z":"bb58b085db8ab888","g":"e1e5f4d74c9959c1","name":"enable","func":"msg.payload = { \n    value: msg.payload, \n    'fc': 4, \n    'unitid': 100, \n    'address': 817,\n    'quantity': 1\n}; \nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1339,"y":1121,"wires":[["343bae18b4127654","af86bc1b94e005d6"]]},{"id":"343bae18b4127654","type":"modbus-flex-getter","z":"bb58b085db8ab888","g":"e1e5f4d74c9959c1","name":"read","showStatusActivities":false,"showErrors":false,"showWarnings":true,"logIOActivities":false,"server":"6c801ec0cc108747","useIOFile":false,"ioFile":"","useIOForPayload":false,"emptyMsgOnFail":false,"keepMsgProperties":false,"delayOnStart":false,"startDelayTime":"","x":1490,"y":1120,"wires":[["34c4333353119237"],[]]},{"id":"34c4333353119237","type":"debug","z":"bb58b085db8ab888","g":"e1e5f4d74c9959c1","name":"debug 30","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload","statusType":"auto","x":1669,"y":1121,"wires":[]},{"id":"426ee71326b9eef2","type":"debug","z":"bb58b085db8ab888","g":"8384064784376389","name":"debug 32","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload","statusType":"auto","x":880,"y":380,"wires":[]},{"id":"af86bc1b94e005d6","type":"debug","z":"bb58b085db8ab888","g":"e1e5f4d74c9959c1","name":"debug 33","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":1489,"y":1181,"wires":[]},{"id":"bf546b61f5a07c75","type":"inject","z":"bb58b085db8ab888","g":"e1e5f4d74c9959c1","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1189,"y":1121,"wires":[["5c44997566df0d35"]]},{"id":"5a9fcb2da005548e","type":"modbus-flex-connector","z":"bb58b085db8ab888","g":"8384064784376389","name":"connection","maxReconnectsPerMinute":4,"emptyQueue":false,"showStatusActivities":false,"showErrors":false,"server":"6c801ec0cc108747","emptyMsgOnFail":false,"configMsgOnChange":false,"x":690,"y":220,"wires":[["7d6daf3a9f2c1f8b","28578c73ab6a72a6","426ee71326b9eef2"]]},{"id":"44aba335bc247794","type":"function","z":"bb58b085db8ab888","g":"8384064784376389","name":"connect","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 20-07-2024, 17:01\n// Revised          : 25-07-2024, 19:42\n// Version          : 1.2\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fGetConfigProperty = global.get('getConfigProperty');\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst tcpHost = fGetConfigProperty(\"connectorConfig.tcpHost\") || 0; //dotaz na data z globalni strukturu\nconst tcpPort = fGetConfigProperty(\"connectorConfig.tcpPort\") || 0; //dotaz na data z globalni strukturu\nconst unitId = fGetConfigProperty(\"connectorConfig.unitId\") || 0; //dotaz na data z globalni strukturu\n\nnode.debug(\"debug message\");\n\nmsg.payload = {\n    'connectorType': \"TCP\",\n    'tcpHost': tcpHost,\n    'tcpPort': tcpPort,\n    'unitId': unitId,\n    'modbusResponse.status': 0\n};\n\n \n\nreturn msg;\n\n/*\nnode.log(\"Informational message\");  // Logs at info level\nnode.warn(\"Warning message\");       // Logs at warn level\nnode.error(\"Error message\");        // Logs at error level\nnode.debug(\"Debug message\");        // Logs at debug level\nnode.trace(\"Trace message\");        // Logs at trace level\n*/\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":520,"y":220,"wires":[["5a9fcb2da005548e"]]},{"id":"ef861a6c6e9df48e","type":"delay","z":"bb58b085db8ab888","g":"8384064784376389","name":"500ms","pauseType":"delay","timeout":"500","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":370,"y":220,"wires":[["44aba335bc247794"]]},{"id":"c021cd075c0b774f","type":"ui_text_input","z":"bb58b085db8ab888","g":"abb49bc25d54f862","name":"","label":"tcpHost","tooltip":"IP Adresa vaší FVE","group":"ba1c560b4a2f6b32","order":1,"width":6,"height":2,"passthru":true,"mode":"text","delay":300,"topic":"payload","sendOnBlur":true,"className":"","topicType":"msg","x":660,"y":1400,"wires":[["29f7bebe6a8111cd"]]},{"id":"49450380783c21eb","type":"ui_text_input","z":"bb58b085db8ab888","g":"abb49bc25d54f862","name":"","label":"tcpPort","tooltip":"Port FVE, default je 502","group":"ba1c560b4a2f6b32","order":2,"width":6,"height":2,"passthru":true,"mode":"text","delay":300,"topic":"payload","sendOnBlur":true,"className":"","topicType":"msg","x":660,"y":1440,"wires":[["d28a120550fc6aa3"]]},{"id":"39297b4370e42165","type":"ui_text_input","z":"bb58b085db8ab888","g":"abb49bc25d54f862","name":"","label":"unitId","tooltip":"ID vaší FVE, default je 100","group":"ba1c560b4a2f6b32","order":3,"width":6,"height":2,"passthru":true,"mode":"number","delay":300,"topic":"payload","sendOnBlur":true,"className":"","topicType":"msg","x":650,"y":1480,"wires":[["cb3dfeebaf14ef8b"]]},{"id":"9226ebd8324689b1","type":"debug","z":"bb58b085db8ab888","g":"9d90eeb1c87e776f","name":"debug 37","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload","statusType":"auto","x":1000,"y":500,"wires":[]},{"id":"dfbe419d88e4f232","type":"file in","z":"bb58b085db8ab888","g":"9d90eeb1c87e776f","name":"Read_File","filename":"filename","filenameType":"msg","format":"utf8","chunk":false,"sendError":false,"encoding":"none","allProps":false,"x":1010,"y":580,"wires":[["794d418cbe9f49b8"]]},{"id":"794d418cbe9f49b8","type":"function","z":"bb58b085db8ab888","g":"9d90eeb1c87e776f","name":"Parse Config","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 20-07-2024, 17:01\n// Revised          : 15-09-2024, 11:34\n// Version          : 1.3\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fGetConfigProperty = global.get('getConfigProperty');\nconst fSetConfigProperty = global.get('setConfigProperty');\n\ntry {\n    const config = JSON.parse(msg.payload);  // Pokusit se parsovat JSON\n    //global.set('config', config);            // Uložit konfiguraci do globální proměnné\n\n    // Zjistit oskud pochazi pozadavek na nahrani konfigurace\n    if (msg.load === \"LOAD_CONFIG_API\") {\n        // kdyz je ztracen jen token, tak ulozit jen token a zbytek ignorovat\n        if (config.bearerToken) {\n            fSetConfigProperty(\"bearerToken\", config.bearerToken); //ulozit token;\n            fSetConfigProperty(\"nVRM_site_id\", config.nVRM_site_id); //ulozit nVRM_site_id;\n            \n            // Nastavit zprávu v případě úspěchu\n            msg.highlight = 'yellow';\n            msg.timeout = \"5\";\n            msg.payload = \"Načten POUZE TOKEN\";\n        }\n    } else {\n        // Nahrat celou konfiguraci\n        global.set('config', config);\n        // Nastavit zprávu v případě úspěchu\n        msg.highlight = 'green';\n        msg.timeout = \"5\";\n        msg.payload = \"Uspěšně načtena konfigurace\";\n    }\n\n    return msg;\n} catch (e) {\n    // Pokud dojde k chybě při parsování JSON\n    // Debugging\n    if (debug) {\n        node.error('Chyba při parsování JSON: ' + e.message);\n    }\n\n    // Nastavit zprávu v případě chyby\n    msg.highlight = 'red';\n    msg.timeout = \"5\";\n    msg.payload = \"Nepodařilo se načíst konfiguraci: \" + e.message;\n\n    return msg;\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1190,"y":580,"wires":[["4eaeb432c1f16117","e5706dfefece2626","8594c45aa103bf48"]]},{"id":"4eaeb432c1f16117","type":"debug","z":"bb58b085db8ab888","g":"9d90eeb1c87e776f","name":"Debug Success","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload","statusType":"auto","x":1440,"y":640,"wires":[]},{"id":"22452155843f3233","type":"catch","z":"bb58b085db8ab888","g":"6167eebedbeaff5b","name":"Not Exist File","scope":["dfbe419d88e4f232"],"uncaught":false,"x":630,"y":820,"wires":[["4d89bf95b09676fe","2c501c50c5542579","65d3135f908c531a"]]},{"id":"4d89bf95b09676fe","type":"function","z":"bb58b085db8ab888","g":"6167eebedbeaff5b","name":"Create/Save File","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 20-07-2024, 17:01\n// Revised          : 28-10-2024, 13:31\n// Version          : 1.31\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n// msg.filename: Určuje cestu k souboru, do kterého se bude zapisovat.\n// msg.payload: Obsah, který se bude zapisovat do souboru. Může to být textový řetězec nebo objekt, který se převede na JSON.\n\nconst filename = global.get(\"filename\");            // Configuration file name\nconst defaultConfig = global.get(\"defaultConfig\");  // Default configuration file name\n//const path_file = global.get(\"path_file\");          // Path to store the file\nconst log_file_name = global.get(\"log_file_name\");  // Log file name\nconst path_file = global.get(\"sValid_Patch\") + \"/\"; // nacti zjistenou cesta k souborum dle HW.\n\n\nconst visibleButtonIO = global.get(\"visibleButtonIO\"); //pokud hodnota neexistuje tak je restart NODERED a nacitam default.\nconst sBuffer = msg.payload; //nacteni vstupu\nlet path_config = \"\";\nlet sConfigData = \"\";\nlet _RefreshButtons = false;\n\nif ((typeof visibleButtonIO === 'undefined' || visibleButtonIO === null || visibleButtonIO === false) && sBuffer == \"DefaultSave\") {\n    // Načtení zakladniho nastaveni\n    sConfigData = global.get(\"config\") || {};\n    path_config = path_file + defaultConfig;\n    global.set(\"visibleButtonIO\", true);\n    _RefreshButtons = true;\n}\n\nif (visibleButtonIO == true && sBuffer == \"ConfigSave\") {\n    // Načtení zakladniho nastaveni\n    sConfigData = global.get(\"config\") || {};\n    path_config = path_file + filename;\n}\n\nif (path_config == \"\") return null;\n\n// Nastavení zprávy pro zápis do souboru\nmsg.filename = path_config;\nmsg.payload = JSON.stringify(sConfigData, null, 2); // Konvertuje prázdný objekt na JSON řetězec\n\n// Vytvoření druhé zprávy pro _RefreshButtons\nlet refreshMsg = null;\nif (_RefreshButtons) {\n    refreshMsg = { payload: _RefreshButtons }; // Nastaví druhou zprávu, pokud je třeba obnovit tlačítka\n}\n\n// Odeslání obou zpráv - první pro uložení souboru a druhá pro obnovení tlačítek\nreturn [msg, refreshMsg];\n","outputs":2,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":850,"y":880,"wires":[["file_out"],["d6596fea5b0154cc"]]},{"id":"66a7a43e7b5c3227","type":"debug","z":"bb58b085db8ab888","g":"6167eebedbeaff5b","name":"debug 39","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":1220,"y":900,"wires":[]},{"id":"8cb9a604d688ffb0","type":"ui_text_input","z":"bb58b085db8ab888","g":"ad8071fbcd6cb151","name":"","label":"Fan IP Address Changer","tooltip":"","group":"b27def8d204439ed","order":2,"width":6,"height":2,"passthru":true,"mode":"text","delay":300,"topic":"payload","sendOnBlur":true,"className":"","topicType":"str","x":710,"y":1140,"wires":[["c4ce6c9549470d54"]]},{"id":"302399a6ed4ffcb6","type":"ui_text_input","z":"bb58b085db8ab888","g":"ad8071fbcd6cb151","name":"","label":"MAX Grid Point","tooltip":"Maximalní vybíjecí výkon při prodeji baterie","group":"b27def8d204439ed","order":4,"width":6,"height":2,"passthru":true,"mode":"number","delay":300,"topic":"payload","sendOnBlur":true,"className":"","topicType":"str","x":680,"y":1220,"wires":[["b2bb17aa01892c8f"]]},{"id":"29f7bebe6a8111cd","type":"function","z":"bb58b085db8ab888","g":"abb49bc25d54f862","name":"Set connectorConfig.tcpHost","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 25-07-2024, 09:43\n// Revised          : 25-07-2024, 11:27\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst sBuffer = msg.payload; //nacteni vstupu\nfSetConfigProperty(\"connectorConfig.tcpHost\", sBuffer); //ulozit data do globalni struktury\n\n// Debugging\nif (debug) {\n    node.warn(\"connectorConfig.tcpHost: \" + sBuffer);\n}\n\nreturn null;","outputs":0,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":880,"y":1400,"wires":[]},{"id":"d28a120550fc6aa3","type":"function","z":"bb58b085db8ab888","g":"abb49bc25d54f862","name":"Set connectorConfig.tcpPort","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 25-07-2024, 09:43\n// Revised          : 25-07-2024, 11:27\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst sBuffer = msg.payload; //nacteni vstupu\nfSetConfigProperty(\"connectorConfig.tcpPort\", sBuffer); //ulozit data do globalni struktury\n\n// Debugging\nif (debug) {\n    node.warn(\"connectorConfig.tcpPort: \" + sBuffer);\n}\n\nreturn null;","outputs":0,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":880,"y":1440,"wires":[]},{"id":"cb3dfeebaf14ef8b","type":"function","z":"bb58b085db8ab888","g":"abb49bc25d54f862","name":"Set connectorConfig.unitId","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 25-07-2024, 09:43\n// Revised          : 25-07-2024, 11:27\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst sBuffer = msg.payload; //nacteni vstupu\nfSetConfigProperty(\"connectorConfig.unitId\", sBuffer); //ulozit data do globalni struktury\n\n// Debugging\nif (debug) {\n    node.warn(\"connectorConfig.unitId: \" + sBuffer);\n}\n\nreturn null;","outputs":0,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":880,"y":1480,"wires":[]},{"id":"4106733b7e446a9d","type":"function","z":"bb58b085db8ab888","g":"abb49bc25d54f862","name":"SET CONFIG","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 25-07-2024, 09:43\n// Revised          : 25-07-2024, 10:27\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fGetConfigProperty = global.get('getConfigProperty');\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst tcpHost = fGetConfigProperty(\"connectorConfig.tcpHost\") || 0; //dotaz na data z globalni strukturu\nmsg.payload = tcpHost;          //nastaveni hodnoty\n\n// Debugging\nif (debug) {\n    node.warn(\"connectorConfig.tcpHost: \" + tcpHost);\n    node.warn(\"msg.payload: \" + msg.payload);\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":420,"y":1400,"wires":[["c021cd075c0b774f"]]},{"id":"50e7bd5cb040a95c","type":"function","z":"bb58b085db8ab888","g":"abb49bc25d54f862","name":"SET CONFIG","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 25-07-2024, 09:43\n// Revised          : 25-07-2024, 10:27\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fGetConfigProperty = global.get('getConfigProperty');\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst tcpPort = fGetConfigProperty(\"connectorConfig.tcpPort\") || 0; //dotaz na data z globalni strukturu\nmsg.payload = tcpPort;          //nastaveni hodnoty\n\n// Debugging\nif (debug) {\n    node.warn(\"connectorConfig.tcpPort: \" + tcpPort);\n    node.warn(\"msg.payload: \" + msg.payload);\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":420,"y":1440,"wires":[["49450380783c21eb"]]},{"id":"f0fd7d62fe70c454","type":"function","z":"bb58b085db8ab888","g":"abb49bc25d54f862","name":"SET CONFIG","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 25-07-2024, 09:43\n// Revised          : 25-07-2024, 10:27\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fGetConfigProperty = global.get('getConfigProperty');\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst unitId = fGetConfigProperty(\"connectorConfig.unitId\") || 0; //dotaz na data z globalni strukturu\nmsg.payload = unitId;          //nastaveni hodnoty\n\n// Debugging\nif (debug) {\n    node.warn(\"connectorConfig.unitId: \" + unitId);\n    node.warn(\"msg.payload: \" + msg.payload);\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":420,"y":1480,"wires":[["39297b4370e42165"]]},{"id":"69024fcbdecb7e15","type":"ui_button","z":"bb58b085db8ab888","g":"8384064784376389","name":"","group":"ba1c560b4a2f6b32","order":4,"width":5,"height":1,"passthru":false,"label":"Connect","tooltip":"","color":"","bgcolor":"","className":"","icon":"","payload":"","payloadType":"str","topic":"connectButton","topicType":"msg","x":360,"y":260,"wires":[["44aba335bc247794"]]},{"id":"b8ced369e30c31c1","type":"debug","z":"bb58b085db8ab888","g":"e1e5f4d74c9959c1","name":"debug 40","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1420,"y":1320,"wires":[]},{"id":"6b4ae0211109ae1b","type":"function","z":"bb58b085db8ab888","g":"8384064784376389","name":"Check Connection","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 29-07-2024, 17:01\n// Revised          : 29-07-2024, 19:42\n// Version          : 1.1\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\nconst nCountTimeStamp = 4; //kolik cyklu se má provest nez bude uznane platne casove razitko.\nlet nStatusIndicator = \"\";\nlet modbusResponse = msg.payload;\n\n// Získání počtu přijatých časových razítek z flow contextu\nlet timestampCounter = flow.get(\"timestampCounter\") || 0;\n\nconst nCode = isTimestamp(modbusResponse);\n\nif (nCode == true) {\n    // Pokud je hodnota platným časovým razítkem, zvyšte čítač\n    timestampCounter += 1;\n    \n    // Pokud čítač dosáhne hodnoty nCountTimeStamp, resetuje modbusResponse a čítač\n    if (timestampCounter >= nCountTimeStamp) {\n        modbusResponse = 0;  // Platné časové razítko 10x za sebou\n        timestampCounter = nCountTimeStamp;  // Resetování čítače\n    }\n} else {\n    // Pokud nepřijde platné časové razítko, čítač se vynuluje\n    timestampCounter = 0;\n}\n\n// Uložení aktuálního stavu čítače do flow contextu\nflow.set(\"timestampCounter\", timestampCounter);\n\nif (modbusResponse != 0){\n    nStatusIndicator =\"on\"\n} else {\n    nStatusIndicator =\"off\";\n}  \nconst indicatorMsg = { indicator: '_tcp_connect', status: nStatusIndicator, topic: 'update-indicator' };\nreturn { payload: indicatorMsg };\n\n\n// Funkce pro zjištění, zda je hodnota časové razítko\nfunction isTimestamp(value) {\n    if (typeof value !== 'number' || isNaN(value)) {\n        return false;\n    }\n\n    const now = Date.now();\n    const minTimestamp = new Date('1970-01-01').getTime(); // UNIX epoch start\n    const maxTimestamp = new Date('2100-01-01').getTime(); // Future limit\n\n    // Check if it's a millisecond timestamp\n    if (value >= minTimestamp && value <= maxTimestamp) {\n        return true;\n    }\n\n    // Check if it's a second timestamp (divide by 1000)\n    if (value * 1000 >= minTimestamp && value * 1000 <= maxTimestamp) {\n        return true;\n    }\n\n    return false;\n}\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":950,"y":160,"wires":[["292fdb2fff2915d6"]]},{"id":"f5835241bb34233a","type":"ui_text_input","z":"bb58b085db8ab888","g":"ad8071fbcd6cb151","name":"","label":"IP Boiler","tooltip":"","group":"b27def8d204439ed","order":3,"width":6,"height":2,"passthru":true,"mode":"text","delay":300,"topic":"payload","sendOnBlur":true,"className":"","topicType":"str","x":660,"y":1180,"wires":[["a0b115480ce7f9ae"]]},{"id":"14bd47d7f9189b90","type":"function","z":"bb58b085db8ab888","g":"ad8071fbcd6cb151","name":"Set sIpAddress_m","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 25-07-2024, 09:43\n// Revised          : 25-07-2024, 11:27\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst sBuffer = msg.payload; //nacteni vstupu\nfSetConfigProperty(\"sIpAddress_m\", sBuffer); //ulozit data do globalni struktury\n\n// Debugging\nif (debug) {\n    node.warn(\"sIpAddress_m: \" + sBuffer);\n}\n\nreturn null;","outputs":0,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":930,"y":1100,"wires":[]},{"id":"c4ce6c9549470d54","type":"function","z":"bb58b085db8ab888","g":"ad8071fbcd6cb151","name":"Set sIpAddress_ch","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 25-07-2024, 09:43\n// Revised          : 25-07-2024, 11:27\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst sBuffer = msg.payload; //nacteni vstupu\nfSetConfigProperty(\"sIpAddress_ch\", sBuffer); //ulozit data do globalni struktury\n\n// Debugging\nif (debug) {\n    node.warn(\"sIpAddress_ch: \" + sBuffer);\n}\n\nreturn null;","outputs":0,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":930,"y":1140,"wires":[]},{"id":"a0b115480ce7f9ae","type":"function","z":"bb58b085db8ab888","g":"ad8071fbcd6cb151","name":"Set sIpAddress_boiler","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 25-07-2024, 09:43\n// Revised          : 25-07-2024, 11:27\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst sBuffer = msg.payload; //nacteni vstupu\nfSetConfigProperty(\"sIpAddress_boiler\", sBuffer); //ulozit data do globalni struktury\n\n// Debugging\nif (debug) {\n    node.warn(\"sIpAddress_boiler: \" + sBuffer);\n}\n\nreturn null;","outputs":0,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":920,"y":1180,"wires":[]},{"id":"b2bb17aa01892c8f","type":"function","z":"bb58b085db8ab888","g":"ad8071fbcd6cb151","name":"Set nMAX_Grid_Point","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 25-07-2024, 09:43\n// Revised          : 25-07-2024, 11:27\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst sBuffer = msg.payload; //nacteni vstupu\nfSetConfigProperty(\"nMAX_Grid_Point\", sBuffer); //ulozit data do globalni struktury\n\n// Debugging\nif (debug) {\n    node.warn(\"nMAX_Grid_Point: \" + sBuffer);\n}\n\nreturn null;","outputs":0,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":920,"y":1220,"wires":[]},{"id":"7d6daf3a9f2c1f8b","type":"modbus-response","z":"bb58b085db8ab888","g":"8384064784376389","name":"","registerShowMax":20,"x":910,"y":260,"wires":[]},{"id":"28578c73ab6a72a6","type":"modbus-queue-info","z":"bb58b085db8ab888","g":"8384064784376389","name":"","topic":"","unitid":"100","queueReadIntervalTime":1000,"lowLowLevel":25,"lowLevel":75,"highLevel":150,"highHighLevel":300,"server":"6c801ec0cc108747","errorOnHighLevel":true,"showStatusActivities":true,"updateOnAllQueueChanges":true,"updateOnAllUnitQueues":true,"x":910,"y":320,"wires":[["a9886bf483698733"]]},{"id":"a9886bf483698733","type":"debug","z":"bb58b085db8ab888","g":"8384064784376389","name":"debug 41","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload","statusType":"auto","x":1120,"y":320,"wires":[]},{"id":"8c6bcdb6cd2bd669","type":"function","z":"bb58b085db8ab888","g":"ad8071fbcd6cb151","name":"SET CONFIG","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 29-07-2024, 14:23\n// Revised          : 29-07-2024, 21:27\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fGetConfigProperty = global.get('getConfigProperty');\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst sBuffer = fGetConfigProperty(\"sIpAddress_m\") || 0; //dotaz na data z globalni strukturu\nmsg.payload = sBuffer;          //nastaveni hodnoty\n\n// Debugging\nif (debug) {\n    node.warn(\"sIpAddress_m: \" + sBuffer);\n    node.warn(\"msg.payload: \" + msg.payload);\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":420,"y":1100,"wires":[["input_fanIPAddress"]]},{"id":"4c5403c83d2bb214","type":"function","z":"bb58b085db8ab888","g":"ad8071fbcd6cb151","name":"SET CONFIG","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 29-07-2024, 14:23\n// Revised          : 29-07-2024, 21:27\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fGetConfigProperty = global.get('getConfigProperty');\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst sBuffer = fGetConfigProperty(\"sIpAddress_ch\") || 0; //dotaz na data z globalni strukturu\nmsg.payload = sBuffer;          //nastaveni hodnoty\n\n// Debugging\nif (debug) {\n    node.warn(\"sIpAddress_ch: \" + sBuffer);\n    node.warn(\"msg.payload: \" + msg.payload);\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":420,"y":1140,"wires":[["8cb9a604d688ffb0"]]},{"id":"eab20b4ea8a392de","type":"function","z":"bb58b085db8ab888","g":"ad8071fbcd6cb151","name":"SET CONFIG","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 29-07-2024, 14:23\n// Revised          : 29-07-2024, 21:27\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fGetConfigProperty = global.get('getConfigProperty');\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst sBuffer = fGetConfigProperty(\"sIpAddress_boiler\") || 0; //dotaz na data z globalni strukturu\nmsg.payload = sBuffer;          //nastaveni hodnoty\n\n// Debugging\nif (debug) {\n    node.warn(\"sIpAddress_boiler: \" + sBuffer);\n    node.warn(\"msg.payload: \" + msg.payload);\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":420,"y":1180,"wires":[["f5835241bb34233a"]]},{"id":"bb6b6a460d918428","type":"function","z":"bb58b085db8ab888","g":"ad8071fbcd6cb151","name":"SET CONFIG","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 29-07-2024, 14:23\n// Revised          : 29-07-2024, 21:27\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fGetConfigProperty = global.get('getConfigProperty');\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst sBuffer = fGetConfigProperty(\"nMAX_Grid_Point\") || 0; //dotaz na data z globalni strukturu\nmsg.payload = sBuffer;          //nastaveni hodnoty\n\n// Debugging\nif (debug) {\n    node.warn(\"nMAX_Grid_Point: \" + sBuffer);\n    node.warn(\"msg.payload: \" + msg.payload);\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":420,"y":1220,"wires":[["302399a6ed4ffcb6"]]},{"id":"0f872f0d08025491","type":"ui_button","z":"bb58b085db8ab888","g":"6167eebedbeaff5b","name":"","group":"03f0e4ccd6790757","order":3,"width":6,"height":1,"passthru":false,"label":"Delete Config","tooltip":"","color":"","bgcolor":"","className":"","icon":"","payload":"","payloadType":"str","topic":"topic","topicType":"msg","x":440,"y":960,"wires":[["256e26fc9a8d6490","3bdc81473f9625ee"]]},{"id":"e5f6d86f19cde035","type":"function","z":"bb58b085db8ab888","g":"6167eebedbeaff5b","name":"Delete File","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 20-07-2024, 17:01\n// Revised          : 28-10-2024, 13:32\n// Version          : 1.21\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n// msg.filename: Určuje cestu k souboru, do kterého se bude zapisovat.\n// msg.payload: Obsah, který se bude zapisovat do souboru. Může to být textový řetězec nebo objekt, který se převede na JSON.\n\n\n// Získání názvu souboru z globální proměnné\nconst filename = global.get(\"filename\");            // nazev konfiguracniho souboru\n//const path_file = global.get(\"path_file\");          // cesta kam ukladat\nconst log_file_name = global.get(\"log_file_name\");  // nazev logovaciho souboru\nconst path_file = global.get(\"sValid_Patch\") + \"/\"; // nacti zjistenou cesta k souborum dle HW.\n\n\nconst path_config = path_file + filename;\n\n// Načtení aktuální konfigurace\nconst sConfigData = global.get(\"config\")  || {};\n\nglobal.set(\"visibleButtonIO\", null);  // Nebo null, pokud chceš vymazat hodnotu\n\n// Nastavení zprávy pro zápis do souboru\nmsg.filename = path_config;\nmsg.payload = JSON.stringify(sConfigData, null, 2); // Konvertuje prázdný objekt na JSON řetězec\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":830,"y":960,"wires":[["b6c3be5632678b31","d6596fea5b0154cc"]]},{"id":"b6c3be5632678b31","type":"file","z":"bb58b085db8ab888","g":"6167eebedbeaff5b","name":"","filename":"filename","filenameType":"msg","appendNewline":false,"createDir":false,"overwriteFile":"delete","encoding":"none","x":1030,"y":960,"wires":[["8abb33b00bbcb30a","66a7a43e7b5c3227"]]},{"id":"256e26fc9a8d6490","type":"delay","z":"bb58b085db8ab888","g":"6167eebedbeaff5b","name":"500ms","pauseType":"delay","timeout":"500","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":650,"y":960,"wires":[["e5f6d86f19cde035"]]},{"id":"3bdc81473f9625ee","type":"link out","z":"bb58b085db8ab888","g":"6167eebedbeaff5b","name":"DELETE_CONFIG","mode":"link","links":["06864177b7791422"],"x":595,"y":1000,"wires":[]},{"id":"e5706dfefece2626","type":"link out","z":"bb58b085db8ab888","g":"9d90eeb1c87e776f","name":"RESET_GUI","mode":"link","links":["dca141d221dbecf7","f2fb9e0e6990da1e","149c533d1f4ff12f","aa78d033ee089055","7f3beb8cf053976c","9158e8cb04621410"],"x":1365,"y":580,"wires":[]},{"id":"8267d7862417bb66","type":"catch","z":"bb58b085db8ab888","g":"8384064784376389","name":"","scope":["5a9fcb2da005548e"],"uncaught":false,"x":430,"y":360,"wires":[["bdbd0d07dcc46476"]]},{"id":"bdbd0d07dcc46476","type":"debug","z":"bb58b085db8ab888","g":"8384064784376389","name":"CONNECT ERROR","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload","statusType":"auto","x":650,"y":360,"wires":[]},{"id":"feb036c14b9b830a","type":"ui_text_input","z":"bb58b085db8ab888","g":"5026d073f890b271","name":"","label":"Username","tooltip":"Logovaci email pro vasi instalaci ve VRM","group":"b5c590ba96324296","order":1,"width":6,"height":2,"passthru":false,"mode":"text","delay":"0","topic":"username_VRM","sendOnBlur":true,"className":"","topicType":"str","x":590,"y":1660,"wires":[["b98d895b6e39e81d"]]},{"id":"955591a2c9c913fc","type":"ui_text_input","z":"bb58b085db8ab888","d":true,"g":"5026d073f890b271","name":"","label":"Password","tooltip":"Heslo vasi instalaci ve VRM","group":"b5c590ba96324296","order":3,"width":6,"height":2,"passthru":false,"mode":"password","delay":"0","topic":"password_VRM","sendOnBlur":true,"className":"","topicType":"str","x":500,"y":1820,"wires":[[]]},{"id":"86e48532687d8393","type":"ui_button","z":"bb58b085db8ab888","g":"5026d073f890b271","name":"","group":"b5c590ba96324296","order":6,"width":6,"height":1,"passthru":false,"label":"Submit","tooltip":"","color":"","bgcolor":"","className":"","icon":"","payload":"","payloadType":"str","topic":"","topicType":"str","x":580,"y":1720,"wires":[["6287a617c8ea9f14"]]},{"id":"85807d5d954a34a7","type":"function","z":"bb58b085db8ab888","g":"5026d073f890b271","name":"Login_VRM","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 03-08-2024, 21:19\n// Revised          : 04-08-2024, 11:27\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fGetConfigProperty = global.get('getConfigProperty');\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst username_VRM = fGetConfigProperty(\"username_VRM\"); //dotaz na data z globalni strukturu\n\nconst password_VRM = global.get('password_VRM');\n\nmsg.payload = {\n    username: username_VRM,\n    password: password_VRM,\n    remember_me: \"true\"\n};\n\nmsg.headers = {\n    \"Content-Type\": \"application/json\"\n};\n\n// Nastavení URL pro vytvoření tokenu\nmsg.url = `https://vrmapi.victronenergy.com/v2/auth/login`;\n\n\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":810,"y":1740,"wires":[["657908f3ee36f1b8"]]},{"id":"657908f3ee36f1b8","type":"http request","z":"bb58b085db8ab888","g":"5026d073f890b271","name":"","method":"POST","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":1010,"y":1740,"wires":[["c33d8542af6c698d","036ec001ad764181"]]},{"id":"c33d8542af6c698d","type":"debug","z":"bb58b085db8ab888","g":"5026d073f890b271","name":"Bearer ","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload","statusType":"auto","x":1190,"y":1740,"wires":[]},{"id":"96a81419238cb2c8","type":"function","z":"bb58b085db8ab888","g":"5026d073f890b271","name":"Set password_VRM","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 03-08-2024, 21:19\n// Revised          : 04-08-2024, 11:27\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\nconst sBuffer = msg.payload; //nacteni vstupu\n// Ulozeni dat do globalnich promennych, ktere jsou dostupne mezi flow\nglobal.set(\"password_VRM\", sBuffer);\n\n// Debugging\nif (debug) {\n    node.warn(\"password_VRM: \" + sBuffer);\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1240,"y":1700,"wires":[["85807d5d954a34a7"]]},{"id":"b514060941dc6ba3","type":"http request","z":"bb58b085db8ab888","g":"5026d073f890b271","name":"","method":"POST","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":1010,"y":1800,"wires":[["411b4b59850d6625","850ea0a974cb2597"]]},{"id":"905af2b5c03463e9","type":"debug","z":"bb58b085db8ab888","g":"5026d073f890b271","name":"MyNewToken","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"deposit_Token","targetType":"msg","statusVal":"payload","statusType":"auto","x":1420,"y":1800,"wires":[]},{"id":"036ec001ad764181","type":"function","z":"bb58b085db8ab888","g":"5026d073f890b271","name":"Token","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 03-08-2024, 21:19\n// Revised          : 25-08-2024, 11:25\n// Version          : 1.1\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fGetConfigProperty = global.get('getConfigProperty');\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst name_instalation = fGetConfigProperty(\"name_instalation\"); //dotaz na data z globalni strukturu\n\n// Přijímá bearer token z msg.payload a sestaví požadavek\nconst bearerToken = msg.payload.token;\nconst userId = msg.payload.idUser;\nlet tokenName = name_instalation +`_` + generateRandomString(6);  // Náhodný řetězec s délkou 6\n\nfSetConfigProperty(\"bearerToken\", bearerToken); //ulozit data do globalni struktury\n//global.set(\"bearerToken\", bearerToken);\n\n// Nastavení hlaviček a těla požadavku\nmsg.headers = {\n    \"Content-Type\": \"application/json\",\n    \"x-authorization\": `Bearer ${bearerToken}`\n};\n\n// Tělo požadavku\nmsg.payload = {\n    \"name\": tokenName\n};\n\n// Nastavení URL pro vytvoření tokenu\nmsg.url = `https://vrmapi.victronenergy.com/v2/users/${userId}/accesstokens/create`;\n\nreturn msg;\n\n// Generování náhodného alfanumerického řetězce\nfunction generateRandomString(length) {\n    let chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\n    let result = '';\n    for (let i = 0; i < length; i++) {\n        result += chars.charAt(Math.floor(Math.random() * chars.length));\n    }\n    return result;\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":790,"y":1800,"wires":[["b514060941dc6ba3","12043b620f5cff01"]]},{"id":"4bb1d44c23f30318","type":"comment","z":"bb58b085db8ab888","g":"5026d073f890b271","name":"","info":"https://forum.mypower.cz/viewtopic.php?t=10301\nhttps://vrm-api-docs.victronenergy.com/#/operations/auth/login","x":320,"y":1580,"wires":[]},{"id":"a9335b5b74384bdf","type":"function","z":"bb58b085db8ab888","g":"5026d073f890b271","name":"SET GUI","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 03-08-2024, 21:19\n// Revised          : 04-08-2024, 11:27\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fGetConfigProperty = global.get('getConfigProperty');\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst sBuffer = fGetConfigProperty(\"username_VRM\"); //dotaz na data z globalni strukturu\nmsg.payload  = sBuffer; //SET switch to read data\n\n// Debugging\nif (debug) {\n    node.warn(\"username_VRM: \" + sBuffer);\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":420,"y":1660,"wires":[["feb036c14b9b830a"]]},{"id":"149c533d1f4ff12f","type":"link in","z":"bb58b085db8ab888","g":"5026d073f890b271","name":"RESET_GUI","links":["e5706dfefece2626"],"x":265,"y":1720,"wires":[["a9335b5b74384bdf","eecc6e8206f07107","86e48532687d8393"]]},{"id":"b98d895b6e39e81d","type":"function","z":"bb58b085db8ab888","g":"5026d073f890b271","name":"Set username_VRM","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 03-08-2024, 21:19\n// Revised          : 04-08-2024, 11:27\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst username_VRM = msg.payload; //nacteni vstupu\nfSetConfigProperty(\"username_VRM\", username_VRM); //ulozit data do globalni struktury\n\n// Debugging\nif (debug) {\n    node.warn(\"username_VRM: \" + username_VRM);\n}\n\nreturn null;","outputs":0,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":840,"y":1660,"wires":[]},{"id":"790fdb01929ace0d","type":"ui_text_input","z":"bb58b085db8ab888","g":"5026d073f890b271","name":"","label":"Name your Instalation","tooltip":"Jmeno vasi instalace ve VRM","group":"b5c590ba96324296","order":2,"width":6,"height":2,"passthru":false,"mode":"text","delay":"0","topic":"name_instalation","sendOnBlur":true,"className":"","topicType":"str","x":620,"y":1620,"wires":[["abca044619136220"]]},{"id":"eecc6e8206f07107","type":"function","z":"bb58b085db8ab888","g":"5026d073f890b271","name":"SET GUI","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 04-08-2024, 09:50\n// Revised          : 04-08-2024, 11:27\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fGetConfigProperty = global.get('getConfigProperty');\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst sBuffer = fGetConfigProperty(\"name_instalation\"); //dotaz na data z globalni strukturu\nmsg.payload  = sBuffer; //SET switch to read data\n\n// Debugging\nif (debug) {\n    node.warn(\"name_instalation: \" + sBuffer);\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":420,"y":1620,"wires":[["790fdb01929ace0d"]]},{"id":"abca044619136220","type":"function","z":"bb58b085db8ab888","g":"5026d073f890b271","name":"Set username_VRM","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 04-08-2024, 09:49\n// Revised          : 04-08-2024, 11:27\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst name_instalation = msg.payload; //nacteni vstupu\nfSetConfigProperty(\"name_instalation\", name_instalation); //ulozit data do globalni struktury\n\n// Debugging\nif (debug) {\n    node.warn(\"name_instalation: \" + name_instalation);\n}\n\nreturn null;","outputs":0,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":840,"y":1620,"wires":[]},{"id":"aa78d033ee089055","type":"link in","z":"bb58b085db8ab888","g":"abb49bc25d54f862","name":"RESET_GUI","links":["e5706dfefece2626"],"x":265,"y":1440,"wires":[["4106733b7e446a9d","50e7bd5cb040a95c","f0fd7d62fe70c454"]]},{"id":"7f3beb8cf053976c","type":"link in","z":"bb58b085db8ab888","g":"ad8071fbcd6cb151","name":"RESET_GUI","links":["e5706dfefece2626"],"x":265,"y":1160,"wires":[["8c6bcdb6cd2bd669","4c5403c83d2bb214","eab20b4ea8a392de","bb6b6a460d918428","c2e166a921e51762","61266490e37a829f"]]},{"id":"c23b2f02aae4e8ae","type":"ui_text_input","z":"bb58b085db8ab888","g":"ad8071fbcd6cb151","name":"","label":"nBalancingReserve","tooltip":"Vyvažovací rezerva (W). Default je 230W.","group":"b27def8d204439ed","order":5,"width":6,"height":2,"passthru":true,"mode":"number","delay":300,"topic":"payload","sendOnBlur":true,"className":"","topicType":"str","x":690,"y":1260,"wires":[["1cbc56901615282a"]]},{"id":"1cbc56901615282a","type":"function","z":"bb58b085db8ab888","g":"ad8071fbcd6cb151","name":"Set nBalancingReserve","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 25-07-2024, 09:43\n// Revised          : 14-08-2024, 11:16\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst sBuffer = msg.payload; //nacteni vstupu\nfSetConfigProperty(\"nBalancingReserve\", sBuffer); //ulozit data do globalni struktury\n\n// Debugging\nif (debug) {\n    node.warn(\"nBalancingReserve: \" + sBuffer);\n}\n\nreturn null;","outputs":0,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":930,"y":1260,"wires":[]},{"id":"c2e166a921e51762","type":"function","z":"bb58b085db8ab888","g":"ad8071fbcd6cb151","name":"SET CONFIG","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 29-07-2024, 14:23\n// Revised          : 14-08-2024, 11:16\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fGetConfigProperty = global.get('getConfigProperty');\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst sBuffer = fGetConfigProperty(\"nBalancingReserve\") || 0; //dotaz na data z globalni strukturu\nmsg.payload = sBuffer;          //nastaveni hodnoty\n\n// Debugging\nif (debug) {\n    node.warn(\"nBalancingReserve: \" + sBuffer);\n    node.warn(\"msg.payload: \" + msg.payload);\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":420,"y":1260,"wires":[["c23b2f02aae4e8ae"]]},{"id":"b0896b5d1ee51e9e","type":"ui_text_input","z":"bb58b085db8ab888","g":"ad8071fbcd6cb151","name":"","label":"Deposit TOKEN","tooltip":"Přístupovy TOKEN VRM INSTALACE","group":"b5c590ba96324296","order":5,"width":6,"height":2,"passthru":true,"mode":"text","delay":300,"topic":"payload","sendOnBlur":true,"className":"","topicType":"str","x":680,"y":1300,"wires":[["3c9ae15a0c417fb7"]]},{"id":"3c9ae15a0c417fb7","type":"function","z":"bb58b085db8ab888","g":"ad8071fbcd6cb151","name":"Set deposit_TOKEN","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2025\n// Created          : 25-07-2024, 09:43\n// Revised          : 09-02-2025, 17:03\n// Version          : 1.3\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2025 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n// Definice globálních funkcí\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst sBuffer = msg.payload; // načtení vstupu\n\n// Přidejte kontrolu, zda je `sBuffer` typu string\nif (typeof sBuffer !== 'string') {\n    if (debug) {\n        node.error(\"Vstup není platný JWT token (není řetězec).\");\n    }\n    return null;\n}\n\nconst result = verifyJWTWithoutSecret(sBuffer); // kontrola na platný token\n\nfSetConfigProperty(\"deposit_TOKEN\", result); // uložit data do globální struktury\n\n\n// Debugging\nif (debug) {\n    node.warn(\"deposit_TOKEN: Vstup z inputu: \" + sBuffer);\n    node.warn(\"deposit_TOKEN: Výstup z kontroly platnosti tokenu: \" + result);\n}\n\nreturn null;\n\n// Funkce pro dekódování base64url kódovaných řetězců\nfunction base64urlDecode(str) {\n    // Base64url na base64 konverzi\n    str = str.replace(/-/g, '+').replace(/_/g, '/');\n\n    // Dekódování base64\n    return Buffer.from(str, 'base64').toString('utf-8');\n}\n\n// Funkce pro ověření JWT tokenu bez tajného klíče (základní ověření)\n// Tento kód pouze zkontroluje, zda je token ve správném formátu a zda jsou header a payload platné JSON objekty, nikoliv PODPIS!!!\nfunction verifyJWTWithoutSecret(token) {\n    // Kontrola, zda je token typu string\n    if (typeof token !== 'string') {\n        if (debug) {\n            node.error(\"Token není platný řetězec.\");\n        }\n        return 0;  // Neplatný formát tokenu\n    }\n\n    // Rozdělení JWT tokenu na jeho části\n    const parts = token.split('.');\n\n    // Kontrola, zda má token správný počet částí\n    if (parts.length !== 3) {\n        return 0;  // Neplatný formát tokenu\n    }\n\n    try {\n        // Dekódování header a payload části tokenu\n        const header = JSON.parse(base64urlDecode(parts[0]));\n        const payload = JSON.parse(base64urlDecode(parts[1]));\n\n        // Pokud je dekódování úspěšné, vrátit původní token\n        return token;\n    } catch (e) {\n        // Pokud došlo k chybě během dekódování, vrátit 0\n        return 0;\n    }\n}\n","outputs":0,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":920,"y":1300,"wires":[]},{"id":"61266490e37a829f","type":"function","z":"bb58b085db8ab888","g":"ad8071fbcd6cb151","name":"SET CONFIG","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2025\n// Created          : 29-07-2024, 14:23\n// Revised          : 09-02-2025, 17:01\n// Version          : 1.2\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2025 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fGetConfigProperty = global.get('getConfigProperty');\nconst fSetConfigProperty = global.get('setConfigProperty');\n\nconst sBuffer = fGetConfigProperty(\"deposit_TOKEN\") || 0; //dotaz na data z globalni strukturu\nmsg.payload = sBuffer;          //nastaveni hodnoty\n\n// Debugging\nif (debug) {\n    node.warn(\"bearerToken: \" + sBuffer);\n    node.warn(\"msg.payload: \" + msg.payload);\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":420,"y":1300,"wires":[["b0896b5d1ee51e9e"]]},{"id":"12043b620f5cff01","type":"link out","z":"bb58b085db8ab888","g":"5026d073f890b271","name":"Refresh_token","mode":"link","links":["d68ec5ae7de942a5"],"x":905,"y":1800,"wires":[]},{"id":"d68ec5ae7de942a5","type":"link in","z":"bb58b085db8ab888","g":"ad8071fbcd6cb151","name":"Refresh_token","links":["12043b620f5cff01"],"x":265,"y":1300,"wires":[["61266490e37a829f"]]},{"id":"d99a1f3b3cc8a1f0","type":"inject","z":"bb58b085db8ab888","g":"df21cfea6cf3d683","name":"Spustit čtení struktury","props":[{"p":"path","v":"/data","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":420,"y":2020,"wires":[["fd3f5d89d2c4d567"]]},{"id":"fd3f5d89d2c4d567","type":"function","z":"bb58b085db8ab888","g":"df21cfea6cf3d683","name":"příkaz ls -la ","func":"//const path = msg.path;\n\nconst path = global.get(\"sValid_Patch\") || \"/xyz\";\n\n\n// Sestavení příkazu pro shell\n// Používáme příkaz 'ls' pro Unix/Linux nebo 'dir' pro Windows\n// Zkontrolujte, který OS používáte a upravte příkaz podle potřeby.\nmsg.command = `ls -la ${path}`;\n\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":620,"y":2020,"wires":[["d1c7e82e4ad8d9b8"]]},{"id":"d1c7e82e4ad8d9b8","type":"exec","z":"bb58b085db8ab888","g":"df21cfea6cf3d683","command":"","addpay":"command","append":"","useSpawn":"true","timer":"","winHide":false,"oldrc":false,"name":"Spustit příkaz LS","x":810,"y":2020,"wires":[["826f2d0d3a5e5c36"],["ea7d9e08f03d0c4a"],["1d82ec5f63efcf70"]]},{"id":"826f2d0d3a5e5c36","type":"debug","z":"bb58b085db8ab888","g":"df21cfea6cf3d683","name":"Výstup souborové struktury","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":1140,"y":1980,"wires":[]},{"id":"ea7d9e08f03d0c4a","type":"debug","z":"bb58b085db8ab888","g":"df21cfea6cf3d683","name":"Chyba příkazu","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":1100,"y":2040,"wires":[]},{"id":"1d82ec5f63efcf70","type":"debug","z":"bb58b085db8ab888","g":"df21cfea6cf3d683","name":"Výstup procesu","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"rc","targetType":"msg","statusVal":"rc","statusType":"auto","x":1100,"y":2100,"wires":[]},{"id":"f1f48a2d9f8b42f9","type":"inject","z":"bb58b085db8ab888","name":"Spustit zápis","props":[],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":250,"y":2180,"wires":[["0e6d957e0f8d8b47"]]},{"id":"0e6d957e0f8d8b47","type":"function","z":"bb58b085db8ab888","name":"Vyber správnou cestu pro zápis","func":"const paths = [\n    '/data/node_modules/config_hacesoft.json',\n    '/data/home/nodered/.node-red/node_modules/config_hacesoft.json'\n];\n\nmsg.filename = paths.shift();\nmsg.payload = 'Toto je testovací záznam do souboru.';\nmsg.remainingPaths = paths;\n\nreturn msg;","outputs":1,"noerr":0,"x":490,"y":2180,"wires":[["a92f9c1e3f9746e7"]]},{"id":"a92f9c1e3f9746e7","type":"file","z":"bb58b085db8ab888","name":"Zapsat soubor","filename":"filename","filenameType":"msg","appendNewline":true,"createDir":false,"overwriteFile":"true","encoding":"none","x":780,"y":2180,"wires":[["cde4f6b1246c7ab2"]]},{"id":"cde4f6b1246c7ab2","type":"switch","z":"bb58b085db8ab888","name":"Zda zápis selhal?","property":"error","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":990,"y":2180,"wires":[["f2dbe1e21b5f0e0a"],["e0f3212142c14d8a"]]},{"id":"f2dbe1e21b5f0e0a","type":"function","z":"bb58b085db8ab888","name":"Zkusit další cestu","func":"if (msg.remainingPaths && msg.remainingPaths.length > 0) {\n    msg.filename = msg.remainingPaths.shift();\n    return msg;\n} else {\n    msg.payload = 'Nelze zapsat do žádné z cest.';\n    node.status({ fill: 'red', shape: 'ring', text: 'Zápis selhal' });\n    return null;\n}","outputs":1,"noerr":0,"x":1230,"y":2180,"wires":[["a92f9c1e3f9746e7"]]},{"id":"e0f3212142c14d8a","type":"debug","z":"bb58b085db8ab888","name":"Zápis úspěšný","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"filename","targetType":"msg","x":1240,"y":2240,"wires":[]},{"id":"d4d48c6a2b8c4e2b","type":"inject","z":"bb58b085db8ab888","g":"c9cab4329b815890","name":"Spustit čtení","props":[],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":470,"y":2440,"wires":[["ac3eae5f9c2d4c13"]]},{"id":"ac3eae5f9c2d4c13","type":"function","z":"bb58b085db8ab888","g":"c9cab4329b815890","name":"Vyber správnou cestu pro čtení","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 20-07-2024, 17:01\n// Revised          : 27-10-2024, 19:26\n// Version          : 1.21\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n\n// Debugging flag\n//const debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\nconst fGetValidPatch = global.get('fGetValidPatch');\n\nfGetValidPatch();\nreturn null;","outputs":1,"timeout":"","noerr":0,"initialize":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 20-07-2024, 17:01\n// Revised          : 27-10-2024, 19:26\n// Version          : 1.21\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n// Globální funkce pro logování\nglobal.set('fGetValidPatch', function fGetValidPatch() {\n\n    // Zavolání funkce pro odebrání prvního prvku\n    const shiftFilenamePath = global.get('shiftFilenamePath')();\n\n    const filename_paths = shiftFilenamePath;\n\n    msg.filename = filename_paths;\n    msg.remainingPaths = filename_paths;\n\n    // Debugging\n    if (debug) {\n        node.warn(\"filename_paths: \" + filename_paths);\n    }\n\n    node.send(msg);\n    //return msg;\n});\n","finalize":"","libs":[],"x":730,"y":2440,"wires":[["473abe190b6aed3d"]]},{"id":"d5f4a2e7c2e84c7d","type":"function","z":"bb58b085db8ab888","g":"c9cab4329b815890","name":"Zkusit další cestu","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 20-07-2024, 17:01\n// Revised          : 24-07-2024, 17:27\n// Version          : 1.1\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n// Zavolání funkce pro odebrání prvního prvku\nconst shiftFilenamePath = global.get('shiftFilenamePath')();\nconst filename_paths = shiftFilenamePath;\n\ndelete msg.error;\n\nmsg.filename = filename_paths;\nreturn msg;\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":750,"y":2540,"wires":[["473abe190b6aed3d"]]},{"id":"f723569d152ce502","type":"inject","z":"bb58b085db8ab888","g":"5026d073f890b271","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":420,"y":1720,"wires":[["86e48532687d8393"]]},{"id":"8c03e12124f30d0a","type":"function","z":"bb58b085db8ab888","g":"6167eebedbeaff5b","name":"Save_Message","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 20-07-2024, 17:01\n// Revised          : 08-09-2024, 18:14\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\nmsg.highlight = 'green';\nmsg.timeout = \"5\";\n\n// Send just a string instead of the whole object\nmsg.payload = \"Uspěšně uložena konfigurace\";  // Or any other specific text\n\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1220,"y":860,"wires":[["f2fc65315922fa55"]]},{"id":"8abb33b00bbcb30a","type":"function","z":"bb58b085db8ab888","g":"6167eebedbeaff5b","name":"Delete_Message","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 20-07-2024, 17:01\n// Revised          : 08-09-2024, 18:14\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\nmsg.highlight = 'yellow';\nmsg.timeout = \"25\";\n\n// Send just a string instead of the whole object\nmsg.topic = \"UPOZORNĚNÍ: Načtěte manuálně defaultní konfiguraci pomocí tlačítka: DEFAULT LOAD\";  // Or any other specific text\nmsg.payload = \"Uspěšně smazána konfigurace\";  // Or any other specific text\n\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1230,"y":960,"wires":[["f2fc65315922fa55"]]},{"id":"2c501c50c5542579","type":"function","z":"bb58b085db8ab888","g":"6167eebedbeaff5b","name":"Error_Message","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 20-07-2024, 17:01\n// Revised          : 28-10-2024, 20:00\n// Version          : 1.01\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//pokud hodnota neexistuje tak je restart NODERED a nacitam default.\nlet visibleButtonIO = global.get(\"visibleButtonIO\");\n\nif (typeof visibleButtonIO === 'undefined' || visibleButtonIO === null) {\n    return null;\n}\n\nmsg.highlight = 'red';\nmsg.timeout = \"30\";\n\n// Send just a string instead of the whole object\nmsg.topic = \"UPOZORNĚNÍ: Pravděpodobně se jedná o první spuštění systému, prosím proveďte uložení konfigurace.\";  // Or any other specific text\nmsg.payload = \"Nelze provést operaci (načtení konfigurace)\";  // Or any other specific text\nglobal.set(\"Firts_START\", 1);  \nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":840,"y":820,"wires":[["e8dbeffc5ca58026"]]},{"id":"e8dbeffc5ca58026","type":"link out","z":"bb58b085db8ab888","g":"6167eebedbeaff5b","name":"mesage_error","mode":"link","links":["2584e24c1a963979"],"x":975,"y":820,"wires":[]},{"id":"f2fc65315922fa55","type":"link out","z":"bb58b085db8ab888","g":"6167eebedbeaff5b","name":"message_W/D","mode":"link","links":["2584e24c1a963979"],"x":1465,"y":920,"wires":[]},{"id":"2584e24c1a963979","type":"link in","z":"bb58b085db8ab888","g":"9d90eeb1c87e776f","name":"messagw","links":["e8dbeffc5ca58026","f2fc65315922fa55","0f1187363309607e","5a2e12533b60dd9e"],"x":1455,"y":580,"wires":[["8594c45aa103bf48"]]},{"id":"8594c45aa103bf48","type":"ui_toast","z":"bb58b085db8ab888","g":"9d90eeb1c87e776f","position":"top right","displayTime":"5","highlight":"","sendall":false,"outputs":0,"ok":"OK","cancel":"Cancel","raw":false,"className":"","topic":"","name":"","x":1590,"y":580,"wires":[]},{"id":"2e019699821899dc","type":"ui_toast","z":"bb58b085db8ab888","g":"5026d073f890b271","position":"prompt","displayTime":"3","highlight":"","sendall":true,"outputs":1,"ok":"OK","cancel":"Cancel","raw":false,"className":"","topic":"","name":"Password","x":1000,"y":1700,"wires":[["96a81419238cb2c8"]]},{"id":"6287a617c8ea9f14","type":"function","z":"bb58b085db8ab888","g":"5026d073f890b271","name":"GET_PASSWORD","func":"msg.payload = \"Zadej heslo do VRM portálu: \";\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":830,"y":1700,"wires":[["2e019699821899dc"]]},{"id":"ca542ad4ccd6c23d","type":"link in","z":"bb58b085db8ab888","g":"9d90eeb1c87e776f","name":"LOAD_CONFIG_API","links":["ebf55f4e991cb354"],"x":615,"y":480,"wires":[["949a6897c12465b1","65d3135f908c531a"]]},{"id":"1665da5eb5a32a59","type":"inject","z":"bb58b085db8ab888","name":"","props":[{"p":"payload"}],"repeat":"","crontab":"","once":true,"onceDelay":"1","topic":"","payload":"inject","payloadType":"str","x":110,"y":540,"wires":[["ef861a6c6e9df48e","6700f2e72dbb7b1c"]]},{"id":"65d3135f908c531a","type":"function","z":"bb58b085db8ab888","g":"9d90eeb1c87e776f","name":"Get Config","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 27-09-2024, 19:03\n// Revised          : 28-10-2024, 20:22\n// Version          : 1.01\n// Target Platform  : Node-RED\n//\n//*****************************************************************************\n// Load Config Function\nconst debug = false;  // Set true for debugging\n\nconst filename = global.get(\"filename\");            // Configuration file name\nconst defaultConfig = global.get(\"defaultConfig\");  // Default configuration file name\n//const path_file = global.get(\"path_file\");        // Path to store the file\nconst log_file_name = global.get(\"log_file_name\");  // Log file name\nconst path_file = global.get(\"sValid_Patch\") + \"/\"; // nacti zjistenou cesta k souborum dle HW.\nconst sFirts_START = global.get(\"Firts_START\");     // Hodnota urcuje zda je toto první spuštení systemu, pokud ano tak je lepší neprovádět čtení, pak neexistují patřičné soubory a pak to vypisuje v debug konsoly chybové hlášení.\n\nlet sBuffer = msg.payload; //nacteni vstupu\nconst live_feed = msg.live_feed; //Když je token neplatný, live_feed je true.\n\nconst oError = msg.error;    //nacteni error hlaseni\nlet path_config = \"\";\n\n//pokud hodnota neexistuje, tak je restart NODERED a nacitam default.\nlet visibleButtonIO = global.get(\"visibleButtonIO\");\n\nif (live_feed == true){\n    if (typeof visibleButtonIO === 'undefined' || visibleButtonIO === null) {\n        visibleButtonIO = false;  // Nastavení výchozí hodnoty na false\n        //if (sBuffer === \"inject\") { return null}; \n    }\n\n    // Zkontrolovat, zda msg.error existuje a má validní strukturu\n    if (oError && oError.source && oError.source.name === \"Read_File\") {\n        // vraceno zpet pro nacteni defaultni konfigurace\n        path_config = path_file + defaultConfig;\n        sBuffer =\"\";\n    }\n\n    if (sBuffer === \"ConfigLoad\") {\n        path_config = path_file + filename;\n    }\n\n    if (sBuffer === \"DefaultLoad\") {\n        path_config = path_file + defaultConfig;\n    }\n\n    if (sBuffer === \"inject\" || live_feed == true) {\n        if (visibleButtonIO == false) {\n            path_config = path_file + defaultConfig;\n        } else {\n            path_config = path_file + filename;\n        }\n    }\n\n    msg.filename = path_config;\n\n// Debugging\nif (debug) {\n    node.warn(\"path_file: \" + path_file);\n}\n    if (sFirts_START == 1){// první spuštění systémi, nic nečti\n        return null;\n    }\n    else return msg;\n\n}else return null; //live_feed = false, tak nic nedelaj.\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":810,"y":580,"wires":[["dfbe419d88e4f232","9226ebd8324689b1"]]},{"id":"97613c9b3c258e1c","type":"function","z":"bb58b085db8ab888","g":"9d90eeb1c87e776f","name":"visible button","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 27-09-2024, 19:21\n// Revised          : 28-10-2024, 20:20\n// Version          : 1.01\n// Target Platform  : Node-RED\n//\n//*****************************************************************************\n// Load Config Function\nconst debug = false;  // Set true for debugging\n\n//pokud hodnota neexistuje tak je restart NODERED a nacitam default.\nlet visibleButtonIO = global.get(\"visibleButtonIO\");\n\nif (typeof visibleButtonIO === 'undefined' || visibleButtonIO === null) {\n    visibleButtonIO = false;  // Nastavení výchozí hodnoty na false\n}\n//visibleButtonIO = !visibleButtonIO;\nmsg.payload = {visibleButtonIO};\nglobal.set(\"Firts_START\", 0);\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":430,"y":580,"wires":[["ac7aeb8536edfbd8"]]},{"id":"ac7aeb8536edfbd8","type":"ui_template","z":"bb58b085db8ab888","g":"9d90eeb1c87e776f","group":"03f0e4ccd6790757","name":"Dynamic Buttons","order":1,"width":3,"height":2,"format":"<div style=\"display: flex; flex-direction: column; align-items: stretch; height: 100%;\">\n    <md-button ng-show=\"msg.payload.visibleButtonIO === false\" \n               ng-click=\"send({payload: 'DefaultLoad'})\"  \n               style=\"width: 100%; height: 100px; font-size: 14px; margin-top: 0px;\">\n        Default LOAD\n    </md-button>\n\n    <md-button ng-show=\"msg.payload.visibleButtonIO === true\" \n               ng-click=\"send({payload: 'ConfigLoad'})\"\n               class=\"\" \n               style=\"width: 100%; height: 100px; font-size: 14px; margin-top: 0px;\">\n        Config LOAD\n    </md-button>\n</div>","storeOutMessages":false,"fwdInMessages":false,"resendOnRefresh":true,"templateScope":"local","className":"","x":610,"y":580,"wires":[["65d3135f908c531a"]]},{"id":"49890a31476e6591","type":"ui_template","z":"bb58b085db8ab888","g":"6167eebedbeaff5b","group":"03f0e4ccd6790757","name":"Dynamic Buttons","order":2,"width":3,"height":2,"format":"<div style=\"display: flex; flex-direction: column; align-items: stretch; height: 100%;\">\n    <md-button ng-show=\"msg.payload.visibleButtonIO === false\" \n               ng-click=\"send({payload: 'DefaultSave'})\"  \n               style=\"width: 100%; height: 100px; font-size: 14px; margin-top: 0px;\">\n        Default SAVE\n    </md-button>\n\n    <md-button ng-show=\"msg.payload.visibleButtonIO === true\" \n               ng-click=\"send({payload: 'ConfigSave'})\"\n               class=\"\" \n               style=\"width: 100%; height: 100px; font-size: 14px; margin-top: 0px;\">\n        Config SAVE\n    </md-button>\n</div>","storeOutMessages":false,"fwdInMessages":false,"resendOnRefresh":true,"templateScope":"local","className":"","x":610,"y":880,"wires":[["4d89bf95b09676fe"]]},{"id":"89dcc8376af722f1","type":"function","z":"bb58b085db8ab888","g":"6167eebedbeaff5b","name":"visible button","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 27-09-2024, 19:21\n// Revised          : 28-10-2024, 20:05\n// Version          : 1.01\n// Target Platform  : Node-RED\n//\n//*****************************************************************************\n// Load Config Function\nconst debug = false;  // Set true for debugging\n\n//pokud hodnota neexistuje tak je restart NODERED a nacitam default.\nlet visibleButtonIO = global.get(\"visibleButtonIO\");\n\nif (typeof visibleButtonIO === 'undefined' || visibleButtonIO === null) {\n    visibleButtonIO = false;  // Nastavení výchozí hodnoty na false\n}\n\n//visibleButtonIO = !visibleButtonIO;\nmsg.payload = {visibleButtonIO};\nglobal.set(\"Firts_START\", 0); \nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":430,"y":880,"wires":[["49890a31476e6591"]]},{"id":"949a6897c12465b1","type":"debug","z":"bb58b085db8ab888","g":"9d90eeb1c87e776f","name":"debug 52","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"live_feed","targetType":"msg","statusVal":"payload","statusType":"auto","x":760,"y":480,"wires":[]},{"id":"3f0c1a7c2342a3cf","type":"inject","z":"bb58b085db8ab888","name":"visibleButtonIO","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":"0.1","topic":"","payload":"visibleButtonIO","payloadType":"str","x":380,"y":740,"wires":[["f2def9e44307bc0d"]]},{"id":"f2def9e44307bc0d","type":"function","z":"bb58b085db8ab888","name":"delete visibleButtonIO","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 27-09-2024, 19:21\n// Revised          : 27-09-2024, 20:34\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n//*****************************************************************************\n// Load Config Function\nconst debug = false;  // Set true for debugging\n\nglobal.set(\"visibleButtonIO\", null);  // Nebo null, pokud chceš vymazat hodnotu","outputs":0,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":600,"y":740,"wires":[]},{"id":"d6596fea5b0154cc","type":"link out","z":"bb58b085db8ab888","g":"6167eebedbeaff5b","name":"Refresh_IO_Buttons","mode":"link","links":["b9f0a0039108e457","f73b91521a6385db"],"x":995,"y":900,"wires":[]},{"id":"b9f0a0039108e457","type":"link in","z":"bb58b085db8ab888","name":"Refresh_IO_Buttons","links":["d6596fea5b0154cc"],"x":95,"y":740,"wires":[["97613c9b3c258e1c","89dcc8376af722f1"]]},{"id":"6700f2e72dbb7b1c","type":"link out","z":"bb58b085db8ab888","name":"Inject","mode":"link","links":["dc4e460bf0a4f8c6","245b64662dda2b2e","224c7eb93b69749a","c78ec1d681859256"],"x":215,"y":540,"wires":[]},{"id":"dc4e460bf0a4f8c6","type":"link in","z":"bb58b085db8ab888","g":"9d90eeb1c87e776f","name":"Inject","links":["6700f2e72dbb7b1c"],"x":1245,"y":540,"wires":[["e5706dfefece2626"]]},{"id":"245b64662dda2b2e","type":"link in","z":"bb58b085db8ab888","g":"9d90eeb1c87e776f","name":"Inject","links":["6700f2e72dbb7b1c"],"x":615,"y":540,"wires":[["65d3135f908c531a"]]},{"id":"f73b91521a6385db","type":"link in","z":"bb58b085db8ab888","g":"9d90eeb1c87e776f","name":"Refresh_IO_Buttons","links":["d6596fea5b0154cc"],"x":1245,"y":500,"wires":[["e5706dfefece2626"]]},{"id":"224c7eb93b69749a","type":"link in","z":"bb58b085db8ab888","g":"9d90eeb1c87e776f","name":"Inject","links":["6700f2e72dbb7b1c"],"x":305,"y":580,"wires":[["97613c9b3c258e1c"]]},{"id":"c78ec1d681859256","type":"link in","z":"bb58b085db8ab888","g":"6167eebedbeaff5b","name":"Inject","links":["6700f2e72dbb7b1c"],"x":295,"y":880,"wires":[["89dcc8376af722f1"]]},{"id":"e1b53bada083922d","type":"catch","z":"bb58b085db8ab888","g":"6167eebedbeaff5b","name":"Delete","scope":["b6c3be5632678b31"],"uncaught":false,"x":810,"y":1020,"wires":[["c5a5627bf4f1e06b"]]},{"id":"c5a5627bf4f1e06b","type":"function","z":"bb58b085db8ab888","g":"6167eebedbeaff5b","name":"Error_Message","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 20-07-2024, 17:01\n// Revised          : 08-09-2024, 18:14\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\nmsg.highlight = 'red';\nmsg.timeout = \"20\";\n\n// Send just a string instead of the whole object\nmsg.topic = \"UPOZORNĚNÍ: Načtěte manuálně defaultní konfiguraci pomocí tlačítka: DEFAULT LOAD\";  // Or any other specific text\nmsg.payload = \"Konfigurace je už smazaná!\";  // Or any other specific text\n\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":980,"y":1020,"wires":[["0f1187363309607e"]]},{"id":"0f1187363309607e","type":"link out","z":"bb58b085db8ab888","g":"6167eebedbeaff5b","name":"mesage_error","mode":"link","links":["2584e24c1a963979"],"x":1115,"y":1020,"wires":[]},{"id":"bb702d415d4ba2c8","type":"function","z":"bb58b085db8ab888","g":"8384064784376389","name":"Check SN","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 28-09-2024, 16:23\n// Revised          : 28-09-2024, 17:43\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\nmsg.payload = { \n    value: msg.payload, \n    'fc': 4, \n    'unitid': 100, \n    'address': 800,\n    'quantity': 1\n}; \nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":580,"y":160,"wires":[["e1380bfc13acf8b5"]]},{"id":"e1380bfc13acf8b5","type":"modbus-flex-getter","z":"bb58b085db8ab888","g":"8384064784376389","name":"read","showStatusActivities":false,"showErrors":false,"showWarnings":true,"logIOActivities":false,"server":"6c801ec0cc108747","useIOFile":false,"ioFile":"","useIOForPayload":false,"emptyMsgOnFail":false,"keepMsgProperties":false,"delayOnStart":false,"startDelayTime":"","x":710,"y":160,"wires":[["053dc2f13494cc80","6b4ae0211109ae1b"],[]]},{"id":"053dc2f13494cc80","type":"debug","z":"bb58b085db8ab888","g":"8384064784376389","name":"debug 53","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload","statusType":"auto","x":900,"y":100,"wires":[]},{"id":"8597f6fcce2b0db1","type":"inject","z":"bb58b085db8ab888","g":"8384064784376389","name":"","props":[{"p":"payload"}],"repeat":"1","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":410,"y":160,"wires":[["bb702d415d4ba2c8","6b4ae0211109ae1b"]]},{"id":"292fdb2fff2915d6","type":"ui_template","z":"bb58b085db8ab888","g":"8384064784376389","group":"ba1c560b4a2f6b32","name":"Indicators","order":5,"width":1,"height":1,"format":"<div style=\"display: flex; flex-direction: column; gap: 8px; border: 0px solid black; padding-top: 5px; padding-bottom: 5px; background-color: #3c3c3c;\">\n    <div style=\"display: flex; align-items: center; justify-content: space-between; margin-left: 13px;\">\n        <span></span>\n        <div id=\"_tcp_connect-indicator\"\n            style=\"width: 20px; height: 20px; border-radius: 50%; background-color: grey; margin-right: 13px;\">\n        </div>\n    </div>\n</div>\n<script>\n    (function(scope) {\n    function updateIndicator(indicatorId, turnValue) {\n        var indicator = document.getElementById(indicatorId);\n        if (turnValue === 'on') {\n            indicator.style.backgroundColor = '#32cd32'; // Zelená barva\n        } else {\n            indicator.style.backgroundColor = 'grey'; // Šedá barva\n        }\n    }\n\n    scope.$watch('msg.payload', function(msg) {\n        if (msg && msg.indicator && msg.status) {\n            updateIndicator(msg.indicator + '-indicator', msg.status);\n        }\n    });\n})(scope);\n</script>\n","storeOutMessages":true,"fwdInMessages":true,"resendOnRefresh":true,"templateScope":"local","className":"","x":1160,"y":160,"wires":[[]]},{"id":"175fc04163da34f2","type":"link in","z":"bb58b085db8ab888","g":"c9cab4329b815890","name":"RESET","links":["50e7df9e8b3bc878"],"x":505,"y":2380,"wires":[["ac3eae5f9c2d4c13"]]},{"id":"9d99dd7fb3e2e326","type":"debug","z":"bb58b085db8ab888","g":"c9cab4329b815890","name":"Zkoušený soubor","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"sTry_File","targetType":"msg","statusVal":"payload","statusType":"auto","x":1470,"y":2460,"wires":[]},{"id":"0ff5daca17cd0dc9","type":"file in","z":"bb58b085db8ab888","g":"c9cab4329b815890","name":"Check_File_HW","filename":"sTry_File","filenameType":"msg","format":"utf8","chunk":false,"sendError":false,"encoding":"none","allProps":false,"x":1460,"y":2520,"wires":[["8f742dfc35d9560a","88f73868b70e9bca"]]},{"id":"156f341261082473","type":"catch","z":"bb58b085db8ab888","g":"c9cab4329b815890","name":"Check File HW","scope":["0ff5daca17cd0dc9"],"uncaught":false,"x":1440,"y":2620,"wires":[["47b286c8e072a418"]]},{"id":"8f742dfc35d9560a","type":"function","z":"bb58b085db8ab888","g":"c9cab4329b815890","name":"SET Firts_START = 0","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 20-10-2024, 20:37\n// Revised          : 29-10-2024, 20:38\n// Version          : 1.01\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\nglobal.set(\"Firts_START\", 0); \n\n// Debugging\nif (debug) {\n    node.warn(\"Firts_START: \" + global.get (\"Firts_START\"));\n}\n\nreturn null;","outputs":0,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1680,"y":2520,"wires":[]},{"id":"47b286c8e072a418","type":"function","z":"bb58b085db8ab888","g":"c9cab4329b815890","name":"SET MESSAGE","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 20-10-2024, 20:37\n// Revised          : 28-10-2024, 20:38\n// Version          : 1.00\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n    // Nastavit zprávu v případě chyby\n    msg.highlight = 'red';\n    msg.timeout = \"20\";\n    msg.payload = \"Nenašel jsem konfigurační soubory: \";\n\n    return msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1660,"y":2620,"wires":[["5a2e12533b60dd9e"]]},{"id":"5a2e12533b60dd9e","type":"link out","z":"bb58b085db8ab888","g":"c9cab4329b815890","name":"message_W/D","mode":"link","links":["2584e24c1a963979"],"x":1795,"y":2620,"wires":[]},{"id":"88f73868b70e9bca","type":"debug","z":"bb58b085db8ab888","g":"c9cab4329b815890","name":"Zkoušený soubor","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload","statusType":"auto","x":1670,"y":2560,"wires":[]},{"id":"473abe190b6aed3d","type":"exec","z":"bb58b085db8ab888","g":"c9cab4329b815890","command":"ls -ld","addpay":"filename","append":"","useSpawn":"true","timer":"","winHide":false,"oldrc":false,"name":"Kontrola oprávnění","x":990,"y":2520,"wires":[["549ea0b46f611279"],["5e261cfba4264a35"],["556db86f165ec539","3e3dcda2ac7f6796"]]},{"id":"549ea0b46f611279","type":"function","z":"bb58b085db8ab888","g":"c9cab4329b815890","name":"Vyhodnocení práv","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2024\n// Created          : 02-11-2024, 17:39\n// Revised          : 02-11-2024, 17:40\n// Version          : 1.00\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//const filename = global.get(\"filename\");\nconst defaultConfig = global.get(\"defaultConfig\");\nlet msg1 = null;\n\n// Příklad výstupu: \"drwxrwxr-x 2 username group 4096 Oct 27 12:00 /cesta/k/adresari\"\nconst output = msg.payload.trim();\nconst permissions = output.split(\" \")[0];\n\n// Kontrola práv\nconst isReadable = permissions[1] === \"r\";\nconst isWritable = permissions[2] === \"w\";\n\nmsg.payload = {\n    path: msg.filename,\n    readable: isReadable,\n    writable: isWritable,\n    permissions: permissions\n};\nif (isReadable == true || isWritable == isWritable){//do adresaře se da zapisovat\n    msg1 = { sTry_File: msg.filename + defaultConfig };\n    global.set(\"sValid_Patch\", msg.filename);\n\n    return [msg, msg1];\n}\nelse return [msg, null]; // Nejsou prava pro zapis a nebo čtení z dané cesty.\n\n//*************************************************\n// Funkce na odstranění názvu souboru z cesty\nconst removeFilename = (path) => {\n    if (typeof path === \"string\" && path.includes('/')) {\n        return path.substring(0, path.lastIndexOf('/')); // Odstraní vše po posledním '/'\n    }\n    return null;\n};","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1210,"y":2440,"wires":[["8686a94a64543f66"],["9d99dd7fb3e2e326","0ff5daca17cd0dc9"]]},{"id":"5e261cfba4264a35","type":"debug","z":"bb58b085db8ab888","g":"c9cab4329b815890","name":"Chyba příkazu","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":1220,"y":2520,"wires":[]},{"id":"556db86f165ec539","type":"debug","z":"bb58b085db8ab888","g":"c9cab4329b815890","name":"Status příkazu","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"status","statusType":"auto","x":1220,"y":2580,"wires":[]},{"id":"8686a94a64543f66","type":"debug","z":"bb58b085db8ab888","g":"c9cab4329b815890","name":"Výstup práv","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":1450,"y":2400,"wires":[]},{"id":"3e3dcda2ac7f6796","type":"switch","z":"bb58b085db8ab888","g":"c9cab4329b815890","name":"","property":"payload.code","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":550,"y":2540,"wires":[["d5f4a2e7c2e84c7d"]]},{"id":"411b4b59850d6625","type":"function","z":"bb58b085db8ab888","g":"5026d073f890b271","name":"Deposit_Token","func":"//*****************************************************************************\n//\n// File Name        : N/A\n// Title            : N/A\n// Author           : http://www.prochazka.zde.cz -> hacesoft 2025\n// Created          : 09-02-2025, 15:30\n// Revised          : 09-02-2025, 16:02\n// Version          : 1.0\n// Target Platform  : Node-RED\n//\n// This code is distributed under the GNU Public License\n// Všechny informace jsou zahrnuty pod GPL licenci, pokud není explicitně uveden jiný typ licence.\n// Používání těchto stránek a produktů ke komerčním účelům lze jen se souhlasem autora.\n// Všechna práva vyhrazena (c) 1997 - 2024 hacesoft.\n//\n//*****************************************************************************\n// Debugging flag\nconst debug = false;  // Nastavte na true pro zapnutí debug zpráv\n\n//definice globalních funkci\nconst fGetConfigProperty = global.get('getConfigProperty');\nconst fSetConfigProperty = global.get('setConfigProperty');\n\n// Nacte token z msg.payload a sestaví požadavek\nconst deposit_Token = msg.payload.token;\n\n// Debugging\nif (debug) {\n    node.warn(\"deposot_Token: \" + deposit_Token);\n}\nfSetConfigProperty(\"deposit_Token\", deposit_Token); //ulozit data do globalni struktury\nmsg.deposit_Token = deposit_Token;\n\nreturn msg;\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1220,"y":1800,"wires":[["905af2b5c03463e9"]]},{"id":"850ea0a974cb2597","type":"debug","z":"bb58b085db8ab888","g":"5026d073f890b271","name":"debug 1","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload","statusType":"auto","x":1200,"y":1840,"wires":[]},{"id":"50d763df80059e5a","type":"modbus-read","z":"7fbf9eb64b6d1607","name":"NodeMCU","topic":"Node_MCU_ID","showStatusActivities":false,"logIOActivities":false,"showErrors":false,"showWarnings":true,"unitid":"1","dataType":"HoldingRegister","adr":"100","quantity":"46","rate":"1","rateUnit":"s","delayOnStart":false,"startDelayTime":"1","server":"7416fc75df840f30","useIOFile":false,"ioFile":"","useIOForPayload":false,"emptyMsgOnFail":false,"x":120,"y":280,"wires":[["ce5044c042e43608"],["b1cfe91c39faca1e"]],"info":"Postive: battery begin charged. Negative: battery being"},{"id":"b1cfe91c39faca1e","type":"modbus-response","z":"7fbf9eb64b6d1607","name":"","registerShowMax":"50","x":330,"y":340,"wires":[]},{"id":"76660322eaf86f7e","type":"debug","z":"7fbf9eb64b6d1607","name":"NodeMCU","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":490,"y":280,"wires":[]},{"id":"bd9aa9ab404abee9","type":"function","z":"7fbf9eb64b6d1607","name":"dec to hex","func":"// Ověříme, že msg.payload je číslo\nif (!isNaN(msg.payload)) {\n    // Převod na číslo (pro případ, že vstup je string)\n    let decimalNumber = parseInt(msg.payload, 10);\n\n    // Převod na hexadecimální řetězec\n    let hexString = decimalNumber.toString(16).toUpperCase();\n\n    // Doplnění nul na délku 4 znaky\n    hexString = hexString.padStart(4, '0');\n\n    // Přidání prefixu 0x\n    msg.payload = `0x${hexString}`;\n} else {\n    // Pokud není číslo, vrátíme chybu\n    msg.payload = \"Neplatný vstup\";\n}\n\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":310,"y":280,"wires":[["76660322eaf86f7e"]]},{"id":"94dfee9218646e3d","type":"debug","z":"7fbf9eb64b6d1607","name":"NodeMCU","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":610,"y":180,"wires":[]},{"id":"ce5044c042e43608","type":"function","z":"7fbf9eb64b6d1607","name":"pole dec to hex","func":"// Ověříme, že msg.payload je pole\nif (Array.isArray(msg.payload)) {\n    // Zjistíme skutečnou velikost pole (počet platných prvků)\n    let actualSize = msg.payload.length;\n\n    // Převedeme všechna desítková čísla na šestnáctková\n    let hexArray = msg.payload.map(function(num) {\n        if (!isNaN(num)) {\n            // Převod na číslo (pro případ, že vstup je string)\n            let decimalNumber = parseInt(num, 10);\n\n            // Převod na hexadecimální řetězec\n            let hexString = decimalNumber.toString(16).toUpperCase();\n\n            // Doplnění nul na délku 4 znaky\n            hexString = hexString.padStart(4, '0');\n\n            // Přidání prefixu 0x\n            return `0x${hexString}`;\n        } else {\n            // Pokud není číslo, vrátíme chybu\n            return \"Neplatný vstup\";\n        }\n    });\n\n    // Vytvoříme výstupní zprávu\n    let outputMsg = {\n        payload: hexArray,\n        actualSize: actualSize\n    };\n\n    // Pošleme výstupní zprávu dál\n    return outputMsg;\n} else {\n    // Pokud vstup není pole, vrátíme chybu\n    msg.payload = \"Neplatný vstup\";\n    return msg;\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":320,"y":220,"wires":[["94dfee9218646e3d"]]}]